---
title: "Notebook_Data_Analysis_BTS_Sample_Stage1_RR"
author: "Weibiao Liu"
date: "2024-01-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries
```{r}
library(extrafont)
library(ggplot2)
library(rio)
library(countrycode)
library(maps)
library(tidyverse)
library(treemapify)
library(lubridate)
library(MOTE)
library(patchwork)
library(ggrepel) #Used to label the points in the bubble chart
library(grid)
library(cowplot)
library(ggforce) #Picture in Picture
library(boot)
library(bootES)
library(vegan)# Calculate Simpson's diversity index
```

## Import Data
```{r}
df <- read.csv("psa001_ind.csv")
df
```

```{r}
df <- df %>%
  dplyr::mutate(country_map = case_when(
    country == "AFG"~"AF", 
    country == "UAE"~"AE", 
    country == "ALA"~"AX",
    country == "ALB" ~ "AL", 
    country == "DZA" ~ "DZ", 
    country == "ASM" ~ "AS",   
    country == "AND" ~ "AD", 
    country == "AGO" ~ "AO",
    country ==  "AIA" ~ "AI",  
    country == "ATA" ~ "AQ",
    country ==  "ATG" ~ "AG",
    country == "ARG" ~ "AR", 
    country ==  "ARM" ~ "AM", 
    country == "ABW" ~ "AW", 
    country == "AUS" ~ "AU",
    country =="AUT" ~ "AT", 
    country ==  "AZE" ~ "AZ", 
    country == "BHS" ~ "BS", 
    country == "BHR" ~ "BH", 
    country =="BGD" ~"BD", 
    country == "BRB" ~ "BB", 
    country == "BLR" ~ "BY", 
    country == "BEL" ~ "BE", 
    country ==  "BLZ" ~ "BZ", 
    country == "BEN" ~ "BJ",
    country ==  "BMU" ~ "BM", 
    country == "BTN" ~ "BT", 
    country == "BOL" ~ "BO", 
    country == "BES" ~ "BQ",
    country == "BIH" ~ "BA",
    country == "BWA" ~ "BW",  
    country == "BVT" ~ "BV", 
    country == "BRA" ~ "BR",
    country == "IOT" ~ "IO",
    country == "BRN" ~ "BN",  
    country == "BGR" ~ "BG",
    country == "BFA" ~ "BF",
    country == "BDI" ~ "BI",
    country == "CPV" ~ "CV",  
    country == "KHM" ~ "KH",  
    country ==  "CMR" ~ "CM",
    country == "CAN" ~ "CA",  
    country == "CYM" ~ "KY",
    country == "CAF" ~ "CF", 
    country == "TCD" ~ "TD", 
    country == "CHI" ~ "CL", 
    country == "CHN" ~ "CN",
    country == "SUI" ~ "CH",
    country == "CXR" ~ "CX", 
    country == "CCK" ~ "CC",  
    country == "COL" ~ "CO",
    country == "COM" ~ "KM",
    country == "COG" ~ "CG", 
    country == "COD" ~ "CD",  
    country == "COK" ~ "CK", 
    country == "CRI" ~ "CR", 
    country == "CIV" ~ "CI",
    country == "HRV" ~ "HR",
    country == "CUB" ~ "CU", 
    country == "CUW" ~ "CW",
    country == "CYP" ~ "CY",   
    country == "CZE" ~ "CZ",
    country ==  "DNK" ~ "DK", 
    country ==  "DJI" ~ "DJ",
    country == "DMA" ~ "DM",
    country == "DOM" ~ "DO", 
    country == "ECU" ~ "EC",  
    country == "EGY" ~ "EG", 
    country == "SLV" ~ "SV", 
    country == "GNQ" ~ "GQ", 
    country == "ERI" ~ "ER", 
    country == "EST" ~ "EE",
    country == "ESP" ~ "ES",
    country == "ETH" ~ "ET",  
    country == "FLK" ~ "FK", 
    country == "FRO" ~ "FO", 
    country == "FJI" ~ "FJ",  
    country == "FIN" ~ "FI",
    country == "FRA" ~ "FR",  
    country == "GUF" ~ "GF",
    country == "PYF" ~ "PF", 
    country == "ATF" ~ "TF", 
    country ==  "GAB" ~ "GA", 
    country ==  "GER" ~ "DE",
    country ==  "GMB" ~ "GM",
    country ==  "GEO" ~ "GE",
    country ==  "DEU" ~ "DE", 
    country == "GHA" ~ "GH",
    country == "GIB" ~ "GI",
    country ==  "GRC" ~ "GR",
    country ==  "GRE" ~ "GR",
    country == "GRL" ~ "GL", 
    country == "GRD" ~ "GD",
    country == "GLP" ~ "GP",  
    country == "GUM" ~ "GU", 
    country == "GTM" ~ "GT", 
    country == "GGY" ~ "GG",
    country == "UK" ~ "GB",
    country == "GIN" ~ "GN", 
    country == "GNB" ~ "GW",
    country == "GUY" ~ "GY",  
    country == "HTI" ~ "HT", 
    country == "HMD" ~ "HM", 
    country == "VAT" ~ "VA",
    country =="HND" ~ "HN",
    country == "HKG" ~ "HK",  
    country == "HUN" ~ "HU", 
    country == "ISL" ~ "IS",
    country == "IND" ~ "IN",
    country == "IDN" ~ "ID",   
    country == "IRN" ~ "IR",
    country == "IRI" ~ "IR",
    country == "IRQ" ~ "IQ",
    country == "IRL" ~ "IE",  
    country == "IMN" ~ "IM", 
    country == "ISR" ~ "IL",  
    country == "ITA" ~ "IT", 
    country == "JAM" ~ "JM", 
    country == "JPN" ~ "JP",
    country == "JOR" ~ "JO",  
    country == "KAZ" ~ "KZ", 
    country == "KEN" ~ "KE", 
    country ==  "KGZ" ~ "KG",
    country == "KHM" ~ "KH", 
    country == "KIR" ~ "KI",
    country == "KNA" ~ "KN",  
    country ==  "KOR" ~ "KR",
    country == "KWT" ~ "KW", 
    country == "LAO" ~ "LA",  
    country == "LBN" ~ "LB",
    country == "LBR" ~ "LR", 
    country == "LBY" ~ "LY",  
    country == "LCA" ~ "LC", 
    country == "LIE" ~ "LI",
    country == "LKA" ~ "LK",  
    country == "LSO" ~ "LS", 
    country == "LTU" ~ "LT", 
    country == "LUX" ~ "LU",  
    country == "LVA" ~ "LV",
    country == "MAC"~"MO",  
    country == "MAF"~"MF", 
    country == "MAR"~"MA", 
    country == "MCO"~"MC", 
    country =="MDA"~"MD",  
    country == "MDG"~"MG", 
    country == "MDV"~"MV", 
    country == "MEX"~"MX", 
    country == "MHL"~"MH", 
    country == "MKD"~"MK",  
    country == "MLI"~"ML",
    country == "MLT"~"MT",  
    country == "MMR"~"MM", 
    country == "MNE"~"ME", 
    country == "MNG"~"MN",
    country == "MNP"~"MP",  
    country == "MOZ"~"MZ", 
    country == "MRT"~"MR", 
    country == "MSR"~"MS",
    country == "MTQ"~"MQ", 
    country == "MUS"~"MU",  
    country == "MWI"~"MW",
    country == "MYS"~"MY", 
    country == "MAS"~"MY", 
    country == "MYT"~"YT", 
    country == "NAM"~"NA", 
    country == "NCL"~"NC",
    country == "NER"~"NE",  
    country == "NFK"~"NF", 
    country == "NGA"~"NG", 
    country == "NIC"~"NI", 
    country == "NIU"~"NU", 
    country == "NLD"~"NL",
    country == "NED"~"NL",
    country == "NOR"~"NO",
    country == "NPL"~"NP",  
    country == "NRU"~"NR", 
    country == "NZL"~"NZ", 
    country == "OMN"~"OM",
    country == "PAK"~"PK",  
    country == "PAN"~"PA", 
    country == "PCN"~"PN", 
    country == "PER"~"PE", 
    country == "PHL"~"PH", 
    country == "PLW"~"PW",  
    country == "PNG"~"PG",
    country == "POL"~"PL",  
    country == "PRI"~"PR", 
    country == "POR"~"PR",
    country == "PRK"~"KP",
    country == "PRT"~"PT", 
    country == "PRY"~"PY", 
    country ==  "PSE"~"PS",
    country == "PYF"~"PF", 
    country == "QAT"~"QA", 
    country == "REU"~"RE", 
    country == "ROU"~"RO",  
    country == "RUS"~"RU",
    country == "RWA"~"RW",  
    country == "SAU"~"SA", 
    country == "SDN"~"SD", 
    country == "SEN"~"SN",
    country == "SGP"~"SG",  
    country == "SGS"~"GS", 
    country == "SHN"~"SH", 
    country == "SJM"~"SJ", 
    country == "SLB"~"SB", 
    country == "SLE"~"SL",  
    country == "SLV"~"SV",
    country == "SMR"~"SM",  
    country == "SOM"~"SO", 
    country == "SPM"~"PM", 
    country == "SRB"~"RS",
    country == "SSD"~"SS",  
    country == "STP"~"ST", 
    country == "SUR"~"SR", 
    country == "SVK"~"SK", 
    country == "SVN"~"SI", 
    country == "SWE"~"SE",  
    country == "SWZ"~"SZ",
    country == "SXM"~"SX",  
    country == "SYC"~"SC", 
    country == "SYR"~"SY", 
    country == "TCA"~"TC",
    country == "TCD"~"TD",  
    country == "TGO"~"TG", 
    country == "THA"~"TH",
    country == "TAI"~"TH",
    country == "TJK"~"TJ", 
    country == "TKL"~"TK", 
    country == "TKM"~"TM",  
    country == "TLS"~"TL",
    country == "TON"~"TO",  
    country == "TTO"~"TT", 
    country == "TUN"~"TN", 
    country == "TUR"~"TR",
    country == "TUV"~"TV",  
    country == "TWN"~"TW",
    country == "TZA"~"TZ",  
    country == "UGA"~"UG", 
    country == "UKR"~"UA", 
    country == "UMI"~"UM",  
    country == "URY"~"UY",
    country == "USA"~"US",
    country == "PSA"~"US",
    country == "URY"~"UY", 
    country == "VAT"~"VA", 
    country == "VEN"~"VE",
    country == "VGB"~"VG",  
    country == "VIR"~"VI", 
    country == "VNM"~"VN",
    country == "WLF"~"WF", 
    country == "WSM"~"WS",  
    country == "YEM"~"YE",
    country == "MYT"~"YT",
    country == "ZAF"~"ZA", 
     country == "RSA"~"ZA",
    country == "ZMB"~"ZM", 
    country == "ZWE"~"ZW",
    TRUE ~ country ))
```

```{r}
df <- dplyr::select(df, user_id, age,sex,country_map)

df <- dplyr::distinct(df)
df
df_PSA001 <- df %>% 
  dplyr::group_by(country_map) %>% 
  summarise(n = n())

df_PSA001


df_PSA001 <- df_PSA001  %>% dplyr::arrange(-n)

df_PSA001 <- dplyr::mutate(.data = df_PSA001, percentage_sample = n/11481) 
df_PSA001
```


```{r}
wppdata <- read_csv("WPP2022.csv")
wppdata
```

```{r}
wppdata1 <- subset(wppdata, select = c("country_map","continent", "pop"))
wppdata2 <- dplyr::mutate(.data = wppdata1, percentage_pop = pop/7909295.151) 
wppdata2
```


```{r}
wppdata3 <- wppdata2 %>% dplyr::left_join(df_PSA001, by = "country_map")
#Merge data from Taiwan Province with data from mainland China
sum_of_cn <- sum(wppdata3$percentage_pop[wppdata3$country_map %in% c("CN", "TW")])
wppdata3$percentage_pop[wppdata3$country_map %in% c("CN", "TW")] <- sum_of_cn
sum_of_cn
wppdata3$percentage_pop[wppdata3 $country_map == "GL"] <- NA
wppdata3 
```

```{r}
wppdata3$ps2014 <- NA  
wppdata3$ps2014[wppdata3 $continent == "Europe"] <- 0.000216  
wppdata3$ps2014[wppdata3 $country_map == "US"] <- 0.952011  
wppdata3$ps2014[wppdata3 $country_map == "ZA"] <- 0.043042 
wppdata3$ps2014[wppdata3 $country_map == "CH"] <- 0.000354  
wppdata3$ps2014[wppdata3 $country_map == "GB"] <- 0.003164
wppdata3$ps2014[wppdata3 $country_map == "BE"] <- 0.000819 
wppdata3$ps2014[wppdata3 $country_map == "DE"] <- 0.001257 
#wppdata3$ps2014[wppdata3 $country_map == "GL"] <- NA
wppdata3 

PS2014_map <- wppdata3[complete.cases(wppdata3$ps2014), ]
PS2014_map 
```

```{r}  
# maybe try binning
PS2014_map$n_binned <- 
  if_else(PS2014_map$ps2014 >= 0.16, "0.16-1",
  if_else(PS2014_map$ps2014 < 0.16 & PS2014_map$ps2014 >= 0.08, "0.08-0.16" , 
   if_else(PS2014_map$ps2014 < 0.08 & PS2014_map$ps2014 >= 0.04, "0.04-0.08" ,
   
  if_else(PS2014_map$ps2014 < 0.04 & PS2014_map$ps2014 >= 0.02, "0.02-0.04" ,    
  if_else(PS2014_map$ps2014 < 0.02 & PS2014_map$ps2014 >= 0.01, "0.01-0.02" ,
  if_else(PS2014_map$ps2014 < 0.01 & PS2014_map$ps2014 >= 0.005, "0.005-0.01" ,  
  if_else(PS2014_map$ps2014 < 0.005 & PS2014_map$ps2014 >= 0.0025, "0.0025-0.005",
      "0-0.0025"
    )
  )
 )
))))
PS2014_map
```

```{r}
df_PSA001_country <- df_PSA001 %>% dplyr::left_join(wppdata2, by = "country_map")

sum_of_CN_TW <- sum(df_PSA001_country$percentage_sample[df_PSA001_country$country_map == "CN"])

new_row <- data.frame(country_map = "TW", n = NA, percentage_sample = sum_of_CN_TW,  continent = NA, pop = NA, percentage_pop = NA)
df_PSA001_country <- rbind(df_PSA001_country, new_row)
df_PSA001_country
```


```{r}
# create a world map 
world_map <- map_data(map = "world")
world_map$region <- iso.alpha(world_map$region)
world_map <- subset(world_map, region != "AQ")
world_map

world_map_new <- world_map

#Add 180 to the data of column "columnname" and store it in df_New
world_map_new$long <- ifelse(world_map$long >= -180 & world_map_new$long <= -30, world_map$long + 360, world_map_new$long)
world_map_new
max_map <- max(world_map_new$long)
min_map <- min(world_map_new$long)
max_map
min_map
```

```{r}  
# maybe try binning
df_PSA001_country$n_binned <- 
  if_else(df_PSA001_country$percentage_sample >= 0.16, "0.16-1",
  if_else(df_PSA001_country$percentage_sample < 0.16 & df_PSA001_country$percentage_sample >= 0.08, "0.08-0.16" , 
   if_else(df_PSA001_country$percentage_sample < 0.04 & df_PSA001_country$percentage_sample >= 0.08, "0.04-0.08" ,
   
  if_else(df_PSA001_country$percentage_sample < 0.04 & df_PSA001_country$percentage_sample >= 0.02, "0.02-0.04" ,    
  if_else(df_PSA001_country$percentage_sample < 0.02 & df_PSA001_country$percentage_sample >= 0.01, "0.01-0.02" ,
    
  if_else(df_PSA001_country$percentage_sample < 0.01 & df_PSA001_country$percentage_sample >= 0.005, "0.005-0.01" ,                                                         
  if_else(df_PSA001_country$percentage_sample < 0.005 & df_PSA001_country$percentage_sample >= 0.0025, "0.0025-0.005",
      "0-0.0025"
    )
  )
 )
))))
df_PSA001_country
```

```{r}  
# maybe try binning
wppdata3$n_binned <- 
  if_else(wppdata3$percentage_pop >= 0.16, "0.16-1",
  if_else(wppdata3$percentage_pop < 0.16 & wppdata3$percentage_pop >= 0.08, "0.08-0.16" , 
   if_else(wppdata3$percentage_pop < 0.08 & wppdata3$percentage_pop >= 0.04, "0.04-0.08" , 
  if_else(wppdata3$percentage_pop < 0.04 & wppdata3$percentage_pop >= 0.02, "0.02-0.04" , 
   if_else(wppdata3$percentage_pop < 0.02 & wppdata3$percentage_pop >= 0.01, "0.01-0.02" , 
   if_else(wppdata3$percentage_pop < 0.01 & wppdata3$percentage_pop >= 0.005, "0.005-0.01" ,         
  if_else(wppdata3$percentage_pop < 0.005 & wppdata3$percentage_pop >= 0.0025, "0.0025-0.005",
      "0-0.0025"
    )
  )
 )
))))
wppdata3
```

```{r}
# map of PS2014 data 
country_PS2014 <- ggplot2::ggplot(PS2014_map) +
  ggplot2::geom_map(aes(map_id = country_map, fill = n_binned), map = world_map_new) +
 ggplot2:: geom_polygon(data = world_map_new, 
               aes(x = long, y = lat, group = group), 
               colour = 'black', size=0.1, fill = NA) + 
  theme_void() + 
  xlim(c(-30, 329)) + 
  ylim(c(-60, 90)) + 
  scale_fill_manual(name = "Proportion of PS2014",
                    values = c("#CCE5FF","#99CCFF", "#66B2FF","#3399FF","#0080FF" ,"#0066CC","#004C99","#003366"),
                    limits = c("0-0.0025", "0.0025-0.005", "0.005-0.01", "0.01-0.02", "0.02-0.04", "0.04-0.08","0.08-0.16", "0.16-1")) +
ggtitle("Geographical distribution of sample from traditional studies")+
  theme(plot.title = element_text(hjust = 0.5, size = 15),
        legend.text = element_text(size = 10),  
        legend.title = element_text(size = 12),  
        legend.key.size = unit(3, "pt"),  
        legend.key.height = unit(3, "pt"),  
        legend.key.width = unit(15, "pt")  
        )
country_PS2014
```

```{r}
# map of PSA001 data 
country_PSA001 <- ggplot2::ggplot(df_PSA001_country) +
  ggplot2::geom_map(aes(map_id = country_map, fill = n_binned), map = world_map_new) +
  ggplot2::geom_polygon(data = world_map_new, 
               aes(x = long, y = lat, group = group), 
               colour = 'black', size=0.1, fill = NA) + 
  theme_void() + 
   xlim(c(-30, 329)) + 
  ylim(c(-60, 90)) + 
  scale_fill_manual(name = "Proportion of PSA001",
                    values = c("#CCE5FF","#99CCFF", "#66B2FF","#3399FF","#0080FF" ,"#0066CC","#004C99","#003366"),
                    limits = c("0-0.0025", "0.0025-0.005", "0.005-0.01", "0.01-0.02", "0.02-0.04", "0.04-0.08","0.08-0.16", "0.16-1")) +
ggtitle("Geographical distribution of sample from big team science")+
  theme(plot.title = element_text(hjust = 0.5, size = 15),
        legend.text = element_text(size = 10),  
        legend.title = element_text(size = 12),  
        legend.key.size = unit(3, "pt"),  
        legend.key.height = unit(3, "pt"), 
        legend.key.width = unit(15, "pt")  
        )
country_PSA001
```

```{r}

wppdata4 <- wppdata3[complete.cases(wppdata3$percentage_pop), ]
# map of World people data 
country_people <- ggplot2::ggplot(wppdata4) +
  ggplot2::geom_map(aes(map_id = country_map, fill = n_binned), map = world_map_new) +
  ggplot2::geom_polygon(data = world_map_new, 
               aes(x = long, y = lat, group = group), 
               colour = 'black', size=0.1, fill = NA) + 
  theme_void() + 
   xlim(c(-30, 329)) + 
  ylim(c(-60, 90)) + 
  scale_fill_manual(name = "Proportion of people",
                    values = c("#CCE5FF","#99CCFF", "#66B2FF","#3399FF","#0080FF" ,"#0066CC","#004C99","#003366"),
                    limits = c("0-0.0025", "0.0025-0.005", "0.005-0.01", "0.01-0.02", "0.02-0.04", "0.04-0.08","0.08-0.16", "0.16-1")) +
ggtitle("Geographical distribution of world population")+
  theme(plot.title = element_text(hjust = 0.5, size = 15),
        legend.text = element_text(size = 10),  
        legend.title = element_text(size = 12),  
        legend.key.size = unit(3, "pt"),  
        legend.key.height = unit(3, "pt"),  
        legend.key.width = unit(15, "pt")  
        )
country_people
```

```{r}  
# maybe try binning
country_PS2014 + country_PSA001 +country_people +  patchwork::plot_layout(ncol = 1, nrow = 3, 
                                 heights = c(4,4))+
patchwork::plot_annotation(tag_levels = 'A')
ggplot2::ggsave("Geographical_distribution_of_samples.pdf", width = 9, height = 13.5)
```


```{r}
author <- read_csv("author_bts.csv")
author
```

```{r}  
# maybe try binning for bts
author$n_binned_bts <- 
  if_else(author$percentage_author_bts >= 0.16, "0.16-1",

  
  if_else(author$percentage_author_bts < 0.16 & author$percentage_author_bts >= 0.08, "0.08-0.16" , 
   if_else(author$percentage_author_bts < 0.04 & author$percentage_author_bts >= 0.08, "0.04-0.08" ,
   
  if_else(author$percentage_author_bts < 0.04 & author$percentage_author_bts >= 0.02, "0.02-0.04" ,    
  if_else(author$percentage_author_bts < 0.02 & author$percentage_author_bts >= 0.01, "0.01-0.02" ,
      if_else(author$percentage_author_bts < 0.01 & author$percentage_author_bts >= 0.005, "0.005-0.01" ,
      
  if_else(author$percentage_author_bts < 0.005 & author$percentage_author_bts >= 0.0025, "0.0025-0.005" ,
      "0-0.0025"  
  ))
 )
))))
# maybe try binning for ps2014
author$n_binned_ps2014 <- 
  if_else(author$percentage_author_ps2014 >= 0.16, "0.16-1",
 
  
  if_else(author$percentage_author_ps2014 < 0.16 & author$percentage_author_ps2014 >= 0.08, "0.08-0.16" , 
   if_else(author$percentage_author_ps2014 < 0.04 & author$percentage_author_ps2014 >= 0.08, "0.04-0.08" ,
   
  if_else(author$percentage_author_ps2014 < 0.04 & author$percentage_author_ps2014 >= 0.02, "0.02-0.04" ,
   if_else(author$percentage_author_ps2014 < 0.02 & author$percentage_author_ps2014 >= 0.01, "0.01-0.02" ,
    if_else(author$percentage_author_ps2014 < 0.01 & author$percentage_author_ps2014 >= 0.005, "0.005-0.01" ,        
  if_else(author$percentage_author_ps2014 < 0.005 & author$percentage_author_ps2014 >= 0.0025, "0.0025-0.005" ,
      "0-0.0025"
  )
 ))
))))
# maybe try binning for leading_author_bts
author$n_binned_leading_bts <- 
  if_else(author$percentage_leading_author_bts >= 0.16, "0.16-1",
 
  
  if_else(author$percentage_leading_author_bts < 0.16 & author$percentage_leading_author_bts >= 0.08, "0.08-0.16" , 
   if_else(author$percentage_leading_author_bts < 0.04 & author$percentage_leading_author_bts >= 0.08, "0.04-0.08" ,
   
  if_else(author$percentage_leading_author_bts < 0.04 & author$percentage_leading_author_bts >= 0.02, "0.02-0.04" ,
   if_else(author$percentage_leading_author_bts < 0.02 & author$percentage_leading_author_bts >= 0.01, "0.01-0.02" ,
    if_else(author$percentage_leading_author_bts < 0.01 & author$percentage_leading_author_bts >= 0.005, "0.005-0.01" ,        
  if_else(author$percentage_leading_author_bts < 0.005 & author$percentage_leading_author_bts >= 0.0025, "0.0025-0.005" ,
      "0-0.0025"
  )
 ))
))))


# maybe try binning for leading_author_ps2014
author$n_binned_leading_ps2014 <- 
  if_else(author$percentage_leading_author_ps2014 >= 0.16, "0.16-1",
 
  
  if_else(author$percentage_leading_author_ps2014 < 0.16 & author$percentage_leading_author_ps2014 >= 0.08, "0.08-0.16" , 
   if_else(author$percentage_leading_author_ps2014 < 0.04 & author$percentage_leading_author_ps2014 >= 0.08, "0.04-0.08" ,
   
  if_else(author$percentage_leading_author_ps2014 < 0.04 & author$percentage_leading_author_ps2014 >= 0.02, "0.02-0.04" ,
   if_else(author$percentage_leading_author_ps2014 < 0.02 & author$percentage_leading_author_ps2014 >= 0.01, "0.01-0.02" ,
    if_else(author$percentage_leading_author_ps2014 < 0.01 & author$percentage_leading_author_ps2014 >= 0.005, "0.005-0.01" ,        
  if_else(author$percentage_leading_author_ps2014 < 0.005 & author$percentage_leading_author_ps2014 >= 0.0025, "0.0025-0.005" ,
      "0-0.0025"
  )
 ))
))))
author

```

```{r}

author_bts_no_na <- author[complete.cases(author$n_binned_bts), ]
author_bts_no_na
# map of PSA001 data 
author_psa001 <- ggplot2::ggplot(author_bts_no_na) +
  ggplot2::geom_map(aes(map_id = country_map, fill = n_binned_bts), map = world_map_new) +
 ggplot2::geom_polygon(data = world_map_new, 
               aes(x = long, y = lat, group = group), 
               colour = 'black', size=0.1, fill = NA) + 
  theme_void() + 
  xlim(c(-30, 329)) + 
  ylim(c(-60, 90)) +
  scale_fill_manual(name = "Proportion of authors",
                    values = c("#CCE5FF","#99CCFF", "#66B2FF","#3399FF","#0080FF" ,"#0066CC","#004C99","#003366"),
                    limits = c("0-0.0025", "0.0025-0.005", "0.005-0.01", "0.01-0.02", "0.02-0.04", "0.04-0.08","0.08-0.16", "0.16-1")) +
ggtitle("Geographical distribution of all authors from big team science")+
  theme(plot.title = element_text(hjust = 0.5, size = 15),
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 12),  
        legend.key.size = unit(3, "pt"),  
        legend.key.height = unit(3, "pt"),  
        legend.key.width = unit(15, "pt") 
        )
author_psa001
```

```{r}
author_ps2022_no_na <- author[complete.cases(author$n_binned_ps2014), ]
author_ps2022_no_na

# map of PS2014 data 
author_ps2014 <- ggplot2::ggplot(author_ps2022_no_na) +
  ggplot2::geom_map(aes(map_id = country_map, fill = n_binned_ps2014), map = world_map_new) +
  ggplot2::geom_polygon(data = world_map_new, 
               aes(x = long, y = lat, group = group), 
               colour = 'black', size=0.1, fill = NA) + 
  ggplot2::theme_void() + 
  xlim(c(-30, 329)) + 
  ylim(c(-60, 90)) +
  ggplot2::scale_fill_manual(name = "Proportion of authors",
                    values = c("#CCE5FF","#99CCFF", "#66B2FF","#3399FF","#0080FF" ,"#0066CC","#004C99","#003366"),
                    limits = c("0-0.0025", "0.0025-0.005", "0.005-0.01", "0.01-0.02", "0.02-0.04", "0.04-0.08","0.08-0.16", "0.16-1")) +
ggplot2::ggtitle("Geographical distribution of all authors from traditional studies")+
  ggplot2::theme(plot.title = element_text(hjust = 0.5, size = 15),
        legend.text = element_text(size = 10),  
        legend.title = element_text(size = 12), 
        legend.key.size = unit(3, "pt"),  
        legend.key.height = unit(3, "pt"), 
        legend.key.width = unit(15, "pt") 
        )
author_ps2014
```

```{r}  
author_ps2014 + author_psa001 + country_people + patchwork::plot_layout(ncol = 1, nrow = 3, heights = c(4, 4)) +
  patchwork::plot_annotation(tag_levels = 'A')  

ggplot2::ggsave("Geographical_distribution_of_authors.pdf", width = 9, height = 13.5)
```

```{r}
author_bts_no_na <- author[complete.cases(author$n_binned_leading_bts), ]
author_bts_no_na

# map of BTS data 
author_bts_leading <- ggplot2::ggplot(author_bts_no_na) +
  ggplot2::geom_map(aes(map_id = country_map, fill = n_binned_leading_bts), map = world_map_new) +
  ggplot2::geom_polygon(data = world_map_new, 
               aes(x = long, y = lat, group = group), 
               colour = 'black', size=0.1, fill = NA) + 
  ggplot2::theme_void() + 
  xlim(c(-30, 329)) + 
  ylim(c(-60, 90)) +
  ggplot2::scale_fill_manual(name = "Proportion of authors",
                    values = c("#CCE5FF","#99CCFF", "#66B2FF","#3399FF","#0080FF" ,"#0066CC","#004C99","#003366"),
                    limits = c("0-0.0025", "0.0025-0.005", "0.005-0.01", "0.01-0.02", "0.02-0.04", "0.04-0.08","0.08-0.16", "0.16-1")) +
ggplot2::ggtitle("Geographical distribution of leading authors from big team science")+
  ggplot2::theme(plot.title = element_text(hjust = 0.5, size = 15),
        legend.text = element_text(size = 10),  
        legend.title = element_text(size = 12), 
        legend.key.size = unit(3, "pt"),  
        legend.key.height = unit(3, "pt"),  
        legend.key.width = unit(15, "pt")  
        )
author_bts_leading




author_ps2022_no_na <- author[complete.cases(author$n_binned_leading_ps2014), ]
author_ps2022_no_na

# map of PS2014 data 
author_ps2014_leading <- ggplot2::ggplot(author_ps2022_no_na) +
  ggplot2::geom_map(aes(map_id = country_map, fill = n_binned_leading_ps2014), map = world_map_new) +
  ggplot2::geom_polygon(data = world_map_new, 
               aes(x = long, y = lat, group = group), 
               colour = 'black', size=0.1, fill = NA) + 
  ggplot2::theme_void() + 
  xlim(c(-30, 329)) + 
  ylim(c(-60, 90)) +
  ggplot2::scale_fill_manual(name = "Proportion of authors",
                    values = c("#CCE5FF","#99CCFF", "#66B2FF","#3399FF","#0080FF" ,"#0066CC","#004C99","#003366"),
                    limits = c("0-0.0025", "0.0025-0.005", "0.005-0.01", "0.01-0.02", "0.02-0.04", "0.04-0.08","0.08-0.16", "0.16-1")) +
ggplot2::ggtitle("Geographical distribution of leading authors from traditional studies")+
  ggplot2::theme(plot.title = element_text(hjust = 0.5, size = 15),
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 12), 
        legend.key.size = unit(3, "pt"),  
        legend.key.height = unit(3, "pt"),  
        legend.key.width = unit(15, "pt")  
        )
author_ps2014_leading
```

```{r}  
author_ps2014_leading + author_bts_leading + country_people + patchwork::plot_layout(ncol = 1, nrow = 3, heights = c(4, 4)) +
  patchwork::plot_annotation(tag_levels = 'A')  

ggplot2::ggsave("Geographical_distribution_of_first_corresponding_authors.pdf", width = 9, height = 13.5)
```

```{r}
wpp_age60 <- read_csv("wpp_age_60.csv")
wpp_age60
```

```{r}
df
new_test_df_filter <- df %>% 
    dplyr::filter(sex != 'no')%>% 
    dplyr::filter(sex != 'na')
new_test_df_filter
```


```{r H2b ageBins plot, message=FALSE, warning=FALSE}
#  <- PSA_Jones_CN
df_PSA001_Age <- df %>%
  dplyr::filter(!is.na(age))%>%
  dplyr::filter(!is.na(sex))%>%  
  dplyr::filter(sex != 'no')%>% 
  dplyr::filter(sex != 'na')%>%
  
  dplyr::mutate(ageBins_pyr = cut(age, 
                                   breaks=c(-Inf, 5, 10, 15, 20, 25, 30, 35, 40, 45,
                                            50, 55,60, Inf), 
                            labels=c("0~4","5~9","10~14", "15~19", "20~24", "25~29", "30~34", "35~39", "40~44",
                                     "45~49","50~54","55~59",">=60")),
                ageBins_pyr = factor(ageBins_pyr, levels = c("0~4","5~9","10~14", "15~19", "20~24", "25~29", 
                                                             "30~34", "35~39", "40~44", "45~49","50~54",
                                                             "55~59",">=60"))) %>%
  dplyr::count(ageBins_pyr, sex) %>%
  dplyr::mutate(Proportion = round(n / sum(n), 4) * 100) %>%
  tidyr::complete(ageBins_pyr, sex, fill=list(Proportion=0)) %>%
  dplyr::mutate(Site = "BTS",
                sex = ifelse(sex == "f" , "female","male"))

df_PSA001_Age
```

#age_simulation
```{r}
df_rad2018 <- read.csv("Rad_2018_suppl.csv") %>%
  dplyr::mutate(male_num = as.numeric(male_num),
                female_num = as.numeric(female_num)) %>%
  dplyr::filter(!is.na(male_num)) %>%
  dplyr::select(1:2, 15:16) %>%
  dplyr::mutate(prop = male_num/(male_num + female_num),
                deviation = prop - 0.5,
                dev_abs = abs(deviation)) %>%
  dplyr::arrange(dev_abs)

effect_size <- bootES::bootES(df_rad2018$dev_abs, plot=TRUE)
df_rad2018
```
## Re-addressing the age bin issue
This time, we tried to conduct a simulation using the logic as we generate age count data from the mean and SD data extracted from papers.

The simulation will use N as 1200 so that it will reveal the sensitivity of the sample size that resulted from sex ratio data.

```{r sensitivity analysis by mean age, eval=FALSE}
## First, we get a reasonable  mean age range by using PSA 001's data
# get the SD of age from PSA001
df_PSA001_CN_SD <- df_PSA001 %>%
  dplyr::filter(Countries == "CHN") %>%
  dplyr::summarise(SD = sd(Age)) %>%
  dplyr::pull(SD)

df_PSA001_CN_M <- df_PSA001 %>%
  dplyr::filter(Countries == "CHN") %>%
  dplyr::summarise(M = mean(Age)) %>%
  dplyr::pull(M)
df_PSA001_CN_SD
df_PSA001_CN_M
```

##Generate simulated data using normal distribution based on age mean and standard deviation
```{r sensitivity analysis by mean age, eval=FALSE}

#df_PS01_M <- c(20.3,68.57,22.66,20.59,18.63,22.2,23.7,19.4,   22,   33)
#df_PS01_SD <- c(1.2,10.87,1.12, 2.06 ,1.39 ,3.8,  4.4, 1.7, 3.53,10.2 )
#N  <-         c(398,  21 , 663,  97  , 97   ,20 ,62,    30 ,  45, 476)

df_PS01_M <- 33

df_PS01_SD <-10.2
Sim_Sens_mult <- function(Mean1, SD1, sampe_N=476){
  
  # Generate data with N = 1200
  # 0~17, 18~25, 26~40, 41~60, 61~
  ageData1 <- round((pnorm(c(5,10,15,20,25,30,35,40,45,50,55,60), mean = Mean1, sd =SD1) * sampe_N))

    # create a dataframe with ageData1 and ageData2:
  sim_age_df <- setNames(data.frame(matrix(ncol = 3, nrow = 13)), c("ageBins", "sim1"))
  sim_age_df$ageBins <- c("<=4", "5~9", "10~14", "15~19","20~24", "25~29", "30~34", "35~39","40~44", "45~49", "50~54", "55~59",">=60")
  sim_age_df$sim1[0:12] <- ageData1
  
  return(sim_age_df)
}


tmp <- Sim_Sens_mult(Mean1=df_PS01_M, 
             
              SD1=df_PS01_SD, 
           
              sampe_N= 476)
tmp
## record results
#sim_age_diff <- seq(0, 2, 0.05)


#rm('sim_MNtest')
#sim_MNtest <- data.frame(matrix(nrow = length(sim_age_diff), ncol = 3))


#sim_MNtest
#write.csv(df1, file = "df010_simulation.csv", row.names = FALSE)
```


```{r}

age_simulation <- read_csv("df_simulation60.csv")
age_simulation
```

```{r}
fig3c <- ggplot(data = wpp_age60, aes(x = ageBins, y = ifelse(sex == "male", -Proportion, Proportion), fill = sex)) +
  geom_col(alpha = 0.5, width = 1) +
  geom_line(data = df_PSA001_Age, aes(x = ageBins_pyr,
                                      y = ifelse(sex == "male", -Proportion, Proportion),
                                      group = sex, color = Site), linetype = "solid", size = 1, inherit.aes = FALSE) +
  geom_line(data = age_simulation, aes(x = ageBins_PS,
                                       y = ifelse(sex == "male", -Proportion, Proportion), group = sex, color = Site), linetype = "solid", size = 1, inherit.aes = FALSE) +
  coord_flip() +
  labs(y = "Proportion", x = "Age bins", color = NULL) +
  annotate("text", label = "italic(Male)", x = 13, y = -10.5, parse = TRUE, size = 8, family = "serif") +
  annotate("text", label = "italic(Female)", x = 13, y = 13.5, parse = TRUE, size = 8, family = "serif") + 
  
  scale_fill_manual(name="World population data", values = c("male" = "#00BFC4", "female" = "#F8766D"))  +
  
scale_color_manual(name="Sample source", values = c("BTS" ="#E41A1C", "traditional studies" =  "#377EB8")) +
  guides(fill = guide_legend(order = 1), color = guide_legend(order = 2)) +  
  theme_classic() + 
  theme(
    legend.position = "right",     
    legend.spacing = unit(1, "cm"),   
    legend.margin = margin(-10, 0.5, 5, 0.5),  
    aspect.ratio = 9 / 8,
    legend.text = element_text(size = 14, family = "serif"),
    legend.title = element_text(size = 16, family = "serif"),
    axis.title = element_text(size = 22, family = "serif"),
    axis.text = element_text(size = 14, family = "serif"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
   
  ) +

  scale_x_discrete(limits = c("0~4", "5~9", "10~14", "15~19", "20~24", "25~29", "30~34", "35~39", "40~44", "45~49", "50~54", "55~59", ">=60"),
                   breaks = c("0~4", "5~9", "10~14", "15~19", "20~24", "25~29", "30~34", "35~39", "40~44", "45~49", "50~54", "55~59", ">=60"))+
  
  ylim(c(-39, 39))  
fig3c
ggsave("Sex_age.pdf", fig3c, device = "pdf", width = 12, height = 9)
```

#sample’ country distributions
```{r}
wppdata <- read_csv("WPP2022.csv")
wppdata
```

```{r}
wppdata1 <- mutate(.data = wppdata, percentage_pop = pop/7909295.151) 
wppdata1
```


```{r}
psadata <- read_csv("psa001_ind.csv")
psadata
```

```{r}
psa1 <- psadata %>%
count(country)
psa1
```

```{r}
psa2 <- mutate(.data = psa1, n1 = n/120) 
psa2
```

```{r}
psa3 <- mutate(.data = psa2, percentage_n = n1/11484) 
psa3
```

```{r}
uniondata <- wppdata1 %>% left_join(psa3, by = "country")

uniondata <- uniondata %>%mutate(Country_groups =                                    case_when(Country_groups == "Developed Country"~"Developed country", TRUE ~ Country_groups))

uniondata$percentage_n[is.na(uniondata$percentage_n)] <- 0
uniondata
```

```{r}

uniondata$ps2014 <- NA  
uniondata$ps2014[uniondata$continent == "Europe"] <- 0.000216  
uniondata$ps2014[uniondata$country_map == "US"] <- 0.952011  
uniondata$ps2014[uniondata$country_map == "ZA"] <- 0.043042
uniondata$ps2014[uniondata$country_map == "CH"] <- 0.000354  
uniondata$ps2014[uniondata$country_map == "GB"] <- 0.003164
uniondata$ps2014[uniondata$country_map == "BE"] <- 0.000819
uniondata$ps2014[uniondata$country_map == "DE"] <- 0.001257 
uniondata
```


```{r}

pp1 <- 
ggplot(data = uniondata, aes(x = percentage_pop, y = percentage_n, color = Country_groups)) +
   geom_point(stat = "identity", position = "identity", size = 9) +
  geom_rect(aes(xmin=0, xmax=0.04, ymin=0, ymax=0.04), fill= NA,color="grey80", size = 1)+
  geom_text_repel(data = uniondata, aes(label = country_map), max.overlaps=3,label.padding=1,
                  segment.color = NA, family = "sans", size = 9, color = "black") +
  xlab("Proportion of population") +
  ylab("Proportion of sample from BTS") +

 scale_color_manual(name = "Country groups",
    values = c("#F8766D","#00BA38","#619CFF"),
                    breaks = c("Developed country", "Developing country", "Least developed country"),
                    labels = c("Developed country", "Developing country", "Least developed country")) +

  geom_segment(aes(x = 0, y = 0, xend = 0.095, yend = 0.095),color = "black",size = 0.5,linetype = "dashed") +
 
  geom_segment(aes(x = 0, y = 0.04, xend = 0.066, yend = 0.25),color = "grey80",size = 1,linetype = "dashed")+
  geom_segment(aes(x = 0.04, y = 0, xend = 0.23, yend = 0.095),color = "grey80",size = 1,linetype = "dashed")+

  theme(
        legend.position = "bottom",
        legend.key.size = unit(0.5, "cm"),
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 20),
        axis.text = element_text(size = 26),
        axis.title = element_text(size = 30),
        panel.background = element_rect(fill = "white"), 
        axis.line = element_line(color = "black"),
         
        aspect.ratio = 1   ) +
  xlim(c(0, 0.25)) + 
  ylim(c(0, 0.25))  


zoom_data <- uniondata %>%
  filter(between(percentage_n, 0, 0.04))%>%
  arrange(percentage_n) %>%
  mutate(idx = row_number())

zoom_plt <- zoom_data %>%
  ggplot( aes(x = percentage_pop, y = percentage_n, color = Country_groups)) +
  geom_point(stat = "identity", position = "identity", size = 9)+ 

  geom_text_repel(data = uniondata, aes(label = country_map), max.overlaps=3,label.padding=1,
                  segment.color = NA, family = "sans", size = 9, color = "black") +
  geom_abline(slope = 1, intercept = 0, size = 0.5,linetype = "dashed", color = "black") +
  scale_y_continuous(limits = c(0, 0.04)) +
  scale_x_continuous(limits = c(0, 0.04))+

  theme_void()+
  theme(plot.background = element_rect(fill = NA, color = "grey80", size = 2),
        legend.position = "none",
        legend.key.size = unit(0.5, "cm"),
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(size = 16),
        axis.title.y = element_text(size = 30),
        axis.text.x = element_text(size = 24),
        axis.text.y = element_text(size = 24),
        aspect.ratio = 1) +
  xlab(" ") +
  ylab(" ") 
zoom_plt


pp2 <- pp1 + inset_element(zoom_plt, 0.3, 0.4, 0.9, 1)+ 
  plot_annotation(theme=theme(
      plot.title = element_text( size = 12, color = "black", hjust = 0.5, margin = margin(5,0,10,0)), ))
  

pp2

  ggsave(filename = "PSA_Population_percentage_by_Country_enlarge.pdf", plot = pp2,  dpi = 300)
```

```{r}

pp3 <- 
ggplot(data = uniondata, aes(x = percentage_pop, y = ps2014, color = Country_groups)) +
   geom_point(stat = "identity", position = "identity", size = 9) +
  geom_rect(aes(xmin=0, xmax=0.045, ymin=0, ymax=0.045), fill= NA,color="grey80", size = 1)+
  geom_text_repel(data = uniondata, aes(label = country_map), max.overlaps=3,label.padding=1,
                  segment.color = NA, family = "sans", size = 9, color = "black") +
  xlab("Proportion of population") +
  ylab("Proportion of sample from traditional studies") +

 scale_color_manual(name = "Country groups",
    values = c("#F8766D","#00BA38","#619CFF"),
                    breaks = c("Developed country", "Developing country", "Least developed country"),
                    labels = c("Developed country", "Developing country", "Least developed country")) +

  geom_segment(aes(x = 0, y = 0, xend = 0.38, yend = 0.38),color = "black",size = 0.5,linetype = "dashed") +
  
  geom_segment(aes(x = 0, y = 0.045, xend = 0.27, yend = 1),color = "grey80",size = 1,linetype = "dashed")+
  geom_segment(aes(x = 0.045, y = 0, xend = 0.93, yend = 0.39),color = "grey80",size = 1,linetype = "dashed")+

  theme(
        legend.position = "bottom",
        legend.key.size = unit(0.5, "cm"),
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 20),
        axis.text = element_text(size = 26),
        axis.title = element_text(size = 30),
        panel.background = element_rect(fill = "white"),
        axis.line = element_line(color = "black"),
         
        aspect.ratio = 1 ) +
  
  xlim(c(0, 1)) +
  ylim(c(0, 1))  


zoom_data1 <- uniondata %>%
  filter(between(ps2014, 0, 0.05))%>%
  arrange(ps2014) %>%
  mutate(idx = row_number())

zoom_plt1 <- zoom_data1 %>%
  ggplot( aes(x = percentage_pop, y = ps2014, color = Country_groups)) +
  geom_point(stat = "identity", position = "identity", size = 9)+ 
  
  geom_text_repel(data = uniondata, aes(label = country_map), max.overlaps=10,label.padding=1,
                  segment.color = NA, family = "sans", size = 9, color = "black") +
  geom_abline(slope = 1, intercept = 0, size = 0.5,linetype = "dashed", color = "black") +
  scale_y_continuous(limits = c(0, 0.045)) +
  scale_x_continuous(limits = c(0, 0.045))+
  
  theme_void()+
 scale_color_manual(name = "Country groups",
    values = c("#F8766D","#00BA38","#619CFF"),
                    breaks = c("Developed country", "Developing country", "Least developed country"),
                    labels = c("Developed country", "Developing country", "Least developed country")) +
   theme(plot.background = element_rect(fill = NA, color = "grey80", size = 2),
        legend.position = "none",
        legend.key.size = unit(0.5, "cm"),
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(size = 16),
        axis.title.y = element_text(size = 30),
        axis.text.x = element_text(size = 24),
        axis.text.y = element_text(size = 24),
        aspect.ratio = 1) +
  xlab(" ") +
  ylab(" ") 

zoom_plt1


pp4 <- pp3 + inset_element(zoom_plt1, 0.3, 0.4, 0.9, 1)+ 
  plot_annotation(theme=theme(
      plot.title = element_text( size = 12, color = "black", hjust = 0.5, margin = margin(5,0,10,0)), ))
pp4

  ggsave(filename = "PS2014_&_World_Population_by_Country_enlarge.pdf", plot = pp4,  dpi = 300)
```

```{r}  
# 将两个图形横向左右排列
combined_plot_people <-   pp4 + pp2+
  plot_layout(ncol = 2) + # 设置两列布局
plot_annotation(tag_levels = list(c('A', '','B', '')), theme=theme(plot.tag = element_text(size = 10)))

combined_plot_people
# Save the plot as a pdf image
ggsave(filename = "people_analyses.pdf", plot = combined_plot_people, device = "pdf", width = 24, height = 12)
```


##Calculate Simpson's diversity index
```{r}
author_BTS_1 <- read_csv("author_BTS.csv")
author_BTS <- filter(author_BTS_1, country_map != "TW")
author_BTS[author_BTS == ""] <- NA

author_bts_clean <-          
  author_BTS$author_bts[!is.na(author_BTS$author_bts)]

author_ps2014_clean <- 
  author_BTS$author_ps2014[!is.na(author_BTS$author_ps2014)]

leading_author_ps2014_clean <- 
  author_BTS$leading_author_ps2014[!is.na(author_BTS$leading_author_ps2014)]

leading_author_bts_clean <- 
  author_BTS$leading_author_bts[!is.na(author_BTS$leading_author_bts)]

author_BTS
author_bts_clean
author_ps2014_clean
leading_author_ps2014_clean
leading_author_bts_clean
```

```{r}
α_bts <- vegan::diversity(author_bts_clean, index = "simpson")
α_ps2014 <- vegan::diversity(author_ps2014_clean, index = "simpson")
α_wpd <- vegan::diversity(author_BTS$wpd, index = "simpson")

α_ps2014_leading <- vegan::diversity(leading_author_ps2014_clean, index = "simpson")
α_bts_leading <- vegan::diversity(leading_author_bts_clean, index = "simpson")

α_ps2014
α_bts
α_wpd

α_ps2014_leading
α_bts_leading
```

##Diversity t-test
#The diversity t-test is similar to the independent sample t-test, and the difference from the general independent sample t-test lies in the way variance is calculated
#Firstly, calculate the variance of Simpson's diversity. The variance of diversity t-test is as follows:
$$Var D=\frac{4N\left(N-1\right)\left(N-2\right)\sum p_{i}^{3}+2N\left ( N-1 \right)\sum p_{i}^{2} -2N\left(N-1\right)\left(2N-3\right)\left(\sum p_{i}^{2}\right )^{2}}{N^{2}\left(N-1\right)^{2}}$$ 
#Secondly, calculate the t-test for independent samples t_value, df, p_value
```{r}
Var_D <- function(n) {
  return((4 * sum(n) * (sum(n) - 1) * (sum(n) - 2) * sum((n / sum(n))^3) +
           2 *sum(n) * (sum(n)- 1) * sum((n / sum(n))^2) -
           2 *sum(n) * (sum(n)- 1) * (2 *sum(n) - 3) * sum((n /sum(n))^2) * sum((n /sum(n))^2)) / (sum(n)* sum(n) * (sum(n)- 1) * (sum(n)- 1)))
}


t_value <- function(x1,x2,Var_1,Var_2) {
  return((x1 - x2) / sqrt(Var_1 + Var_2))
}

df <- function(n1,n2,Var_1,Var_2) {
  return((Var_1 + Var_2)^2 / (Var_1^2 / sum(n1) + Var_2^2 / sum(n2)))
}

p_value <- function(t_value,df) {
  return(2 * pt(abs(t_value), df, lower.tail = FALSE))
}

t_value1 <- (α_bts - α_ps2014) / sqrt(Var_bts + Var_ps2014)
df_1 <- (Var_bts + Var_ps2014)^2 / (Var_bts^2 / N1 + Var_ps2014^2 / N2)
p_value1 <- 2 * pt(abs(t_value1), df_1, lower.tail = FALSE)

Var_ps2014<- Var_D(author_ps2014_clean)
Var_bts<- Var_D(author_bts_clean)
Var_wpd<- Var_D(author_BTS$wpd)
Var_ps2014_leading<- Var_D(leading_author_ps2014_clean)
Var_bts_leading<- Var_D(leading_author_bts_clean)

t_value1<- t_value(α_bts,α_ps2014,Var_bts,Var_ps2014)
t_value2<- t_value(α_wpd,α_bts,Var_wpd,Var_bts)
t_value3<- t_value(α_bts_leading,α_ps2014_leading,Var_bts_leading,Var_ps2014_leading)
t_value4<- t_value(α_wpd,α_bts_leading,Var_wpd,Var_bts_leading)

df1<- df(author_bts_clean,author_ps2014_clean,Var_bts,Var_ps2014)
df2<- df(author_BTS$wpd,author_bts_clean,Var_wpd,Var_bts)
df3<- df(leading_author_bts_clean,leading_author_ps2014_clean,Var_bts_leading,Var_ps2014_leading)
df4<- df(author_BTS$wpd,leading_author_bts_clean,Var_wpd,Var_bts_leading)

p_value1<- p_value(t_value1,df1)
p_value2<- p_value(t_value2,df2)
p_value3<- p_value(t_value3,df3)
p_value4<- p_value(t_value4,df4)

t_value1
df1
p_value1

t_value2
p_value2

t_value3
p_value3

t_value4
p_value4
```



```{r}  
bf10_normal <- function(t,
                        n1,
                        n2 = NULL,
                        Var1,
                        Var2,
                        independentSamples = FALSE,
                        prior.mean,
                        prior.variance,
                        rel.tol = .Machine$double.eps^0.25) {
  
  neff <- ifelse(independentSamples, n1 * n2 / (n1 + n2), n1)
  nu <- ifelse(independentSamples, (Var1 + Var2)^2 / (Var1^2 / n1 + Var2^2 / n2), n1 - 1)
  
  mu.delta <- prior.mean
  g <- prior.variance
  numerator <- 1 / sqrt(1 + neff * g) *
    dt(x = t / sqrt(1 + neff * g),
       df = nu,
       ncp = sqrt(neff / (1 + neff * g)) * mu.delta)
  denominator <- dt(x = t, df = nu)
  
  BF10 <- numerator / denominator
  priorAreaSmaller0 <- pnorm(0, mean = prior.mean,
                             sd = sqrt(prior.variance))
  postAreaSmaller0 <- cdf_normal(x = 0, t = t, n1 = n1, n2 = n2,
                                 independentSamples = independentSamples,
                                 prior.mean = prior.mean,
                                 prior.variance = prior.variance,
                                 rel.tol = rel.tol)
  BFmin1 <- postAreaSmaller0 / priorAreaSmaller0
  BFplus1 <- (1 - postAreaSmaller0) / (1 - priorAreaSmaller0)
  BFmin0 <- BFmin1 * BF10
  BFplus0 <- BFplus1 * BF10
  
  return(list(BF10 = BF10, BFplus0 = BFplus0, BFmin0 = BFmin0))
  
}
bf1 <- bf10_normal(t=t_value1,
                   n1=sum(author_bts_clean),
                   n2 =sum(author_ps2014_clean),
                   Var1=Var_bts,
                   Var2=Var_ps2014,
                  independentSamples=TRUE,
                  prior.mean=0, 
                  prior.variance=1,
                  rel.tol = .Machine$double.eps^0.25
                )

bf2 <- bf10_normal(t=t_value2,
                   n1=sum(author_BTS$wpd),
                   n2=sum(author_bts_clean),
                   Var1=Var_wpd,
                   Var2=Var_bts,
                  independentSamples=TRUE,
                  prior.mean=0, 
                  prior.variance=1,
                  rel.tol = .Machine$double.eps^0.25
                )
bf3 <- bf10_normal(t=t_value3,
                   n1=sum(leading_author_bts_clean),
                   n2 =sum(leading_author_ps2014_clean),
                   Var1=Var_bts_leading,
                   Var2=Var_ps2014_leading,
                  independentSamples=TRUE,
                  prior.mean=0, 
                  prior.variance=1,
                  rel.tol = .Machine$double.eps^0.25
                )
bf4 <- bf10_normal(t=t_value4,
                   n1=sum(author_BTS$wpd),
                   n2 =sum(leading_author_bts_clean),
                   Var1=Var_wpd,
                   Var2=Var_bts_leading,
                  independentSamples=TRUE,
                  prior.mean=0, 
                  prior.variance=1,
                  rel.tol = .Machine$double.eps^0.25
                )
bf1$BF10
bf2$BF10
bf3$BF10
bf4$BF10

```


## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

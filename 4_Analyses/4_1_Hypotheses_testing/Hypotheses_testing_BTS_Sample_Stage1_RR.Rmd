---
title: "Hypotheses_testing_BTS_Sample_Stage1_RR"
author: "Weibiao Liu"
date: "2024-01-28"
output: html_document
---

This is an [R Markdown](http://rmarkdown.rstudio.com) file for Hypotheses testing of data analyses in the protocol of a meta research which aims at surveying sample characteristics of big team science in psychology. 

In this script, we will use data from PSA 001 project [Jones et al., 2021, *Nature Human Behavior*](https://doi.org/10.1038/s41562-020-01007-2) and Partial articles published in psychological science in 2014 [Red et al., 2018, *Proceedings of the National Academy of Sciences*](https://doi.org/10.1073/pnas.1721165115) to exemplify the analyses that we are going to use in our this project.

# load libraries.
```{r}

rm(list = ls()) # clear the env

if (!requireNamespace("pacman", quietly = TRUE)) {
  install.packages("pacman") }   # 如果未安装，则安装包

# import packages
pacman::p_load("tidyverse", 
               "extrafont",
               "rio",
               "countrycode",
               "maps",
               "treemapify",
               "lubridate",
               "MOTE",
               "patchwork",
               "ggrepel",
               "grid",
               "ggforce",
               "boot",
               "bootES",
               "vegan")

# library(extrafont)
# # library(ggplot2)
# library(rio)
# library(countrycode)
# library(maps)
# # library(tidyverse)
# library(treemapify)
# library(lubridate)
# library(MOTE)
# library(patchwork)
# library(ggrepel) # Used to label the points in the bubble chart
# library(grid)
# library(cowplot)
# library(ggforce) # Picture in Picture
# library(boot)
# library(bootES)
# library(vegan)  # Calculate Simpson's diversity index
```

# Preprocessing
```{r}
df <- read.csv("psa001_ind.csv")
```

```{r}
# hcp: need to find a better way for converting country code
df <- df %>%
  dplyr::mutate(country_map = case_when(
    country == "AFG" ~ "AF", 
    country == "UAE" ~ "AE", 
    country == "ALA" ~ "AX",
    country == "ALB" ~ "AL", 
    country == "DZA" ~ "DZ", 
    country == "ASM" ~ "AS",   
    country == "AND" ~ "AD", 
    country == "AGO" ~ "AO",
    country == "AIA" ~ "AI",  
    country == "ATA" ~ "AQ",
    country == "ATG" ~ "AG",
    country == "ARG" ~ "AR", 
    country == "ARM" ~ "AM", 
    country == "ABW" ~ "AW", 
    country == "AUS" ~ "AU",
    country == "AUT" ~ "AT", 
    country == "AZE" ~ "AZ", 
    country == "BHS" ~ "BS", 
    country == "BHR" ~ "BH", 
    country == "BGD" ~ "BD", 
    country == "BRB" ~ "BB", 
    country == "BLR" ~ "BY", 
    country == "BEL" ~ "BE", 
    country == "BLZ" ~ "BZ", 
    country == "BEN" ~ "BJ",
    country == "BMU" ~ "BM", 
    country == "BTN" ~ "BT", 
    country == "BOL" ~ "BO", 
    country == "BES" ~ "BQ",
    country == "BIH" ~ "BA",
    country == "BWA" ~ "BW",  
    country == "BVT" ~ "BV", 
    country == "BRA" ~ "BR",
    country == "IOT" ~ "IO",
    country == "BRN" ~ "BN",  
    country == "BGR" ~ "BG",
    country == "BFA" ~ "BF",
    country == "BDI" ~ "BI",
    country == "CPV" ~ "CV",  
    country == "KHM" ~ "KH",  
    country == "CMR" ~ "CM",
    country == "CAN" ~ "CA",  
    country == "CYM" ~ "KY",
    country == "CAF" ~ "CF", 
    country == "TCD" ~ "TD", 
    country == "CHI" ~ "CL", 
    country == "CHN" ~ "CN",
    country == "SUI" ~ "CH",
    country == "CXR" ~ "CX", 
    country == "CCK" ~ "CC",  
    country == "COL" ~ "CO",
    country == "COM" ~ "KM",
    country == "COG" ~ "CG", 
    country == "COD" ~ "CD",  
    country == "COK" ~ "CK", 
    country == "CRI" ~ "CR", 
    country == "CIV" ~ "CI",
    country == "HRV" ~ "HR",
    country == "CUB" ~ "CU", 
    country == "CUW" ~ "CW",
    country == "CYP" ~ "CY",   
    country == "CZE" ~ "CZ",
    country == "DNK" ~ "DK", 
    country == "DJI" ~ "DJ",
    country == "DMA" ~ "DM",
    country == "DOM" ~ "DO", 
    country == "ECU" ~ "EC",  
    country == "EGY" ~ "EG", 
    country == "SLV" ~ "SV", 
    country == "GNQ" ~ "GQ", 
    country == "ERI" ~ "ER", 
    country == "EST" ~ "EE",
    country == "ESP" ~ "ES",
    country == "ETH" ~ "ET",  
    country == "FLK" ~ "FK", 
    country == "FRO" ~ "FO", 
    country == "FJI" ~ "FJ",  
    country == "FIN" ~ "FI",
    country == "FRA" ~ "FR",  
    country == "GUF" ~ "GF",
    country == "PYF" ~ "PF", 
    country == "ATF" ~ "TF", 
    country == "GAB" ~ "GA", 
    country == "GER" ~ "DE",
    country == "GMB" ~ "GM",
    country == "GEO" ~ "GE",
    country == "DEU" ~ "DE", 
    country == "GHA" ~ "GH",
    country == "GIB" ~ "GI",
    country == "GRC" ~ "GR",
    country == "GRE" ~ "GR",
    country == "GRL" ~ "GL", 
    country == "GRD" ~ "GD",
    country == "GLP" ~ "GP",  
    country == "GUM" ~ "GU", 
    country == "GTM" ~ "GT", 
    country == "GGY" ~ "GG",
    country == "UK" ~ "GB",
    country == "GIN" ~ "GN", 
    country == "GNB" ~ "GW",
    country == "GUY" ~ "GY",  
    country == "HTI" ~ "HT", 
    country == "HMD" ~ "HM", 
    country == "VAT" ~ "VA",
    country == "HND" ~ "HN",
    country == "HKG" ~ "HK",  
    country == "HUN" ~ "HU", 
    country == "ISL" ~ "IS",
    country == "IND" ~ "IN",
    country == "IDN" ~ "ID",   
    country == "IRN" ~ "IR",
    country == "IRI" ~ "IR",
    country == "IRQ" ~ "IQ",
    country == "IRL" ~ "IE",  
    country == "IMN" ~ "IM", 
    country == "ISR" ~ "IL",  
    country == "ITA" ~ "IT", 
    country == "JAM" ~ "JM", 
    country == "JPN" ~ "JP",
    country == "JOR" ~ "JO",  
    country == "KAZ" ~ "KZ", 
    country == "KEN" ~ "KE", 
    country == "KGZ" ~ "KG",
    country == "KHM" ~ "KH", 
    country == "KIR" ~ "KI",
    country == "KNA" ~ "KN",  
    country == "KOR" ~ "KR",
    country == "KWT" ~ "KW", 
    country == "LAO" ~ "LA",  
    country == "LBN" ~ "LB",
    country == "LBR" ~ "LR", 
    country == "LBY" ~ "LY",  
    country == "LCA" ~ "LC", 
    country == "LIE" ~ "LI",
    country == "LKA" ~ "LK",  
    country == "LSO" ~ "LS", 
    country == "LTU" ~ "LT", 
    country == "LUX" ~ "LU",  
    country == "LVA" ~ "LV",
    country == "MAC" ~ "MO",  
    country == "MAF" ~ "MF", 
    country == "MAR" ~ "MA", 
    country == "MCO" ~ "MC", 
    country == "MDA" ~ "MD",  
    country == "MDG" ~ "MG", 
    country == "MDV" ~ "MV", 
    country == "MEX" ~ "MX", 
    country == "MHL" ~ "MH", 
    country == "MKD" ~ "MK",  
    country == "MLI" ~ "ML",
    country == "MLT" ~ "MT",  
    country == "MMR" ~ "MM", 
    country == "MNE" ~ "ME", 
    country == "MNG" ~ "MN",
    country == "MNP" ~ "MP",  
    country == "MOZ" ~ "MZ", 
    country == "MRT" ~ "MR", 
    country == "MSR" ~ "MS",
    country == "MTQ" ~ "MQ", 
    country == "MUS" ~ "MU",  
    country == "MWI" ~ "MW",
    country == "MYS" ~ "MY", 
    country == "MAS" ~ "MY", 
    country == "MYT" ~ "YT", 
    country == "NAM" ~ "NA", 
    country == "NCL" ~ "NC",
    country == "NER" ~ "NE",  
    country == "NFK" ~ "NF", 
    country == "NGA" ~ "NG", 
    country == "NIC" ~ "NI", 
    country == "NIU" ~ "NU", 
    country == "NLD" ~ "NL",
    country == "NED" ~ "NL",
    country == "NOR" ~ "NO",
    country == "NPL" ~ "NP",  
    country == "NRU" ~ "NR", 
    country == "NZL" ~ "NZ", 
    country == "OMN" ~ "OM",
    country == "PAK" ~ "PK",  
    country == "PAN" ~ "PA", 
    country == "PCN" ~ "PN", 
    country == "PER" ~ "PE", 
    country == "PHL" ~ "PH", 
    country == "PLW" ~ "PW",  
    country == "PNG" ~ "PG",
    country == "POL" ~ "PL",  
    country == "PRI" ~ "PR", 
    country == "POR" ~ "PR",
    country == "PRK" ~ "KP",
    country == "PRT" ~ "PT", 
    country == "PRY" ~ "PY", 
    country == "PSE" ~ "PS",
    country == "PYF" ~ "PF", 
    country == "QAT" ~ "QA", 
    country == "REU" ~ "RE", 
    country == "ROU" ~ "RO",  
    country == "RUS" ~ "RU",
    country == "RWA" ~ "RW",  
    country == "SAU" ~ "SA", 
    country == "SDN" ~ "SD", 
    country == "SEN" ~ "SN",
    country == "SGP" ~ "SG",  
    country == "SGS" ~ "GS", 
    country == "SHN" ~ "SH", 
    country == "SJM" ~ "SJ", 
    country == "SLB" ~ "SB", 
    country == "SLE" ~ "SL",  
    country == "SLV" ~ "SV",
    country == "SMR" ~ "SM",  
    country == "SOM" ~ "SO", 
    country == "SPM" ~ "PM", 
    country == "SRB" ~ "RS",
    country == "SSD" ~ "SS",  
    country == "STP" ~ "ST", 
    country == "SUR" ~ "SR", 
    country == "SVK" ~ "SK", 
    country == "SVN" ~ "SI", 
    country == "SWE" ~ "SE",  
    country == "SWZ" ~ "SZ",
    country == "SXM" ~ "SX",  
    country == "SYC" ~ "SC", 
    country == "SYR" ~ "SY", 
    country == "TCA" ~ "TC",
    country == "TCD" ~ "TD",  
    country == "TGO" ~ "TG", 
    country == "THA" ~ "TH",
    country == "TAI" ~ "TH",
    country == "TJK" ~ "TJ", 
    country == "TKL" ~ "TK", 
    country == "TKM" ~ "TM",  
    country == "TLS" ~ "TL",
    country == "TON" ~ "TO",  
    country == "TTO" ~ "TT", 
    country == "TUN" ~ "TN", 
    country == "TUR" ~ "TR",
    country == "TUV" ~ "TV",  
    country == "TWN" ~ "TW",
    country == "TZA" ~ "TZ",  
    country == "UGA" ~ "UG", 
    country == "UKR" ~ "UA", 
    country == "UMI" ~ "UM",  
    country == "URY" ~ "UY",
    country == "USA" ~ "US",
    country == "PSA" ~ "US",
    country == "URY" ~ "UY", 
    country == "VAT" ~ "VA", 
    country == "VEN" ~ "VE",
    country == "VGB" ~ "VG",  
    country == "VIR" ~ "VI", 
    country == "VNM" ~ "VN",
    country == "WLF" ~ "WF", 
    country == "WSM" ~ "WS",  
    country == "YEM" ~ "YE",
    country == "MYT" ~ "YT",
    country == "ZAF" ~ "ZA", 
    country == "RSA" ~ "ZA",
    country == "ZMB" ~ "ZM", 
    country == "ZWE" ~ "ZW",
    TRUE ~ country ))
```

```{r}
df <- dplyr::select(df, user_id, age,sex,country_map)
df <- dplyr::distinct(df)
df_PSA001 <- df %>% 
  dplyr::group_by(country_map) %>% 
  summarise(n = n())

df_PSA001 <- df_PSA001  %>% dplyr::arrange(-n)

df_PSA001 <- dplyr::mutate(.data = df_PSA001, percentage_sample = n/11481) 
df_PSA001
```

```{r}
wppdata <- read_csv("WPP2022.csv")
wppdata1 <- subset(wppdata, select = c("country_map","continent", "pop"))
wppdata2 <- dplyr::mutate(.data = wppdata1, percentage_pop = pop/7909295.151) 
wppdata3 <- wppdata2 %>% dplyr::left_join(df_PSA001, by = "country_map")

# Merge data from Taiwan Province with data from mainland China
sum_of_cn <- sum(wppdata3$percentage_pop[wppdata3$country_map %in% c("CN", "TW")])
wppdata3$percentage_pop[wppdata3$country_map %in% c("CN", "TW")] <- sum_of_cn
sum_of_cn
wppdata3$percentage_pop[wppdata3 $country_map == "GL"] <- NA
wppdata3 
```

```{r}
wppdata3$ps2014 <- NA  
wppdata3$ps2014[wppdata3 $continent == "Europe"] <- 0.000216  
wppdata3$ps2014[wppdata3 $country_map == "US"] <- 0.952011  
wppdata3$ps2014[wppdata3 $country_map == "ZA"] <- 0.043042 
wppdata3$ps2014[wppdata3 $country_map == "CH"] <- 0.000354  
wppdata3$ps2014[wppdata3 $country_map == "GB"] <- 0.003164
wppdata3$ps2014[wppdata3 $country_map == "BE"] <- 0.000819 
wppdata3$ps2014[wppdata3 $country_map == "DE"] <- 0.001257 
#wppdata3$ps2014[wppdata3 $country_map == "GL"] <- NA
wppdata3 

PS2014_map <- wppdata3[complete.cases(wppdata3$ps2014), ]
PS2014_map 
```

```{r}  
# maybe try binning
PS2014_map$n_binned <- 
  if_else(PS2014_map$ps2014 >= 0.16, "0.16-1",
  if_else(PS2014_map$ps2014 < 0.16 & PS2014_map$ps2014 >= 0.08, "0.08-0.16" , 
   if_else(PS2014_map$ps2014 < 0.08 & PS2014_map$ps2014 >= 0.04, "0.04-0.08" ,
  if_else(PS2014_map$ps2014 < 0.04 & PS2014_map$ps2014 >= 0.02, "0.02-0.04" ,    
  if_else(PS2014_map$ps2014 < 0.02 & PS2014_map$ps2014 >= 0.01, "0.01-0.02" ,
  if_else(PS2014_map$ps2014 < 0.01 & PS2014_map$ps2014 >= 0.005, "0.005-0.01" ,  
  if_else(PS2014_map$ps2014 < 0.005 & PS2014_map$ps2014 >= 0.0025, "0.0025-0.005",
      "0-0.0025"
    )
  )
 )
))))
PS2014_map
```

```{r}
df_PSA001_country <- df_PSA001 %>% dplyr::left_join(wppdata2, by = "country_map")

sum_of_CN_TW <- sum(df_PSA001_country$percentage_sample[df_PSA001_country$country_map == "CN"])

new_row <- data.frame(country_map = "TW", n = NA, percentage_sample = sum_of_CN_TW,  continent = NA, pop = NA, percentage_pop = NA)
df_PSA001_country <- rbind(df_PSA001_country, new_row)
df_PSA001_country
```

```{r}
# create a world map 
world_map <- map_data(map = "world")
world_map$region <- maps::iso.alpha(world_map$region)
world_map <- subset(world_map, region != "AQ")
world_map_new <- world_map

#Add 180 to the data of column "columnname" and store it in df_New
world_map_new$long <- ifelse(world_map$long >= -180 & world_map_new$long <= -30, world_map$long + 360, world_map_new$long)

max_map <- max(world_map_new$long)
min_map <- min(world_map_new$long)
max_map
min_map
```

```{r}  
df_PSA001_country$n_binned <- 
  if_else(df_PSA001_country$percentage_sample >= 0.16, "0.16-1",
  if_else(df_PSA001_country$percentage_sample < 0.16 & df_PSA001_country$percentage_sample >= 0.08, "0.08-0.16" , 
   if_else(df_PSA001_country$percentage_sample < 0.04 & df_PSA001_country$percentage_sample >= 0.08, "0.04-0.08" ,
  if_else(df_PSA001_country$percentage_sample < 0.04 & df_PSA001_country$percentage_sample >= 0.02, "0.02-0.04" ,    
  if_else(df_PSA001_country$percentage_sample < 0.02 & df_PSA001_country$percentage_sample >= 0.01, "0.01-0.02" ,
  if_else(df_PSA001_country$percentage_sample < 0.01 & df_PSA001_country$percentage_sample >= 0.005, "0.005-0.01" , 
  if_else(df_PSA001_country$percentage_sample < 0.005 & df_PSA001_country$percentage_sample >= 0.0025, "0.0025-0.005",
      "0-0.0025"
    )))))))
df_PSA001_country
```

```{r}  
wppdata3$n_binned <- 
  if_else(wppdata3$percentage_pop >= 0.16, "0.16-1",
  if_else(wppdata3$percentage_pop < 0.16 & wppdata3$percentage_pop >= 0.08, "0.08-0.16" , 
   if_else(wppdata3$percentage_pop < 0.08 & wppdata3$percentage_pop >= 0.04, "0.04-0.08" , 
  if_else(wppdata3$percentage_pop < 0.04 & wppdata3$percentage_pop >= 0.02, "0.02-0.04" , 
   if_else(wppdata3$percentage_pop < 0.02 & wppdata3$percentage_pop >= 0.01, "0.01-0.02" , 
   if_else(wppdata3$percentage_pop < 0.01 & wppdata3$percentage_pop >= 0.005, "0.005-0.01" ,         
  if_else(wppdata3$percentage_pop < 0.005 & wppdata3$percentage_pop >= 0.0025, "0.0025-0.005",
      "0-0.0025"
    )
  )
 )
))))
wppdata3
```

# Map of Geographical distribution of sample
## PS2014 (sample)
```{r}
country_PS2014 <- ggplot2::ggplot(PS2014_map) +
  ggplot2::geom_map(aes(map_id = country_map, fill = n_binned), map = world_map_new) +
 ggplot2:: geom_polygon(data = world_map_new, 
               aes(x = long, y = lat, group = group), 
               colour = 'black', size=0.1, fill = NA) + 
  theme_void() + 
  xlim(c(-30, 329)) + 
  ylim(c(-60, 90)) + 
  scale_fill_manual(name = "Proportion of PS2014",
                    values = c("#CCE5FF","#99CCFF", "#66B2FF","#3399FF","#0080FF" ,"#0066CC","#004C99","#003366"),
                    limits = c("0-0.0025", "0.0025-0.005", "0.005-0.01", "0.01-0.02", "0.02-0.04", "0.04-0.08","0.08-0.16", "0.16-1")) +
ggtitle("Geographical distribution of sample from traditional psychological studies")+
  theme(plot.title = element_text(hjust = 0.5, size = 15),
        legend.text = element_text(size = 10),  
        legend.title = element_text(size = 12),  
        legend.key.size = unit(3, "pt"),  
        legend.key.height = unit(3, "pt"),  
        legend.key.width = unit(15, "pt")  
        )
country_PS2014
```

## PSA001 (sample)
```{r}
country_PSA001 <- ggplot2::ggplot(df_PSA001_country) +
  ggplot2::geom_map(aes(map_id = country_map, fill = n_binned), map = world_map_new) +
  ggplot2::geom_polygon(data = world_map_new, 
               aes(x = long, y = lat, group = group), 
               colour = 'black', size=0.1, fill = NA) + 
  theme_void() + 
   xlim(c(-30, 329)) + 
  ylim(c(-60, 90)) + 
  scale_fill_manual(name = "Proportion of PSA001",
                    values = c("#CCE5FF","#99CCFF", "#66B2FF","#3399FF","#0080FF" ,"#0066CC","#004C99","#003366"),
                    limits = c("0-0.0025", "0.0025-0.005", "0.005-0.01", "0.01-0.02", "0.02-0.04", "0.04-0.08","0.08-0.16", "0.16-1")) +
ggtitle("Geographical distribution of sample from big team science")+
  theme(plot.title = element_text(hjust = 0.5, size = 15),
        legend.text = element_text(size = 10),  
        legend.title = element_text(size = 12),  
        legend.key.size = unit(3, "pt"),  
        legend.key.height = unit(3, "pt"), 
        legend.key.width = unit(15, "pt")  
        )
country_PSA001
```

## world population data 
```{r}
wppdata4 <- wppdata3[complete.cases(wppdata3$percentage_pop), ]
# map of World people data 
country_people <- ggplot2::ggplot(wppdata4) +
  ggplot2::geom_map(aes(map_id = country_map, fill = n_binned), map = world_map_new) +
  ggplot2::geom_polygon(data = world_map_new, 
               aes(x = long, y = lat, group = group), 
               colour = 'black', size=0.1, fill = NA) + 
  theme_void() + 
   xlim(c(-30, 329)) + 
  ylim(c(-60, 90)) + 
  scale_fill_manual(name = "Proportion of people",
                    values = c("#CCE5FF","#99CCFF", "#66B2FF","#3399FF","#0080FF" ,"#0066CC","#004C99","#003366"),
                    limits = c("0-0.0025", "0.0025-0.005", "0.005-0.01", "0.01-0.02", "0.02-0.04", "0.04-0.08","0.08-0.16", "0.16-1")) +
ggtitle("Geographical distribution of the world population")+
  theme(plot.title = element_text(hjust = 0.5, size = 12),
        legend.text = element_text(size = 10),  
        legend.title = element_text(size = 11),  
        legend.key.size = unit(3, "pt"),  
        legend.key.height = unit(3, "pt"),  
        legend.key.width = unit(15, "pt")  
        )
country_people
```

```{r}  
# maybe try binning
country_PS2014 + country_PSA001 +country_people +  patchwork::plot_layout(ncol = 1, nrow = 3, 
                                 heights = c(4,4))+
patchwork::plot_annotation(tag_levels = 'A')
ggplot2::ggsave("Figure 1.pdf", width = 9, height = 13.5)
```

# Map of Geographical distribution of author
```{r}
author <- read_csv("author_bts.csv")
author
```

```{r}  
# maybe try binning for bts
author$n_binned_bts <- 
  if_else(author$percentage_author_bts >= 0.16, "0.16-1",

  
  if_else(author$percentage_author_bts < 0.16 & author$percentage_author_bts >= 0.08, "0.08-0.16" , 
   if_else(author$percentage_author_bts < 0.04 & author$percentage_author_bts >= 0.08, "0.04-0.08" ,
   
  if_else(author$percentage_author_bts < 0.04 & author$percentage_author_bts >= 0.02, "0.02-0.04" ,    
  if_else(author$percentage_author_bts < 0.02 & author$percentage_author_bts >= 0.01, "0.01-0.02" ,
      if_else(author$percentage_author_bts < 0.01 & author$percentage_author_bts >= 0.005, "0.005-0.01" ,
      
  if_else(author$percentage_author_bts < 0.005 & author$percentage_author_bts >= 0.0025, "0.0025-0.005" ,
      "0-0.0025"  
  ))
 )
))))
# maybe try binning for ps2014
author$n_binned_ps2014 <- 
  if_else(author$percentage_author_ps2014 >= 0.16, "0.16-1",
  if_else(author$percentage_author_ps2014 < 0.16 & author$percentage_author_ps2014 >= 0.08, "0.08-0.16" , 
   if_else(author$percentage_author_ps2014 < 0.04 & author$percentage_author_ps2014 >= 0.08, "0.04-0.08" ,
  if_else(author$percentage_author_ps2014 < 0.04 & author$percentage_author_ps2014 >= 0.02, "0.02-0.04" ,
   if_else(author$percentage_author_ps2014 < 0.02 & author$percentage_author_ps2014 >= 0.01, "0.01-0.02" ,
    if_else(author$percentage_author_ps2014 < 0.01 & author$percentage_author_ps2014 >= 0.005, "0.005-0.01" ,        
  if_else(author$percentage_author_ps2014 < 0.005 & author$percentage_author_ps2014 >= 0.0025, "0.0025-0.005" ,
      "0-0.0025"
  )
 ))
))))
# maybe try binning for leading_author_bts
author$n_binned_leading_bts <- 
  if_else(author$percentage_leading_author_bts >= 0.16, "0.16-1",
  if_else(author$percentage_leading_author_bts < 0.16 & author$percentage_leading_author_bts >= 0.08, "0.08-0.16" , 
   if_else(author$percentage_leading_author_bts < 0.04 & author$percentage_leading_author_bts >= 0.08, "0.04-0.08" ,
  if_else(author$percentage_leading_author_bts < 0.04 & author$percentage_leading_author_bts >= 0.02, "0.02-0.04" ,
   if_else(author$percentage_leading_author_bts < 0.02 & author$percentage_leading_author_bts >= 0.01, "0.01-0.02" ,
    if_else(author$percentage_leading_author_bts < 0.01 & author$percentage_leading_author_bts >= 0.005, "0.005-0.01" ,        
  if_else(author$percentage_leading_author_bts < 0.005 & author$percentage_leading_author_bts >= 0.0025, "0.0025-0.005" ,
      "0-0.0025"
  )
 ))
))))

# maybe try binning for leading_author_ps2014
author$n_binned_leading_ps2014 <- 
  if_else(author$percentage_leading_author_ps2014 >= 0.16, "0.16-1",
  if_else(author$percentage_leading_author_ps2014 < 0.16 & author$percentage_leading_author_ps2014 >= 0.08, "0.08-0.16" , 
   if_else(author$percentage_leading_author_ps2014 < 0.04 & author$percentage_leading_author_ps2014 >= 0.08, "0.04-0.08" ,
  if_else(author$percentage_leading_author_ps2014 < 0.04 & author$percentage_leading_author_ps2014 >= 0.02, "0.02-0.04" ,
   if_else(author$percentage_leading_author_ps2014 < 0.02 & author$percentage_leading_author_ps2014 >= 0.01, "0.01-0.02" ,
    if_else(author$percentage_leading_author_ps2014 < 0.01 & author$percentage_leading_author_ps2014 >= 0.005, "0.005-0.01" ,        
  if_else(author$percentage_leading_author_ps2014 < 0.005 & author$percentage_leading_author_ps2014 >= 0.0025, "0.0025-0.005" ,
      "0-0.0025"
  )
 ))
))))
author
```

## PSA001 (all author)
```{r}

author_bts_no_na <- author[complete.cases(author$n_binned_bts), ]
author_bts_no_na
# map of PSA001 data 
author_psa001 <- ggplot2::ggplot(author_bts_no_na) +
  ggplot2::geom_map(aes(map_id = country_map, fill = n_binned_bts), map = world_map_new) +
 ggplot2::geom_polygon(data = world_map_new, 
               aes(x = long, y = lat, group = group), 
               colour = 'black', size=0.1, fill = NA) + 
  theme_void() + 
  xlim(c(-30, 329)) + 
  ylim(c(-60, 90)) +
  scale_fill_manual(name = "Proportion of authors",
                    values = c("#CCE5FF","#99CCFF", "#66B2FF","#3399FF","#0080FF" ,"#0066CC","#004C99","#003366"),
                    limits = c("0-0.0025", "0.0025-0.005", "0.005-0.01", "0.01-0.02", "0.02-0.04", "0.04-0.08","0.08-0.16", "0.16-1")) +
ggtitle("Geographical distribution of the affiliations of all authors from big team science")+
  theme(plot.title = element_text(hjust = 0.5, size = 12),
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11),  
        legend.key.size = unit(3, "pt"),  
        legend.key.height = unit(3, "pt"),  
        legend.key.width = unit(15, "pt") 
        )
author_psa001
```

## PS2014 (all author)
```{r}
author_ps2022_no_na <- author[complete.cases(author$n_binned_ps2014), ]
author_ps2022_no_na

# map of PS2014 data 
author_ps2014 <- ggplot2::ggplot(author_ps2022_no_na) +
  ggplot2::geom_map(aes(map_id = country_map, fill = n_binned_ps2014), map = world_map_new) +
  ggplot2::geom_polygon(data = world_map_new, 
               aes(x = long, y = lat, group = group), 
               colour = 'black', size=0.1, fill = NA) + 
  ggplot2::theme_void() + 
  xlim(c(-30, 329)) + 
  ylim(c(-60, 90)) +
  ggplot2::scale_fill_manual(name = "Proportion of authors",
                    values = c("#CCE5FF","#99CCFF", "#66B2FF","#3399FF","#0080FF" ,"#0066CC","#004C99","#003366"),
                    limits = c("0-0.0025", "0.0025-0.005", "0.005-0.01", "0.01-0.02", "0.02-0.04", "0.04-0.08","0.08-0.16", "0.16-1")) +
ggplot2::ggtitle("Geographical distribution of the affiliations of all authors from traditional psychological studies")+
  ggplot2::theme(plot.title = element_text(hjust = 0.5, size = 12),
        legend.text = element_text(size = 10),  
        legend.title = element_text(size = 11), 
        legend.key.size = unit(3, "pt"),  
        legend.key.height = unit(3, "pt"), 
        legend.key.width = unit(15, "pt") 
        )
author_ps2014
```

```{r}  
author_ps2014 + author_psa001 + country_people + patchwork::plot_layout(ncol = 1, nrow = 3, heights = c(4, 4)) +
  patchwork::plot_annotation(tag_levels = 'A')  

ggplot2::ggsave("Figure 4.pdf", width = 9, height = 13.5)
```

## PSA001 (leading authors)
```{r}
author_bts_no_na <- author[complete.cases(author$n_binned_leading_bts), ]
author_bts_no_na

# map of BTS data 
author_bts_leading <- ggplot2::ggplot(author_bts_no_na) +
  ggplot2::geom_map(aes(map_id = country_map, fill = n_binned_leading_bts), map = world_map_new) +
  ggplot2::geom_polygon(data = world_map_new, 
               aes(x = long, y = lat, group = group), 
               colour = 'black', size=0.1, fill = NA) + 
  ggplot2::theme_void() + 
  xlim(c(-30, 329)) + 
  ylim(c(-60, 90)) +
  ggplot2::scale_fill_manual(name = "Proportion of authors",
                    values = c("#CCE5FF","#99CCFF", "#66B2FF","#3399FF","#0080FF" ,"#0066CC","#004C99","#003366"),
                    limits = c("0-0.0025", "0.0025-0.005", "0.005-0.01", "0.01-0.02", "0.02-0.04", "0.04-0.08","0.08-0.16", "0.16-1")) +
ggplot2::ggtitle("Geographical distribution of the affiliations of leading authors from big team science")+
  ggplot2::theme(plot.title = element_text(hjust = 0.5, size = 12),
        legend.text = element_text(size = 10),  
        legend.title = element_text(size = 11), 
        legend.key.size = unit(3, "pt"),  
        legend.key.height = unit(3, "pt"),  
        legend.key.width = unit(15, "pt")  
        )
author_bts_leading
```

## PS2014 (leading authors)
```{r}  
author_ps2022_no_na <- author[complete.cases(author$n_binned_leading_ps2014), ]
author_ps2022_no_na

# map of PS2014 data 
author_ps2014_leading <- ggplot2::ggplot(author_ps2022_no_na) +
  ggplot2::geom_map(aes(map_id = country_map, fill = n_binned_leading_ps2014), map = world_map_new) +
  ggplot2::geom_polygon(data = world_map_new, 
               aes(x = long, y = lat, group = group), 
               colour = 'black', size=0.1, fill = NA) + 
  ggplot2::theme_void() + 
  xlim(c(-30, 329)) + 
  ylim(c(-60, 90)) +
  ggplot2::scale_fill_manual(name = "Proportion of authors",
                    values = c("#CCE5FF","#99CCFF", "#66B2FF","#3399FF","#0080FF" ,"#0066CC","#004C99","#003366"),
                    limits = c("0-0.0025", "0.0025-0.005", "0.005-0.01", "0.01-0.02", "0.02-0.04", "0.04-0.08","0.08-0.16", "0.16-1")) +
ggplot2::ggtitle("Geographical distribution of the affiliations of leading authors from traditional psychological studies")+
  ggplot2::theme(plot.title = element_text(hjust = 0.5, size = 12),
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11), 
        legend.key.size = unit(3, "pt"),  
        legend.key.height = unit(3, "pt"),  
        legend.key.width = unit(15, "pt")  
        )
author_ps2014_leading
```

```{r}  
author_ps2014_leading + author_bts_leading + country_people + patchwork::plot_layout(ncol = 1, nrow = 3, heights = c(4, 4)) +
  patchwork::plot_annotation(tag_levels = 'A')  

ggplot2::ggsave("Figure 5.pdf", width = 9, height = 13.5)
```

# Sex & Age
```{r}
wpp_age60 <- read_csv("wpp_age_60.csv")
wpp_age60
```

```{r}
new_test_df_filter <- df %>% 
    dplyr::filter(sex != 'no')%>% 
    dplyr::filter(sex != 'na')
```

```{r H2b ageBins plot, message=FALSE, warning=FALSE}
df_PSA001_Age <- df %>%
  dplyr::filter(!is.na(age))%>%
  dplyr::filter(!is.na(sex))%>%  
  dplyr::filter(sex != 'no')%>% 
  dplyr::filter(sex != 'na')%>%
  
  dplyr::mutate(ageBins_pyr = cut(age, 
                                   breaks=c(-Inf, 5, 10, 15, 20, 25, 30, 35, 40, 45,50, 55,60, Inf), 
                            labels=c("0~4","5~9","10~14", "15~19", "20~24", "25~29", "30~34", "35~39", "40~44", "45~49","50~54","55~59",">=60")),
                ageBins_pyr = factor(ageBins_pyr, levels = c("0~4","5~9","10~14", "15~19", "20~24", "25~29","30~34", "35~39", "40~44", "45~49","50~54","55~59",">=60"))) %>%
  dplyr::count(ageBins_pyr, sex) %>%
  dplyr::mutate(Proportion = round(n / sum(n), 4) * 100) %>%
  tidyr::complete(ageBins_pyr, sex, fill=list(Proportion=0)) %>%
  dplyr::mutate(Site = "BTS",
                sex = ifelse(sex == "f" , "female","male"))
df_PSA001_Age
```

## age_simulation

Generate simulated data using normal distribution based on age mean and standard deviation. Here, I refer to the code used for age simulation during Bayesian polynomial testing by Yue et al. (2023)(https://osf.io/y9hwq/).
```{r define BF for Multinomial test, message=FALSE, warning=FALSE}
BayesMultiNomial <- function(dataset, factor, observed, expected, default_prior = TRUE, prior = NA){
  # datase - the input dataframe
  # factor - column name of the factor,
  # observed - column name of the column contains counts information for the observed,
  # expected - column name of the column contains counts information for the expected,
  # default_prior - whether use the default, defused prior
  # prior - priors defined by users
  
  fact_level <- dataset %>% dplyr::select(all_of(factor)) %>% dplyr::pull()
  observed_data <- dataset %>% dplyr::select(all_of(observed)) %>% dplyr::pull()
  names(observed_data) <- fact_level
  expected_data <- dataset %>% dplyr::select(all_of(expected)) %>% dplyr::pull()
  n_levels <- length(observed_data)
  
  if (default_prior & all(is.na(prior))) {
    prior <- rep(1, n_levels)
  } else{
    if (is.character(prior)){
      prior <- dataset %>% dplyr::select(all_of(prior)) %>% dplyr::pull()
    } else if (is.array(prior)){
      prior <-  prior
    } else if (is.numeric(prior)){
      prior <-  prior
    } else{
      print("prior much a column of the input data or a vector")
    }
  }
  
  alphas <- prior
  counts <- observed_data
  thetas <- expected_data
  
  if(sum(thetas) != 1) {
    thetas <- thetas/sum(thetas)
    }
  
  expected <- setNames(sum(counts)*thetas, names(counts))
  lbeta.xa <- sum(lgamma(alphas + counts)) - lgamma(sum(alphas + counts))
  lbeta.a  <- sum(lgamma(alphas)) - lgamma(sum(alphas))

  if (any(rowSums(cbind(thetas, counts)) == 0)) {
    LogBF10 <- (lbeta.xa-lbeta.a)
  } else {
    LogBF10 <- (lbeta.xa-lbeta.a) + (0 - sum(counts * log(thetas))) 
  }

  BF <- data.frame(LogBF10 = LogBF10,
                   BF10    = exp(LogBF10),
                   BF01    = 1/exp(LogBF10))
  return(list(BF = BF,
              expected = expected))
}
```

```{r}
Sim_Sens_mult <- function(Mean1, diff_age, SD1, SD2, sampe_N) {
  
  # get the mean of difference
  Mean2 <- Mean1 + diff_age

  # Generate data with N
  ageData1 <- round((pnorm(c(5,10,15,20,25,30,35,40,45,50,55,60), mean = Mean1, sd = SD1) * sampe_N))
  ageData2 <- round((pnorm(c(5,10,15,20,25,30,35,40,45,50,55,60), mean = Mean2, sd = SD2) * sampe_N))
  
  # create a dataframe with ageData1 and ageData2:
  sim_age_df <- setNames(data.frame(matrix(ncol = 3, nrow = 13)), c("ageBins", "sim1", "sim2"))
  sim_age_df$ageBins <- c("<=4", "5~9", "10~14", "15~19","20~24", "25~29", "30~34", "35~39","40~44", "45~49", "50~54", "55~59",">=60")
  sim_age_df$sim1[0:12] <- ageData1
  sim_age_df$sim2[0:12] <- ageData2
  
  # create a dataframe with ageData1 and ageData2:
  sim_age_df <- setNames(data.frame(matrix(ncol = 3, nrow = 13)), c("ageBins", "sim1", "sim2"))
  sim_age_df$ageBins <- c("<=4", "5~9", "10~14", "15~19","20~24", "25~29", "30~34", "35~39","40~44", "45~49", "50~54", "55~59",">=60")
  sim_age_df$sim1[0:12] <- ageData1
  sim_age_df$sim2[0:12] <- ageData2
  
  sim_age_df <- sim_age_df %>%
    dplyr::mutate(sim1_new = sim1 - lag(sim1),
                  sim1_new = ifelse(is.na(sim1_new), sim1, sim1_new),
                  sim2_new = sim2 - lag(sim2),
                  sim2_new = ifelse(is.na(sim2_new), sim2, sim2_new),
                  # fill NA and zeros with 1 to avoid the error for Bayesian multinomial test
                  sim1_new = ifelse((is.na(sim1_new) | sim1_new == 0), 1, sim1_new),
                  sim2_new = ifelse((is.na(sim2_new) | sim2_new == 0), 1, sim2_new),
                  ageBins = factor(ageBins, levels = c("<=4", "5~9", "10~14", "15~19","20~24", "25~29", "30~34", "35~39","40~44", "45~49", "50~54", "55~59",">=60"))) %>%
    dplyr::select(ageBins, sim1_new, sim2_new) %>%
    dplyr::rename(obs = sim1_new,
                  expected = sim2_new)
  
  tmp_BF <- BayesMultiNomial(sim_age_df, 
                              factor = 'ageBins', 
                              observed = 'obs', 
                              expected = 'expected')
  
  return(tmp_BF)
}

# Your data
df_PS2014_M <- c(20.3,  22.66, 20.59, 18.63, 22.2, 23.7, 19.4, 22, 33)
df_PS2014_SD <- c(1.2,  1.12, 2.06, 1.39, 3.8, 4.4, 1.7, 3.53, 10.2)
sampe_N <- c(398,  663, 97 , 97 , 20 , 62, 30 , 450, 476)

# Simulate for each set of parameters
results <- lapply(1:length(df_PS2014_M), function(i) {
  Sim_Sens_mult(Mean1 = df_PS2014_M[i], 
                diff_age = 0, 
                SD1 = df_PS2014_SD[i], 
                SD2 = df_PS2014_SD[i], 
                sampe_N = sampe_N[i])
})

# Extract and display results
for (i in seq_along(results)) {
  cat(sprintf("Results for set %d:\n", i))
  print(results[[i]])
  cat("\n")
}
df1 <- data.frame(results)
df1
new_df <- df1[, c(4, 8, 12, 16, 20, 24, 28, 32, 36)]
colnames(new_df) <- c("simulation1", "simulation2", "simulation3","simulation4", "simulation5", "simulation6","simulation7", "simulation8", "simulation9")
new_df
#write.csv(df1, file = "df_simulation.csv", row.names = FALSE)
```

```{r}
age_simulation <- data.frame(
      c(new_df[, 1] * 0.650753769, new_df[, 1] *0.349246231),
      c(new_df[, 2] * 0.549019608, new_df[, 2] *0.450980392),
      c(new_df[, 3] * 0.618556701, new_df[, 3] *0.381443299),
      c(new_df[, 4] * 0.546391753, new_df[, 4] *0.453608247),
      c(new_df[, 5] * 0.55, new_df[, 5] *0.45),
      c(new_df[, 6] * 0.677419355, new_df[, 6] *0.322580645),
      c(new_df[, 7] * 0.666666667, new_df[, 7] *0.333333333),
      c(new_df[, 8] * 0.495555556, new_df[, 8] *0.504444444),
      c(new_df[, 9] * 0.329831933, new_df[, 9] *0.670168067)
      )
colnames(age_simulation) <- c("simulation1", "simulation2", "simulation3","simulation4", "simulation5", "simulation6","simulation7", "simulation8", "simulation9")
custom_order <- c(1, 14, 2, 15, 3, 16, 4,17, 5,18,6,19,7,20,8,21,9,22,10,23,11,24,12,25,13,26)
age_simulation <- age_simulation[custom_order, ]
age_simulation <- data.frame(rowSums(age_simulation[, c("simulation1", "simulation2", "simulation3","simulation4", "simulation5", "simulation6","simulation7", "simulation8", "simulation9")]))
colnames(age_simulation) <- c("age_ps2014")
total_age_ps2014 <- sum(age_simulation$age_ps2014)
age_simulation$Proportion <- age_simulation$age_ps2014*100 / total_age_ps2014

ageBins_PS <- c("0~4", "0~4",   "5~9",   "5~9",   "10~14", "10~14", "15~19", "15~19","20~24", "20~24", "25~29", "25~29", "30~34", "30~34", "35~39", "35~39", "40~44", "40~44", "45~49", "45~49", "50~54", "50~54", "55~59", "55~59",">=60",  ">=60")
sex <- c("female", "male",   "female", "male","female", "male",   "female", "male","female", "male",   "female", "male","female", "male",   "female", "male","female", "male",   "female", "male","female", "male",   "female", "male","female", "male")

age_simulation$ageBins_PS  <- ageBins_PS 
age_simulation$sex <- sex
age_simulation$Site <- "traditional psychological studies"
age_simulation
```

## Sex & Age visualisations
```{r}
fig3c <- ggplot(data = wpp_age60, aes(x = ageBins, y = ifelse(sex == "male", -Proportion, Proportion), fill = sex)) +
  geom_col(alpha = 0.5, width = 1) +
  geom_line(data = df_PSA001_Age, aes(x = ageBins_pyr,
                                      y = ifelse(sex == "male", -Proportion, Proportion),
                                      group = sex, color = Site), linetype = "solid", size = 1, inherit.aes = FALSE) +
  geom_line(data = age_simulation, aes(x = ageBins_PS,
                                       y = ifelse(sex == "male", -Proportion, Proportion), group = sex, color = Site), linetype = "solid", size = 1, inherit.aes = FALSE) +
  coord_flip() +
  labs(y = "Proportion", x = "Age bins", color = NULL) +
  annotate("text", label = "italic(Male)", x = 13, y = -10.5, parse = TRUE, size = 8, family = "serif") +
  annotate("text", label = "italic(Female)", x = 13, y = 13.5, parse = TRUE, size = 8, family = "serif") + 
  
  scale_fill_manual(name="World population data", values = c("male" = "#00BFC4", "female" = "#F8766D"))  +
  
scale_color_manual(name="Sample source", values = c("BTS" ="#E41A1C", "traditional psychological studies" =  "#377EB8")) +
  guides(fill = guide_legend(order = 1), color = guide_legend(order = 2)) +  
  theme_classic() + 
  theme(
    legend.position = "right",     
    legend.spacing = unit(1, "cm"),   
    legend.margin = margin(-10, 0.5, 5, 0.5),  
    aspect.ratio = 9 / 8,
    legend.text = element_text(size = 14, family = "serif"),
    legend.title = element_text(size = 16, family = "serif"),
    axis.title = element_text(size = 22, family = "serif"),
    axis.text = element_text(size = 14, family = "serif"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
  ) +

  scale_x_discrete(limits = c("0~4", "5~9", "10~14", "15~19", "20~24", "25~29", "30~34", "35~39", "40~44", "45~49", "50~54", "55~59", ">=60"),
                   breaks = c("0~4", "5~9", "10~14", "15~19", "20~24", "25~29", "30~34", "35~39", "40~44", "45~49", "50~54", "55~59", ">=60"))+
  
  ylim(c(-39, 39))  
fig3c
ggsave("Figure 2.pdf", fig3c, device = "pdf", width = 12, height = 9)
```

# sample’ country distributions visualisations
```{r}
wppdata <- read_csv("WPP2022.csv")
wppdata1 <- mutate(.data = wppdata, percentage_pop = pop/7909295.151) 
wppdata1 <- wppdata1 %>% filter(!is.na(Country_groups))
wppdata1
wppdata
```

```{r}
psadata <- read_csv("psa001_ind.csv")
psa1 <- psadata %>%
count(country)
psa2 <- mutate(.data = psa1, n1 = n/120) 
psa3 <- mutate(.data = psa2, percentage_n = n1/11484) 
uniondata <- wppdata1 %>% left_join(psa3, by = "country")

uniondata$percentage_n[is.na(uniondata$percentage_n)] <- 0
uniondata$ps2014 <- 0  
uniondata$ps2014[uniondata$continent == "Europe"] <- 0.000216  
uniondata$ps2014[uniondata$country_map == "US"] <- 0.952011  
uniondata$ps2014[uniondata$country_map == "ZA"] <- 0.043042
uniondata$ps2014[uniondata$country_map == "CH"] <- 0.000354  
uniondata$ps2014[uniondata$country_map == "GB"] <- 0.003164
uniondata$ps2014[uniondata$country_map == "BE"] <- 0.000819
uniondata$ps2014[uniondata$country_map == "DE"] <- 0.001257 
```

## PS2014 (sample)
```{r}
pp1 <- 
ggplot(data = uniondata, aes(x = percentage_pop, y = percentage_n, color = Country_groups)) +
   geom_point(stat = "identity", position = "identity", size = 9) +
  geom_rect(aes(xmin=0, xmax=0.04, ymin=0, ymax=0.04), fill= NA,color="grey80", size = 1)+
  geom_text_repel(data = uniondata, aes(label = country_map), max.overlaps=3,label.padding=1,
                  segment.color = NA, family = "sans", size = 9, color = "black") +
  xlab("Proportion of population") +
  ylab("Proportion of sample from BTS") +

 scale_color_manual(name = "Country groups",
    values = c("#F8766D","#00BA38","#619CFF","blue"),
                    breaks = c("High income countries", "Upper middle income country", "Lower middle income country","Lower income country"),
                    labels = c("High income countries", "Upper middle income country", "Lower middle income country","Lower income country"),
    guide = guide_legend(nrow = 2)) +

  geom_segment(aes(x = 0, y = 0, xend = 0.095, yend = 0.095),color = "black",size = 0.5,linetype = "dashed") +
 
  geom_segment(aes(x = 0, y = 0.04, xend = 0.066, yend = 0.25),color = "grey80",size = 1,linetype = "dashed")+
  geom_segment(aes(x = 0.04, y = 0, xend = 0.23, yend = 0.095),color = "grey80",size = 1,linetype = "dashed")+

  theme(
        legend.position = "bottom",
        legend.key.size = unit(0.5, "cm"),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 22),
        axis.text = element_text(size = 24),
        axis.title = element_text(size = 30),
        panel.background = element_rect(fill = "white"), 
        axis.line = element_line(color = "black"),
         
        aspect.ratio = 1   ) +
  xlim(c(0, 0.25)) + 
  ylim(c(0, 0.25))  

zoom_data <- uniondata %>%
  filter(between(percentage_n, 0, 0.04))%>%
  arrange(percentage_n) %>%
  mutate(idx = row_number())

zoom_plt <- zoom_data %>%
  ggplot( aes(x = percentage_pop, y = percentage_n, color = Country_groups)) +
  geom_point(stat = "identity", position = "identity", size = 9)+ 

  geom_text_repel(data = uniondata, aes(label = country_map), max.overlaps=3,label.padding=1,
                  segment.color = NA, family = "sans", size = 9, color = "black") +
  geom_abline(slope = 1, intercept = 0, size = 0.5,linetype = "dashed", color = "black") +
  scale_y_continuous(limits = c(0, 0.04)) +
  scale_x_continuous(limits = c(0, 0.04))+
  scale_color_manual(name = "Country groups",
    values = c("#F8766D","#00BA38","#619CFF","blue"),
                    breaks = c("High income countries", "Upper middle income country", "Lower middle income country","Lower income country"),
                    labels = c("High income countries", "Upper middle income country", "Lower middle income country","Lower income country")) +
  theme_void()+
  theme(plot.background = element_rect(fill = NA, color = "grey80", size = 2),
        legend.position = "none",
        legend.key.size = unit(0.5, "cm"),
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(size = 16),
        axis.title.y = element_text(size = 30),
        axis.text.x = element_text(size = 24),
        axis.text.y = element_text(size = 24),
        aspect.ratio = 1) +
  xlab(" ") +
  ylab(" ") 
zoom_plt

pp2 <- pp1 + inset_element(zoom_plt, 0.3, 0.4, 0.9, 1)+ 
  plot_annotation(theme=theme(
      plot.title = element_text( size = 12, color = "black", hjust = 0.5, margin = margin(5,0,10,0)), ))


  #ggsave(filename = "PSA_Population_percentage_by_Country_enlarge.pdf", plot = pp2,  dpi = 300)
```

## PSA001 (sample)
```{r}
pp3 <- 
ggplot(data = uniondata, aes(x = percentage_pop, y = ps2014, color = Country_groups)) +
   geom_point(stat = "identity", position = "identity", size = 9) +
  geom_rect(aes(xmin=0, xmax=0.045, ymin=0, ymax=0.045), fill= NA,color="grey80", size = 1)+
  geom_text_repel(data = uniondata, aes(label = country_map), max.overlaps=10,label.padding=1,
                  segment.color = NA, family = "sans", size = 9, color = "black") +
  xlab("Proportion of population") +
  ylab("Proportion of sample from traditional psychological studies") +

  scale_color_manual(name = "Country groups",
    values = c("#F8766D","#00BA38","#619CFF","blue"),
                    breaks = c("High income countries", "Upper middle income country", "Lower middle income country","Lower income country"),
                    labels = c("High income countries", "Upper middle income country", "Lower middle income country","Lower income country"),
    guide = guide_legend(nrow = 2)) +

  geom_segment(aes(x = 0, y = 0, xend = 0.38, yend = 0.38),color = "black",size = 0.5,linetype = "dashed") +
  
  geom_segment(aes(x = 0, y = 0.045, xend = 0.27, yend = 1),color = "grey80",size = 1,linetype = "dashed")+
  geom_segment(aes(x = 0.045, y = 0, xend = 0.93, yend = 0.39),color = "grey80",size = 1,linetype = "dashed")+

  theme(
        legend.position = "bottom",
        #legend.key.size = unit(0.5, "cm"),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 22),
        axis.text = element_text(size = 24),
        axis.title = element_text(size = 30),
        panel.background = element_rect(fill = "white"),
        axis.line = element_line(color = "black"),
        aspect.ratio = 1 ) +
  xlim(c(0, 1)) +
  ylim(c(0, 1))  

zoom_data1 <- uniondata %>%
  filter(between(ps2014, 0, 0.05))%>%
  arrange(ps2014) %>%
  mutate(idx = row_number())

zoom_plt1 <- zoom_data1 %>%
  ggplot( aes(x = percentage_pop, y = ps2014, color = Country_groups)) +
  geom_point(stat = "identity", position = "identity", size = 9)+ 
  
  geom_text_repel(data = uniondata, aes(label = country_map), max.overlaps=10,label.padding=1,
                  segment.color = NA, family = "sans", size = 9, color = "black") +
  geom_abline(slope = 1, intercept = 0, size = 0.5,linetype = "dashed", color = "black") +
  scale_y_continuous(limits = c(0, 0.045)) +
  scale_x_continuous(limits = c(0, 0.045))+
  scale_color_manual(name = "Country groups",
    values = c("#F8766D","#00BA38","#619CFF","blue"),
                    breaks = c("High income countries", "Upper middle income country", "Lower middle income country","Lower income country"),
                    labels = c("High income countries", "Upper middle income country", "Lower middle income country","Lower income country")) +
  theme_void()+

   theme(plot.background = element_rect(fill = NA, color = "grey80", size = 2),
        legend.position = "none",
        legend.key.size = unit(0.5, "cm"),
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(size = 16),
        axis.title.y = element_text(size = 30),
        axis.text.x = element_text(size = 24),
        axis.text.y = element_text(size = 24),
        aspect.ratio = 1) +
  xlab(" ") +
  ylab(" ") 

zoom_plt1

pp4 <- pp3 + inset_element(zoom_plt1, 0.3, 0.4, 0.9, 1)+ 
  plot_annotation(theme=theme(
      plot.title = element_text( size = 12, color = "black", hjust = 0.5, margin = margin(5,0,10,0)), ))

  #ggsave(filename = "PS2014_&_World_Population_by_Country_enlarge.pdf", plot = pp4,  dpi = 300)
```

```{r}  
combined_plot_people <-   pp4 + pp2+
  plot_layout(ncol = 2) + 
plot_annotation(tag_levels = list(c('A', '','B', '')), theme=theme(plot.tag = element_text(size = 28)))


# Save the plot as a pdf image
ggsave(filename = "Figure 3.pdf", plot = combined_plot_people, device = "pdf", width = 24, height = 14)
```

# Comparing all or leading authors
```{r}
author_data <- read_csv("author_BTS.csv") %>%
filter(country_map != "TW")
author_data[author_data == ""] <- 0

author_data <- author_data %>%
  group_by(Country_groups) %>%
  summarise(
    author_ps2014 = sum(author_ps2014, na.rm = TRUE),
    author_bts = sum(author_bts, na.rm = TRUE),  
    wpd = sum(wpd, na.rm = TRUE),
    leading_author_bts = sum(leading_author_bts, na.rm = TRUE),
    leading_author_ps2014 = sum(leading_author_ps2014, na.rm = TRUE),
    percentage_author_ps2014_100 = sum(percentage_author_ps2014_100, na.rm = TRUE),
    percentage_author_bts_100 = sum(percentage_author_bts_100, na.rm = TRUE),  
    percentage_wpd_100 = sum(percentage_wpd_100, na.rm = TRUE),
    percentage_leading_author_bts_100 = sum(percentage_leading_author_bts_100, na.rm = TRUE),
    percentage_leading_author_ps2014_100 = sum(percentage_leading_author_ps2014_100, na.rm = TRUE)
  )%>%
  filter(Country_groups != "other")%>%
  mutate(across(everything(), ~ ifelse(. == 0, 0.1e-08, .)))
author_data
```


```{r}
# Define the function for converting chi square values and df to Bayesian factors
froot<-function(x,lambda,thresh,df){
 dchisq(x,df, ncp =lambda)/dchisq(x,df)-thresh
 }
 f1<- function(lambda,thresh,df){
 r<-uniroot(froot,lambda=lambda,thresh=thresh,df=df,c(0.01,1000))$root
 }
 vf1<-Vectorize(f1)
 UMPBT<-function(df, thresh){
 optout<- optimize(vf1,c(0,100),thresh=thresh,df=df)
 z<-optout$minimum
 return(z)
 }

lambda <- UMPBT(df <- 4, thresh <- 10)

# 01 All author: ps2014 vs bts
observed1 <- author_data$percentage_author_ps2014_100
expected1 <- author_data$percentage_author_bts_100
chi_square_result1 <- chisq.test(x = observed1, p = expected1 / sum(expected1))

BF1 <- dchisq(x = chi_square_result1$statistic, df = 4, ncp = lambda) / dchisq(x = chi_square_result1$statistic, df = 4)
log_BF1 <- log(BF1)
log_BF1

# 02 All author: bts vs wpd
observed2 <- author_data$percentage_author_bts_100
expected2 <- author_data$percentage_wpd_100
chi_square_result2 <- chisq.test(x = observed2, p = expected2 / sum(expected2))

BF2 <- dchisq(x = chi_square_result2$statistic, df = 4, ncp = lambda) / dchisq(x = chi_square_result2$statistic, df = 4)
log_BF2 <- log(BF2)
log_BF2

# 03 Leading author: ps2014 vs bts
observed3 <- author_data$percentage_leading_author_ps2014_100
expected3 <- author_data$percentage_leading_author_bts_100
chi_square_result3 <- chisq.test(x = observed3, p = expected3 / sum(expected3))

BF3 <- dchisq(x = chi_square_result3$statistic, df = 4, ncp = lambda) / dchisq(x = chi_square_result3$statistic, df = 4)
log_BF3 <- log(BF3)
log_BF3

# 04 Leading author: bts vs wpd
observed4 <- author_data$percentage_leading_author_bts_100
expected4 <- author_data$percentage_wpd_100

chi_square_result4 <- chisq.test(x = observed4, p = expected4 / sum(expected4))

BF4 <- dchisq(x = chi_square_result4$statistic, df = 4, ncp = lambda) / dchisq(x = chi_square_result4$statistic, df = 4)
log_BF4 <- log(BF4)
log_BF4
```


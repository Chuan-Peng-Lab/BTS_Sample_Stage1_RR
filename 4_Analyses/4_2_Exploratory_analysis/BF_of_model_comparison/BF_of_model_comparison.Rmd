---
title: "BF_of_model_comparison"
output: html_document
date: "2024-09-18"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)        # ggplot, dplyr, %>%, and friends
library(brms)             # Bayesian modeling through Stan
library(marginaleffects)  # Calculate marginal effects for regression models
library(tidybayes)        # Manipulate Stan objects in a tidy way
library(bayesplot) 
library(patchwork)        # Combine ggplot objects
library(ggrepel)          # Automatically position labels
library(scales)           # Format numbers in nice ways
library(collapse) 
library(broom)            # Convert model objects to data frames
library(broom.mixed)      # Convert brms model objects to data frames
library(extraDistr)       # Use extra distributions like dprop()
library(ggdist)           # Special geoms for posterior distributions
library(gghalves)         # Special half geoms
library(ggbeeswarm)       # Special distribution-shaped point jittering
library(modelsummary)     # Create side-by-side regression tables
library(ggthemes)
```

## GDP_per_capita
```{r}
gdpdata <- read_csv("gdpdata.csv")
gdpdata
```

#01 Default prior
```{r}
gdp_model_beta_zi_bts11 <- brms::brm(
   bf(bts| trials(total_bts) ~ 1,
   phi ~ 1,
   zi ~ 1),
  data = gdpdata,
  family = zero_inflated_beta_binomial(),
  chains = 4, iter = 100000, warmup = 50000,
  cores = 2, seed = 1234,
  save_pars = save_pars(all = TRUE),  
  control = list(adapt_delta = 0.99,  max_treedepth=15), 
  backend = "cmdstanr",
  file = "gdp_model_beta_zi_bts11"
)
tidy(gdp_model_beta_zi_bts11, effects = "fixed")
```

```{r}
gdp_model_beta_zi_bts22 <- brms::brm(
bf(bts| trials(total_bts) ~ GDP_per_capita,
phi ~ GDP_per_capita,
zi ~ GDP_per_capita
),
data = gdpdata,
family = zero_inflated_beta_binomial(),
chains = 4, iter = 100000, warmup = 50000,
cores = 24, seed = 1234,
control = list(adapt_delta = 0.99, max_treedepth = 15),
#prior = priors_main,
save_pars = save_pars(all = TRUE), 
backend = "cmdstanr",
file = "gdp_model_beta_zi_bts22"
)
tidy(gdp_model_beta_zi_bts22, effects = "fixed")
```

#Average marginal effects
```{r}
ame_beta_zi_gdp_bts22 <- gdp_model_beta_zi_bts22 %>%
  marginaleffects::avg_comparisons(variables = "GDP_per_capita") %>% 
  marginaleffects::posterior_draws()
ame_beta_zi_gdp_bts22 %>% tidybayes::median_hdi(draw)

ggplot(ame_beta_zi_gdp_bts22, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
#  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

#BF1:Compared to zero
```{r}
result <-  brms::hypothesis(ame_beta_zi_gdp_bts22, "draw>0")
result
#3
```

#BF2:Model Comparison
```{r}
bridge1 <-  brms::bridge_sampler(gdp_model_beta_zi_bts11, maxiter = 400000, start_val = "mean")
bridge2 <-  brms::bridge_sampler(gdp_model_beta_zi_bts22, maxiter = 400000, start_val = "mean")

bf1 <-  brms::bayes_factor(bridge2, bridge1)$bf
bf1
#8.000984e+14
```

#02 Define the prior
```{r}
priors_main1 <- 
  #set_prior("normal(0, 1 )", class = "b") +
  set_prior("normal(-4.5, 3)", class = "Intercept") + 
  
  #set_prior("normal(0, 1 )", class = "b", dpar= "phi") +
  set_prior("normal(10, 2.5)", class = "Intercept", dpar= "phi") + 
  #set_prior("normal(0, 1)", class = "b", dpar= "zi") +
  set_prior("normal(0, 2)", class = "Intercept", dpar= "zi")
```

```{r}
gdp_model_beta_zi_bts1 <- brms::brm(
   bf(bts| trials(total_bts) ~ 1,
   phi ~ 1,
   zi ~ 1),
  data = gdpdata,
  family = zero_inflated_beta_binomial(),
  chains = 4, iter = 100000, warmup = 50000,
  cores = 4, seed = 1234,
  prior = priors_main1,
  save_pars = save_pars(all = TRUE), 
  backend = "cmdstanr",
  file = "gdp_model_beta_zi_bts1"
)
tidy(gdp_model_beta_zi_bts1, effects = "fixed")

```
#Warning: 39568 of 200000 (20.0%) transitions ended with a divergence.See https://mc-stan.org/misc/warnings for details.


```{r}
priors_main2 <- 
  set_prior("normal(0, 1 )", class = "b") +
  set_prior("normal(-4.5, 3)", class = "Intercept") + 
  
  set_prior("normal(0, 1 )", class = "b", dpar= "phi") +
  set_prior("normal(10, 2.5)", class = "Intercept", dpar= "phi") + 
  set_prior("normal(0, 1)", class = "b", dpar= "zi") +
  set_prior("normal(0, 2)", class = "Intercept", dpar= "zi")

```

```{r}
gdp_model_beta_zi_bts2 <- brms::brm(
bf(bts| trials(total_bts) ~ GDP_per_capita,
  phi ~ GDP_per_capita,
  zi ~ GDP_per_capita
  ),
  data = gdpdata,
  family = zero_inflated_beta_binomial(),
  chains = 4, iter = 100000, warmup = 50000,
  cores = 4, seed = 1234,
  control = list(adapt_delta = 0.99, max_treedepth = 10),
  prior = priors_main2,
  save_pars = save_pars(all = TRUE), 
  backend = "cmdstanr",
  file = "gdp_model_beta_zi_bts2"
  )
tidy(gdp_model_beta_zi_bts2, effects = "fixed")
```



#Average marginal effects
```{r}
ame_beta_zi_gdp_bts2 <- gdp_model_beta_zi_bts2 %>%
  marginaleffects::avg_comparisons(variables = "GDP_per_capita") %>% 
  marginaleffects::posterior_draws()
#ame_beta_zi_gdp_bts2 %>% tidybayes::median_hdi(draw)
##Error in quantile.default(dist_y, probs = 1 - .width, names = FALSE) : 
##  missing values and NaN's not allowed if 'na.rm' is FALSE
##这句代码报错，暂未解决，影响了下面的画图
ggplot(ame_beta_zi_gdp_bts2, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
#  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```



#BF1:Compared to zero
```{r}
result <-  brms::hypothesis(ame_beta_zi_gdp_bts2, "draw>0")
result
#3
```

#BF2:Model Comparison

```{r}
bridge1 <-  brms::bridge_sampler(gdp_model_beta_zi_bts1, maxiter = 400000, start_val = "mean")
bridge2 <-  brms::bridge_sampler(gdp_model_beta_zi_bts2, maxiter = 400000, start_val = "mean")

bf1 <-  brms::bayes_factor(bridge2, bridge1)$bf
bf1
#39400.7
```


#posterior predictive distribution
```{r}
#Default prior
brms::pp_check(gdp_model_beta_zi_bts22,  type = "stat", prefix = "ppd")
#Define the prior
brms::pp_check(gdp_model_beta_zi_bts2, type = "stat", prefix = "ppd")
```


```{r}
#Default prior
brms::pp_check(gdp_model_beta_zi_bts22,ndraws=10, prefix = "ppd")
#Define the prior
brms::pp_check(gdp_model_beta_zi_bts2,ndraws=10, prefix = "ppd")
```







## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

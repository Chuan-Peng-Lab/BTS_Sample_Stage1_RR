---
title: "Exploratory_analysis"
author: "grit"
date: "2023/10/2"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)        # ggplot, dplyr, %>%, and friends
library(brms)             # Bayesian modeling through Stan
library(tidybayes)        # Manipulate Stan objects in a tidy way
library(broom)            # Convert model objects to data frames
library(broom.mixed)      # Convert brms model objects to data frames
#library(vdemdata)         # Use data from the Varieties of Democracy (V-Dem) project
library(betareg)          # Run beta regression models
library(extraDistr)       # Use extra distributions like dprop()
library(ggdist)           # Special geoms for posterior distributions
library(gghalves)         # Special half geoms
library(ggbeeswarm)       # Special distribution-shaped point jittering
library(ggrepel)          # Automatically position labels
library(patchwork)        # Combine ggplot objects
library(scales)           # Format numbers in nice ways
library(marginaleffects)  # Calculate marginal effects for regression models
library(modelsummary)     # Create side-by-side regression tables
library(ggthemes)
#library(rstan)
library(emmeans)
library(bayestestR)
```

```{r}
set.seed(1234)  # Make everything reproducible

# Define the goodness-of-fit stats to include in modelsummary()
gof_stuff <- tribble(
  ~raw, ~clean, ~fmt,
  "nobs", "N", 0,
  "r.squared", "R²", 3
)

# Custom ggplot theme to make pretty plots
# Get the font at https://fonts.google.com/specimen/Barlow+Semi+Condensed
theme_clean <- function() {
  theme_minimal(base_family = "Barlow Semi Condensed") +
    theme(panel.grid.minor = element_blank(),
          plot.title = element_text(family = "BarlowSemiCondensed-Bold"),
          axis.title = element_text(family = "BarlowSemiCondensed-Medium"),
          strip.text = element_text(family = "BarlowSemiCondensed-Bold",
                                    size = rel(1), hjust = 0),
          strip.background = element_rect(fill = "grey80", color = NA))
}

# Make labels use Barlow by default
update_geom_defaults("label_repel", list(family = "Barlow Semi Condensed"))

# Format things as percentage points
label_pp <- label_number(accuracy = 1, scale = 100, 
                         suffix = " pp.", style_negative = "minus")
label_pp_tiny <- label_number(accuracy = 0.01, scale = 100, 
                              suffix = " pp.", style_negative = "minus")


```

```{r}
latitude_longitude <- read_csv("countries_codes_and_coordinates.csv")
latitude_longitude
latitude_longitude$Latitude <- gsub('"', '', latitude_longitude$Latitude)
latitude_longitude$Longitude <- gsub('"', '', latitude_longitude$Longitude)
# 检查数据类型
class(latitude_longitude$Latitude)
class(latitude_longitude$Longitude)

# 如果不是数值型，转换为数值型
latitude_longitude$Latitude <- as.numeric(latitude_longitude$Latitude)
latitude_longitude$Longitude <- as.numeric(latitude_longitude$Longitude)
latitude_longitude
```

```{r}
pddata <- read_csv("pddata.csv")
pddata
latitude_longitude_pd <- latitude_longitude %>%
  filter(country_map %in% pddata$country_map)

pddata <- merge(pddata, latitude_longitude_pd, by = "country_map", all = TRUE)
pddata
```




```{r}
pddata %>% 
  count(percentage_sample == 0) %>% 
  mutate(prop = n / sum(n))
```


```{r}
pd_model_beta_zi_bts <- brm(
 bf(bts| trials(total_bts) ~ pd+ gp(Latitude, Longitude),
   phi ~ pd,
     zi ~ pd),
  data = pddata,
  family = zero_inflated_beta_binomial(),
  chains = 4, iter = 2000, warmup = 1000,
  cores = 4, seed = 1234,
  
  # regularising priors
  prior = c(prior(normal(0, 1), class = Intercept),
            prior(normal(0, 1), class = b),
            prior(exponential(2), class = sdgp)),
  
  # tune the mcmc sampler
  control = list(adapt_delta = 0.99),
  
  backend = "cmdstanr",
  file = "pd_model_beta_zi_bts"
)
tidy(pd_model_beta_zi_bts, effects = "fixed")
```

```{r}
ame_beta_zi_pd_bts <- 
  emtrends(pd_model_beta_zi_bts,~pd,var = "pd")%>% 
  gather_emmeans_draws()
ame_beta_zi_pd_bts
#summary(ame_beta_zi_pd_bts)
#ame_beta_zi_pd_bts %>% median_hdi()
#ame_beta_zi_pd_bts %>% mean_hdi()
#ame_beta_zi_pd_bts %>% mode_hdi()
```

%>% 
  gather_emmeans_draws()
var = "pd",

,epred=TRUE
```{r}
ame_beta_zi_pd_bts <- pd_model_beta_zi_bts %>%
  avg_comparisons(variables = "pd") %>% 
  posterior_draws()

ame_beta_zi_pd_bts %>% median_hdi(draw)

ggplot(ame_beta_zi_pd_bts, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of Cultural distance", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```
```{r}
describe_posterior(ame_beta_zi_pd_bts,
                   estimate = "median", dispersion = TRUE,
                   ci = .95, ci_method = "hdi",
                   test = "bf",

                                   bf_prior = stan_model)
fit_bayes_prior <- update(pd_model_beta_zi_bts,prior_PD = TRUE)
bayes_sum_prior <- emmeans(fit_bayes_prior, ~ pd)
bayesfactor_restricted(ame_beta_zi_pd_bts,prior=bayes_sum_prior, hypothesis=".value>0")
```


```{r}
ame_beta_zi_pd_bts <- na.omit(ame_beta_zi_pd_bts)
result <- hypothesis(ame_beta_zi_pd_bts, ".value>0")
result
result$hypothesis$Estimate
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
result$hypothesis$Est.Error
```

```{r}
model_ols1 <- lm(percentage_sample ~ pd,
                 data = pddata)
summary(model_ols1)
```

#PS2014
```{r}
pddata %>% 
  count(ps2014 == 0) %>% 
  mutate(prop = n / sum(n))
pddata
```

```{r}
pd_model_beta_zi_ps2014 <- brm(
   bf(ps| trials(total_ps) ~ pd+ gp(Latitude, Longitude),
   phi ~ pd,
     zi ~ pd),
  data = pddata,
  family = zero_inflated_beta_binomial(),
  chains = 4, iter = 2000, warmup = 1000,
  cores = 2, seed = 1234,
  
  # regularising priors
  prior = c(prior(normal(0, 1), class = Intercept),
            prior(normal(0, 1), class = b),
            prior(exponential(2), class = sdgp)),
  
  # tune the mcmc sampler
  control = list(adapt_delta = 0.99),
  
  backend = "cmdstanr",
  file = "pd_model_beta_zi_ps2014"
)
tidy(pd_model_beta_zi_ps2014, effects = "fixed")

```

```{r}
ame_beta_zi_pd_ps2014 <- 
  emtrends(pd_model_beta_zi_ps2014,~pd,var = "pd")%>% 
  gather_emmeans_draws()
ame_beta_zi_pd_ps2014
#summary(ame_beta_zi_pd_bts)
#ame_beta_zi_pd_bts %>% median_hdi()
#ame_beta_zi_pd_bts %>% mean_hdi()
#ame_beta_zi_pd_bts %>% mode_hdi()
```


```{r}
ame_beta_zi_pd_ps2014 <- pd_model_beta_zi_ps2014 %>%
  avg_comparisons(variables = "pd") %>% 
  posterior_draws()
ame_beta_zi_pd_ps2014 %>% median_hdi(draw)

ggplot(ame_beta_zi_pd_ps2014, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of Cultural distance", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
describe_posterior(ame_beta_zi_pd_ps2014,
                   estimate = "median", dispersion = TRUE,
                   ci = .95, ci_method = "hdi",
                   test = "bf",

                                   bf_prior = stan_model)
bayesfactor_restricted(ame_beta_zi_pd_ps2014, hypothesis=".value>0")


```

```{r}
result <- hypothesis(ame_beta_zi_pd_ps2014, "draw<0")
result
result$hypothesis$Estimate
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
result$hypothesis$Est.Error

```

```{r}
model_ols1 <- lm(ps2014 ~ pd,
                 data = pddata)
summary(model_ols1)
```

##心理距离画图
```{r}
combined_data1 <- rbind(
  transform(pddata, source = "PS2014", value = ps2014),
  transform(pddata, source = "PSA001", value = percentage_sample)
)
# Create the plot
pd1 <- ggplot(combined_data1, aes(x = pd, y = value, color = source)) +
  
 geom_point(size = 6, alpha = 0.6) +
  geom_smooth(method ="lm",size = 2) +
  scale_color_brewer(palette = 'Set1') +
 scale_color_manual(name = "Data source", 
                    values = c("#377EB8","#E41A1C"), 
                    labels = c("Traditional studies", "BTS")) +

  ylab("Proportion of sample") +
  xlab("Culture distance from United States") +
  theme(axis.text = element_text(size = 20),
        axis.title = element_text(size = 24),
        panel.background = element_rect(fill = "white"),
        axis.line = element_line(color = "black"),
        aspect.ratio = 1,
        legend.position = "right",  # 设置图例位置为顶部
        legend.text = element_text(size = 18),  # 设置图例文本字体大小
        legend.title = element_text(size = 20)) +
  xlim(c(0, 0.20)) +
  ylim(c(-0.30, 1)) +
  guides(color = guide_legend(override.aes = list(linetype = c("solid", "dashed"))))

# Adding the label
pd1 <- pd1 +
  annotate("text", x = 0.018, y = 0.955, 
           label = expression("US"), size = 6) +
  annotate("text", x = 0.018, y = 0.235, 
           label = expression("US"), size = 6)
#翻转X轴
pd1 <- pd1 + scale_x_reverse()
# Print the plot
pd1

# Save the plot as a JPEG image
ggsave(filename = "PD.jpg", plot = pd1, device = "jpg", width = 12, height = 12)
```




##GDP_per_capita
```{r}
gdpdata <- read_csv("gdpdata.csv")
gdpdata
gdpdata %>% 
  count(ps == 0) %>% 
  mutate(prop = n / sum(n))

latitude_longitude_gdp <- latitude_longitude %>%
  filter(country_map %in% gdpdata$country_map)

gdpdata <- merge(gdpdata, latitude_longitude_gdp, by = "country_map", all = TRUE)
gdpdata
```


```{r}
gdp_model_beta_zi_bts <- brm(
   bf(bts| trials(total_bts) ~ GDP_per_capita+ gp(Latitude, Longitude),
   phi ~ GDP_per_capita,
     zi ~ GDP_per_capita),
  data = gdpdata,
  family = zero_inflated_beta_binomial(),
  chains = 4, iter = 2000, warmup = 1000,
  cores = 2, seed = 1234,
  
  # regularising priors
  prior = c(prior(normal(0, 1), class = Intercept),
            prior(normal(0, 1), class = b),
            prior(exponential(2), class = sdgp)),
  
  # tune the mcmc sampler
  control = list(adapt_delta = 0.99),
  
  backend = "cmdstanr",
  file = "gdp_model_beta_zi_bts"
)
tidy(gdp_model_beta_zi_bts, effects = "fixed")

```

```{r}
ame_beta_zi_gdp_bts <- gdp_model_beta_zi_bts %>%
  avg_comparisons(variables = "GDP_per_capita") %>% 
  posterior_draws()

ame_beta_zi_gdp_bts %>% median_hdi(draw)


ggplot(ame_beta_zi_gdp_bts, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of GDP per capita", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
result <- hypothesis(ame_beta_zi_gdp_bts, "draw>0")
result
result$hypothesis$Estimate
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
result$hypothesis$Est.Error
```


```{r}
model_ols2 <- lm(percentage_sample ~ gdp,
                 data = gdpdata)
model_ols2
```

#PS2014
```{r}
gdpdata %>% 
  count(ps2014 == 0) %>% 
  mutate(prop = n / sum(n))

```

```{r}
gdp_model_beta_zi_ps2014 <- brm(
  bf(ps| trials(total_ps) ~ GDP_per_capita+ gp(Latitude, Longitude),
   phi ~ GDP_per_capita,
     zi ~ GDP_per_capita),
  data = gdpdata,
  family = zero_inflated_beta_binomial(),
  chains = 4, iter = 2000, warmup = 1000,
  cores = 2, seed = 1234,
  
  # regularising priors
  prior = c(prior(normal(0, 1), class = Intercept),
            prior(normal(0, 1), class = b),
            prior(exponential(2), class = sdgp)),
  
  # tune the mcmc sampler
  control = list(adapt_delta = 0.99),
  
  backend = "cmdstanr",
  file = "gdp_model_beta_zi_ps2014"
)
tidy(gdp_model_beta_zi_ps2014, effects = "fixed")

```




```{r}
ame_beta_zi_gdp_ps2014 <- gdp_model_beta_zi_ps2014 %>%
  avg_comparisons(variables = "GDP_per_capita") %>% 
  posterior_draws()
ame_beta_zi_gdp_ps2014 %>% median_hdi(draw)

ggplot(ame_beta_zi_gdp_ps2014, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of GDP per capita", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
result <- hypothesis(ame_beta_zi_gdp_ps2014, "draw>0")
result
result$hypothesis$Estimate
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
result$hypothesis$Est.Error
```

```{r}
model_ols1 <- lm(ps2014 ~ GDP_per_capita,
                 data = gdpdata)
summary(model_ols1)
```

##人均GDP画图
```{r}  
combined_data2 <- rbind(
  transform(gdpdata, source = "PS2014", value = ps2014),
  transform(gdpdata, source = "PSA001", value = percentage_sample)
)
# Create the plot
gdp1 <- ggplot(combined_data2, aes(x = GDP_per_capita, y = value, color = source)) +
  
 geom_point(size = 6, alpha = 0.6) +
  geom_smooth(method ="lm",size = 2) +
  scale_color_brewer(palette = 'Set1') +
 scale_color_manual(name = "Data source", 
                    values = c("#377EB8","#E41A1C"), 
                    labels = c("Traditional studies", "BTS"))+
  
  ylab("Proportion of sample") +
  xlab("GDP per capita") +
  theme(axis.text = element_text(size = 20),
        axis.title = element_text(size = 24),
        panel.background = element_rect(fill = "white"),
        axis.line = element_line(color = "black"),
        aspect.ratio = 1,
        legend.position = "right",  # 设置图例位置为顶部
        legend.text = element_text(size = 18),  # 设置图例文本字体大小
        legend.title = element_text(size = 20)) +
  xlim(c(0, 15)) +
  ylim(c(-0.2, 1)) +
  guides(color = guide_legend(override.aes = list(linetype = c("solid", "dashed"))))

# Adding the label
gdp1 <- gdp1 +
  annotate("text", x = 6.43, y = 0.955, 
           label = expression("US"), size = 6) +
  annotate("text", x = 6.43, y = 0.235, 
           label = expression("US"), size = 6)
gdp1

# Save the plot as a JPEG image
ggsave(filename = "GDP.jpg", plot = gdp1, device = "jpg", width = 12, height = 12)
```


##03_R&D_investment
```{r}
rddata <- read_csv("rddata.csv")
rddata
rddata %>% 
  count(percentage_sample == 0) %>% 
  mutate(prop = n / sum(n))

latitude_longitude_rd <- latitude_longitude %>%
  filter(country_map %in% rddata$country_map)

rddata <- merge(rddata, latitude_longitude_rd, by = "country_map", all = TRUE)
rddata
```



```{r}
rd_model_beta_zi_bts <- brm(
  bf(bts| trials(total_bts) ~ R_D+ gp(Latitude, Longitude),
   phi ~ R_D,
     zi ~ R_D),
  data = rddata,
  family = zero_inflated_beta_binomial(),
  chains = 4, iter = 2000, warmup = 1000,
  cores = 2, seed = 1234,
  
  # regularising priors
  prior = c(prior(normal(0, 1), class = Intercept),
            prior(normal(0, 1), class = b),
            prior(exponential(2), class = sdgp)),
  
  # tune the mcmc sampler
  control = list(adapt_delta = 0.99),
  
  backend = "cmdstanr",
  file = "rd_model_beta_zi_bts"
)
tidy(rd_model_beta_zi_bts, effects = "fixed")

```

```{r}
ame_beta_zi_rd_bts <- rd_model_beta_zi_bts %>%
  avg_comparisons(variables = "R_D") %>% 
  posterior_draws()

ame_beta_zi_rd_bts %>% median_hdi(draw)


ggplot(ame_beta_zi_rd_bts, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of R&D investment", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
parallel::detectCores()
result <- hypothesis(ame_beta_zi_rd_bts, "draw>0")
result
result$hypothesis$Estimate
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
result$hypothesis$Est.Error
```

```{r}
rd_model_beta_zi_ps2014 <- brm(
  bf(ps| trials(total_ps) ~ R_D+ gp(Latitude, Longitude),
   phi ~ R_D,
     zi ~ R_D),
  data = rddata,
  family = zero_inflated_beta_binomial(),
  chains = 4, iter = 2000, warmup = 1000,
  cores = 2, seed = 1234,
  
  # regularising priors
  prior = c(prior(normal(0, 1), class = Intercept),
            prior(normal(0, 1), class = b),
            prior(exponential(2), class = sdgp)),
  
  # tune the mcmc sampler
  control = list(adapt_delta = 0.99),
  
  backend = "cmdstanr",
  file = "rd_model_beta_zi_ps2014"
)
tidy(rd_model_beta_zi_ps2014, effects = "fixed")

```

```{r}
ame_beta_zi_rd_ps2014 <- rd_model_beta_zi_ps2014 %>%
  avg_comparisons(variables = "R_D") %>% 
  posterior_draws()
ame_beta_zi_rd_ps2014 %>% median_hdi(draw)

ggplot(ame_beta_zi_rd_ps2014, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of R&D investment", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
result <- hypothesis(ame_beta_zi_rd_ps2014, "draw>0")
result
result$hypothesis$Estimate
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
result$hypothesis$Est.Error
```

#R&D_investment画图
```{r}  
# 拟合线性回归模型并计算置信区间
combined_data3 <- rbind(
  transform(rddata, source = "PS2014", value = ps2014),
  transform(rddata, source = "PSA001", value = percentage_sample)
)
# Create the plot
RD1 <- ggplot(combined_data3, aes(x = R_D, y = value, color = source)) +
  
 geom_point(size = 6, alpha = 0.6) +
  geom_smooth(method ="lm",size = 2) +
  scale_color_brewer(palette = 'Set1') +
scale_color_manual(name = "Data source", 
                    values = c("#377EB8","#E41A1C"), 
                    labels = c("Traditional studies", "BTS"))+
  ylab("Proportion of sample") +
  xlab("Research expenditure as a share of GDP") +
  theme(axis.text = element_text(size = 20),
        axis.title = element_text(size = 24),
        panel.background = element_rect(fill = "white"),
        axis.line = element_line(color = "black"),
        aspect.ratio = 1,
        legend.position = "right",  # 设置图例位置为顶部
        legend.text = element_text(size = 18),  # 设置图例文本字体大小
        legend.title = element_text(size = 20)) +
  xlim(c(0, 3.5)) +
  ylim(c(-0.14, 1)) +
  guides(color = guide_legend(override.aes = list(linetype = c("solid", "dashed"))))

# Adding the label
RD1 <- RD1 +
  annotate("text", x = 2.55, y = 0.955, 
           label = expression("US"), size = 6) +
  annotate("text", x = 2.55, y = 0.235, 
           label = expression("US"), size = 6)

# Print the plot
RD1

# Save the plot as a JPEG image
ggsave(filename = "RD.jpg", plot = RD1, device = "jpg", width = 12, height = 12)
```

##04_Number of universities per 100000 people
```{r}
universitydata <- read_csv("universitydata.csv")
universitydata
universitydata %>% 
  count(percentage_sample == 0) %>% 
  mutate(prop = n / sum(n))

latitude_longitude_university <- latitude_longitude %>%
  filter(country_map %in% universitydata$country_map)

universitydata <- merge(universitydata, latitude_longitude_university, by = "country_map", all = TRUE)
universitydata
```

```{r}
university_model_beta_zi_bts <- brm(
  bf(bts| trials(total_bts) ~ number_of_universities_per_capita+ gp(Latitude, Longitude),
   phi ~ number_of_universities_per_capita,
     zi ~ number_of_universities_per_capita),
  data = universitydata,
  family = zero_inflated_beta_binomial(),
  chains = 4, iter = 2000, warmup = 1000,
  cores = 2, seed = 1234,
  
  # regularising priors
  prior = c(prior(normal(0, 1), class = Intercept),
            prior(normal(0, 1), class = b),
            prior(exponential(2), class = sdgp)),
  
  # tune the mcmc sampler
  control = list(adapt_delta = 0.99),
  
  backend = "cmdstanr",
  file = "university_model_beta_zi_bts"
)
tidy(university_model_beta_zi_bts, effects = "fixed")

```

```{r}
ame_beta_zi_university_bts <- university_model_beta_zi_bts %>%
  avg_comparisons(variables = "number_of_universities_per_capita") %>% 
  posterior_draws()

ame_beta_zi_university_bts %>% median_hdi(draw)


ggplot(ame_beta_zi_university_bts, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of Number of universities per 100000 people", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
result <- hypothesis(ame_beta_zi_university_bts, "draw>0")
result
result$hypothesis$Estimate
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
result$hypothesis$Est.Error
```

```{r}
university_model_beta_zi_ps2014 <- brm(
  bf(ps| trials(total_ps) ~ number_of_universities_per_capita+ gp(Latitude, Longitude),
   phi ~ number_of_universities_per_capita,
     zi ~ number_of_universities_per_capita),
  data = universitydata,
  family = zero_inflated_beta_binomial(),
  chains = 4, iter = 2000, warmup = 1000,
  cores = 2, seed = 1234,
  
  # regularising priors
  prior = c(prior(normal(0, 1), class = Intercept),
            prior(normal(0, 1), class = b),
            prior(exponential(2), class = sdgp)),
  
  # tune the mcmc sampler
  control = list(adapt_delta = 0.99),
  
  backend = "cmdstanr",
  file = "university_model_beta_zi_ps2014"
)
tidy(university_model_beta_zi_ps2014, effects = "fixed")

```

```{r}
ame_beta_zi_university_ps2014 <- university_model_beta_zi_ps2014 %>%
  avg_comparisons(variables = "number_of_universities_per_capita") %>% 
  posterior_draws()

ame_beta_zi_university_ps2014 %>% median_hdi(draw)


ggplot(ame_beta_zi_university_ps2014, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of Number of universities per 100000 people", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
result <- hypothesis(ame_beta_zi_university_ps2014, "draw>0")
result
result$hypothesis$Estimate
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
result$hypothesis$Est.Error
```


##人均大学数量画图
```{r}
combined_data1 <- rbind(
  transform(universitydata, source = "PS2014", value = ps2014),
  transform(universitydata, source = "PSA001", value = percentage_sample)
)
# Create the plot
university <- ggplot(combined_data1, aes(x = number_of_universities_per_capita, y = value, color = source)) +
  
 geom_point(size = 6, alpha = 0.6) +
  geom_smooth(method ="lm",size = 2) +
  scale_color_brewer(palette = 'Set1') +
 scale_color_manual(name = "Data source", 
                    values = c("#377EB8","#E41A1C"), 
                    labels = c("Traditional studies", "BTS")) +

  ylab("Proportion of sample") +
  xlab("Number of universities per 100000 people") +
  theme(axis.text = element_text(size = 20),
        axis.title = element_text(size = 24),
        panel.background = element_rect(fill = "white"),
        axis.line = element_line(color = "black"),
        aspect.ratio = 1,
        legend.position = "right",  # 设置图例位置为顶部
        legend.text = element_text(size = 18),  # 设置图例文本字体大小
        legend.title = element_text(size = 20)) +
  xlim(c(0, 54)) +
  ylim(c(-0.10, 1)) +
  guides(color = guide_legend(override.aes = list(linetype = c("solid", "dashed"))))

# Adding the label
university <- university +
  annotate("text", x = 5, y = 0.955, 
           label = expression("US"), size = 6) +
  annotate("text", x = 5, y = 0.235, 
           label = expression("US"), size = 6)
# Print the plot
university
# Save the plot as a JPEG image
ggsave(filename = "university.jpg", plot = university, device = "jpg", width = 12, height = 12)
```

##number_of_psychology_researchers_per_capita
```{r}
researcherdata <- read_csv("researcherdata.csv")
researcherdata
researcherdata %>% 
  count(percentage_sample == 0) %>% 
  mutate(prop = n / sum(n))

latitude_longitude_researcher <- latitude_longitude %>%
  filter(country_map %in% researcherdata$country_map)

researcherdata <- merge(researcherdata, latitude_longitude_researcher, by = "country_map", all = TRUE)
researcherdata
```

```{r}
researcher_model_beta_zi_bts <- brm(
  bf(bts| trials(total_bts) ~ number_of_psychology_researchers_per_capita+ gp(Latitude, Longitude),
   phi ~ number_of_psychology_researchers_per_capita,
     zi ~ number_of_psychology_researchers_per_capita),
  data = researcherdata,
  family = zero_inflated_beta_binomial(),
  chains = 4, iter = 2000, warmup = 1000,
  cores = 2, seed = 1234,
  
  # regularising priors
  prior = c(prior(normal(0, 1), class = Intercept),
            prior(normal(0, 1), class = b),
            prior(exponential(2), class = sdgp)),
  
  # tune the mcmc sampler
  control = list(adapt_delta = 0.99),
  
  backend = "cmdstanr",
  file = "researcher_model_beta_zi_bts"
)
tidy(researcher_model_beta_zi_bts, effects = "fixed")

```

```{r}
ame_beta_zi_researcher_bts <- researcher_model_beta_zi_bts %>%
  avg_comparisons(variables = "number_of_psychology_researchers_per_capita") %>% 
  posterior_draws()

ame_beta_zi_researcher_bts %>% median_hdi(draw)


ggplot(ame_beta_zi_researcher_bts, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of number of psychology researchers per capita", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
result <- hypothesis(ame_beta_zi_researcher_bts, "draw>0")
result
result$hypothesis$Estimate
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
result$hypothesis$Est.Error
```

```{r}
researcher_model_beta_zi_ps2014 <- brm(
  bf(ps| trials(total_ps) ~ number_of_psychology_researchers_per_capita+ gp(Latitude, Longitude),
   phi ~ number_of_psychology_researchers_per_capita,
     zi ~ number_of_psychology_researchers_per_capita),
  data = researcherdata,
  family = zero_inflated_beta_binomial(),
  chains = 4, iter = 2000, warmup = 1000,
  cores = 2, seed = 1234,
  
  # regularising priors
  prior = c(prior(normal(0, 1), class = Intercept),
            prior(normal(0, 1), class = b),
            prior(exponential(2), class = sdgp)),
  
  # tune the mcmc sampler
  control = list(adapt_delta = 0.99),
  
  backend = "cmdstanr",
  file = "researcher_model_beta_zi_ps2014"
)
tidy(researcher_model_beta_zi_ps2014, effects = "fixed")

```

```{r}
ame_beta_zi_researcher_ps2014 <- researcher_model_beta_zi_ps2014 %>%
  avg_comparisons(variables = "number_of_psychology_researchers_per_capita") %>% 
  posterior_draws()

ame_beta_zi_researcher_ps2014 %>% median_hdi(draw)


ggplot(ame_beta_zi_researcher_ps2014, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of number of psychology researchers per capita", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
result <- hypothesis(ame_beta_zi_researcher_ps2014, "draw>0")
result
result$hypothesis$Estimate
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
result$hypothesis$Est.Error
```


##人均心理学研究者数量画图
```{r}
combined_data1 <- rbind(
  transform(researcherdata, source = "PS2014", value = ps2014),
  transform(researcherdata, source = "PSA001", value = percentage_sample)
)
# Create the plot
researcher <- ggplot(combined_data1, aes(x = number_of_psychology_researchers_per_capita, y = value, color = source)) +
  
 geom_point(size = 6, alpha = 0.6) +
  geom_smooth(method ="lm",size = 2) +
  scale_color_brewer(palette = 'Set1') +
 scale_color_manual(name = "Data source", 
                    values = c("#377EB8","#E41A1C"), 
                    labels = c("Traditional studies", "BTS")) +

  ylab("Proportion of sample") +
  xlab("Number of psychology researchers per 100000 people") +
  theme(axis.text = element_text(size = 20),
        axis.title = element_text(size = 24),
        panel.background = element_rect(fill = "white"),
        axis.line = element_line(color = "black"),
        aspect.ratio = 1,
        legend.position = "right",  # 设置图例位置为顶部
        legend.text = element_text(size = 18),  # 设置图例文本字体大小
        legend.title = element_text(size = 20)) +
  xlim(c(0, 200)) +
  ylim(c(-0.14, 1)) +
  guides(color = guide_legend(override.aes = list(linetype = c("solid", "dashed"))))

# Adding the label
researcher <- researcher +
  annotate("text", x = 50, y = 0.955, 
           label = expression("US"), size = 6) +
  annotate("text", x = 50, y = 0.235, 
           label = expression("US"), size = 6)
# Print the plot
researcher
# Save the plot as a JPEG image
ggsave(filename = "researcher.jpg", plot = researcher, device = "jpg", width = 12, height = 12)
```




##Education_data
```{r}
edudata <- read_csv("Education_data.csv")
edudata
edudata %>% 
  count(percentage_sample == 0) %>% 
  mutate(prop = n / sum(n))

latitude_longitude_edu <- latitude_longitude %>%
  filter(country_map %in% edudata$country_map)

edudata <- merge(edudata, latitude_longitude_edu, by = "country_map", all = TRUE)
edudata
```


```{r}
edu_model_beta_zi_bts <- brm(
   bf(bts| trials(total_bts) ~ average_years_of_schooling+ gp(Latitude, Longitude),
   phi ~ average_years_of_schooling,
     zi ~ average_years_of_schooling),
  data = edudata,
  family = zero_inflated_beta_binomial(),
  chains = 4, iter = 2000, warmup = 1000,
  cores = 4, seed = 1234,
  
  # regularising priors
  prior = c(prior(normal(0, 1), class = Intercept),
            prior(normal(0, 1), class = b),
            prior(exponential(2), class = sdgp)),
  
  # tune the mcmc sampler
  control = list(adapt_delta = 0.99),
  
  backend = "cmdstanr",
  file = "edu_model_beta_zi_bts"
)
tidy(edu_model_beta_zi_bts, effects = "fixed")

```

```{r}
ame_beta_zi_edu_bts <- edu_model_beta_zi_bts %>%
  avg_comparisons(variables = "average_years_of_schooling") %>% 
  posterior_draws()

ame_beta_zi_edu_bts %>% median_hdi(draw)


ggplot(ame_beta_zi_edu_bts, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of Average years of schooling", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
result <- hypothesis(ame_beta_zi_edu_bts, "draw>0")
result
result$hypothesis$Estimate
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
result$hypothesis$Est.Error
```

```{r}
edu_model_beta_zi_ps2014 <- brm(
  bf(ps| trials(total_ps) ~ average_years_of_schooling+ gp(Latitude, Longitude),
   phi ~ average_years_of_schooling,
     zi ~ average_years_of_schooling),
  data = edudata,
  family = zero_inflated_beta_binomial(),
  chains = 4, iter = 4000, warmup = 2000,
  cores = 4, seed = 1234,
  
  # regularising priors
  prior = c(prior(normal(0, 1), class = Intercept),
            prior(normal(0, 1), class = b),
            prior(exponential(2), class = sdgp)),
  
  # tune the mcmc sampler
  control = list(adapt_delta = 0.99),
  
  backend = "cmdstanr",
  file = "edu_model_beta_zi_ps2014"
)

```

```{r}
tidy(edu_model_beta_zi_ps2014, effects = "fixed")
```


```{r}
ame_beta_zi_edu_ps2014 <- edu_model_beta_zi_ps2014 %>%
  avg_comparisons(variables = "average_years_of_schooling") %>% 
  posterior_draws()
ame_beta_zi_edu_ps2014 %>% median_hdi(draw)

ggplot(ame_beta_zi_edu_ps2014, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of Average years of schooling", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
result <- hypothesis(ame_beta_zi_edu_ps2014, "draw>0")
result
result$hypothesis$Estimate
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
result$hypothesis$Est.Error
```

##受教育程度画图
```{r}  
# 拟合线性回归模型并计算置信区间
combined_data9 <- rbind(
  transform(edudata, source = "PS2014", value = ps2014),
  transform(edudata, source = "PSA001", value = percentage_sample)
)
# Create the plot
education1 <- ggplot(combined_data9, aes(x = average_years_of_schooling, y = value, color = source)) +
  
 geom_point(size = 6, alpha = 0.6) +
  geom_smooth(method ="lm",size = 2) +
  scale_color_brewer(palette = 'Set1') +
 scale_color_manual(name = "Data source", 
                    values = c("#377EB8","#E41A1C"), 
                    labels = c("Traditional studies", "BTS"))+
    
  ylab("Proportion of sample") +
  xlab("Average years of formal education\nfor individuals aged 15-64") +
  theme(axis.text = element_text(size = 20),
        axis.title = element_text(size = 24),
        panel.background = element_rect(fill = "white"),
        axis.line = element_line(color = "black"),
        aspect.ratio = 1,
        legend.position = "right",  # 设置图例位置为顶部
        legend.text = element_text(size = 18),  # 设置图例文本字体大小
        legend.title = element_text(size = 20)) +
  xlim(c(0, 15)) +
  ylim(c(-0.25, 1)) +
  guides(color = guide_legend(override.aes = list(linetype = c("solid", "dashed"))))

# Adding the annotations
education1 <- education1 +
  annotate("text", x = 12.1, y = 0.955, 
           label = expression("US"), size = 6) +
  annotate("text", x = 12.1, y = 0.235, 
           label = expression("US"), size = 6)

# Print the plot
education1

# Save the plot as a JPEG image
ggsave(filename = "education.jpg", plot = education1, device = "jpg", width = 12, height = 12)
```


##Urbanization_data
```{r}
urbandata <- read_csv("Urbanization_data.csv")
urbandata
urbandata %>% 
  count(percentage_sample == 0) %>% 
  mutate(prop = n / sum(n))

latitude_longitude_urban <- latitude_longitude %>%
  filter(country_map %in% urbandata$country_map)

urbandata <- merge(urbandata, latitude_longitude_urban, by = "country_map", all = TRUE)
urbandata
```


```{r}
urban_model_beta_zi_bts <- brm(
  bf(bts| trials(total_bts) ~ Urbanization+ gp(Latitude, Longitude),
   phi ~ Urbanization,
     zi ~ Urbanization),
  data = urbandata,
  family = zero_inflated_beta_binomial(),
  chains = 4, iter = 2000, warmup = 1000,
  cores = 2, seed = 1234,
  
  # regularising priors
  prior = c(prior(normal(0, 1), class = Intercept),
            prior(normal(0, 1), class = b),
            prior(exponential(2), class = sdgp)),
  
  # tune the mcmc sampler
  control = list(adapt_delta = 0.99),
  
  backend = "cmdstanr",
  file = "urban_model_beta_zi_bts")
tidy(urban_model_beta_zi_bts, effects = "fixed")

```

```{r}
ame_beta_zi_urban_bts <- urban_model_beta_zi_bts %>%
  avg_comparisons(variables = "Urbanization") %>% 
  posterior_draws()
ame_beta_zi_urban_bts %>% median_hdi(draw)

ggplot(ame_beta_zi_urban_bts, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of Urbanization", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
result <- hypothesis(ame_beta_zi_urban_bts, "draw>0")
result
result$hypothesis$Estimate
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
result$hypothesis$Est.Error
```

```{r}
urbandata  <- prepare_predictions(urbandata, nug=1e6)
urban_model_beta_zi_ps2014 <- brm(
  bf(ps| trials(total_ps) ~ Urbanization+ gp(Latitude, Longitude),
   phi ~ Urbanization,
     zi ~ Urbanization),
  data = urbandata,
  family = zero_inflated_beta_binomial(),
  chains = 4, iter = 100, warmup = 50,
  cores = 4, seed = 1234,
  # regularising priors
  prior = c(prior(normal(0, 1), class = Intercept),
            prior(normal(0, 1), class = b),
            prior(exponential(2), class = sdgp)),
  methods= "brmsfit",
  # tune the mcmc sampler
  control = list(adapt_delta = 0.99),
  
  backend = "cmdstanr",
  file = "urban_model_beta_zi_ps2014"
)
tidy(urban_model_beta_zi_ps2014, effects = "fixed")
```

```{r}

```

```{r}
ame_beta_zi_urban_ps2014 <- 
  emmeans(urban_model_beta_zi_ps2014,~ Urbanization,epred = TRUE,
          re_formula = NULL) %>% 
  contrast(method = "revpairwise") %>% 
  gather_emmeans_draws()
ame_beta_zi_urban_ps2014
ame_beta_zi_urban_ps2014 %>% median_hdi()
```

prepare_predictions(urban_model_beta_zi_ps2014,nug=1e-1)
prepare_predictions(urban_model_beta_zi_ps2014,sample_new_levels="gaussian", nug=1e-1)
sample_new_levels

urban_model_beta_zi_ps2014  <- prepare_predictions(urban_model_beta_zi_ps2014, nug=1e-7)


```{r}
urban_model_beta_zi_ps2014  <- prepare_predictions(urban_model_beta_zi_ps2014, nug=1e6)
ame_beta_zi_urban_ps2014 <- urban_model_beta_zi_ps2014 %>%
  avg_comparisons(variables = "Urbanization") %>% 
  posterior_draws()
ame_beta_zi_urban_ps2014 %>% median_hdi(draw)

ggplot(ame_beta_zi_urban_ps2014, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of Urbanization", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
result <- hypothesis(ame_beta_zi_urban_ps2014, "draw>0")
result
result$hypothesis$Estimate
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
result$hypothesis$Est.Error
```

#城市化画图
```{r}  
# 拟合线性回归模型并计算置信区间
combined_data8 <- rbind(
  transform(urbandata, source = "PS2014", value = ps2014),
  transform(urbandata, source = "PSA001", value = percentage_sample)
)
# Create the plot
UP1 <- ggplot(combined_data8, aes(x = Urbanization, y = value, color = source)) +
  
 geom_point(size = 6, alpha = 0.6) +
  geom_smooth(method ="lm",size = 2) +
  scale_color_brewer(palette = 'Set1') +
 scale_color_manual(name = "Data source", 
                    values = c("#377EB8","#E41A1C"), 
                    labels = c("Traditional studies", "BTS"))+
    
  ylab("Proportion of sample") +
  xlab("Proportion of urban population") +
  theme(axis.text = element_text(size = 20),
        axis.title = element_text(size = 24),
        panel.background = element_rect(fill = "white"),
        axis.line = element_line(color = "black"),
        aspect.ratio = 1,
        legend.position = "right",  # 设置图例位置为顶部
        legend.text = element_text(size = 18),  # 设置图例文本字体大小
        legend.title = element_text(size = 20)) +
  xlim(c(0, 1)) +
  ylim(c(-0.25, 1)) +
  guides(color = guide_legend(override.aes = list(linetype = c("solid", "dashed"))))

# Adding the annotations
UP1 <- UP1 +
  annotate("text", x = 0.75, y = 0.955, 
           label = expression("US"), size = 6) +
  annotate("text", x = 0.75, y = 0.235, 
           label = expression("US"), size = 6)

# Print the plot
UP1

# Save the plot as a JPEG image
ggsave(filename = "UP.jpg", plot = UP1, device = "jpg", width = 12, height = 12)
```


##Globalization
```{r}
gidata <- read_csv("gidata.csv")
gidata
gidata %>% 
  count(percentage_sample == 0) %>% 
  mutate(prop = n / sum(n))

latitude_longitude_gi <- latitude_longitude %>%
  filter(country_map %in% gidata$country_map)

gidata <- merge(gidata, latitude_longitude_gi, by = "country_map", all = TRUE)
gidata
```



```{r}
gi_model_beta_zi_bts <- brm(
   bf(bts| trials(total_bts) ~ GI+ gp(Latitude, Longitude),
   phi ~ GI,
     zi ~ GI),
  data = gidata,
  family = zero_inflated_beta_binomial(),
  chains = 4, iter = 2000, warmup = 1000,
  cores = 2, seed = 1234,
  
  # regularising priors
  prior = c(prior(normal(0, 1), class = Intercept),
            prior(normal(0, 1), class = b),
            prior(exponential(2), class = sdgp)),
  
  # tune the mcmc sampler
  control = list(adapt_delta = 0.99),
  
  backend = "cmdstanr",
  file = "gi_model_beta_zi_bts"
)
tidy(gi_model_beta_zi_bts, effects = "fixed")

```

```{r}
ame_beta_zi_gi_bts <- gi_model_beta_zi_bts %>%
  avg_comparisons(variables = "GI") %>% 
  posterior_draws()
ame_beta_zi_gi_bts %>% median_hdi(draw)

ggplot(ame_beta_zi_gi_bts, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of Globalization", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
result <- hypothesis(ame_beta_zi_gi_bts, "draw>0")
result
result$hypothesis$Estimate
result$hypothesis$Est.Error
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
```

```{r}
gi_model_beta_zi_ps2014 <- brm(
  bf(ps| trials(total_ps) ~ GI+ gp(Latitude, Longitude),
   phi ~ GI,
     zi ~ GI),
  data = gidata,
  family = zero_inflated_beta_binomial(),
  chains = 4, iter = 2000, warmup = 1000,
  cores = 2, seed = 1234,
  
  # regularising priors
  prior = c(prior(normal(0, 1), class = Intercept),
            prior(normal(0, 1), class = b),
            prior(exponential(2), class = sdgp)),
  
  # tune the mcmc sampler
  control = list(adapt_delta = 0.99),
  
  backend = "cmdstanr",
  file = "gi_model_beta_zi_ps2014"
)

```

```{r}
tidy(gi_model_beta_zi_ps2014, effects = "fixed")
```

```{r}
ame_beta_zi_gi_ps2014 <- gi_model_beta_zi_ps2014 %>%
  avg_comparisons(variables = "GI") %>% 
  posterior_draws()
ame_beta_zi_gi_ps2014 %>% median_hdi(draw)

ggplot(ame_beta_zi_gi_ps2014, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of Globalization", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
result <- hypothesis(ame_beta_zi_gi_ps2014, "draw>0")
result
result$hypothesis$Estimate
result$hypothesis$Est.Error
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
```

#全球化系数画图
```{r}  
# 拟合线性回归模型并计算置信区间
combined_data4 <- rbind(
  transform(gidata, source = "PS2014", value = ps2014),
  transform(gidata, source = "PSA001", value = percentage_sample)
)
# Create the plot
GI1 <- ggplot(combined_data4, aes(x = GI, y = value, color = source)) +
 geom_point(size = 6, alpha = 0.6) +
  geom_smooth(method ="lm",size = 2) +
  scale_color_brewer(palette = 'Set1') +
 scale_color_manual(name = "Data source", 
                    values = c("#377EB8","#E41A1C"), 
                    labels = c("Traditional studies", "BTS"))+
  ylab("Proportion of sample") +
  xlab("Globalization Index") +
  theme(axis.text = element_text(size = 20),
        axis.title = element_text(size = 24),
        panel.background = element_rect(fill = "white"),
        axis.line = element_line(color = "black"),
        aspect.ratio = 1,
        legend.position = "right",  # 设置图例位置为顶部
        legend.text = element_text(size = 18),  # 设置图例文本字体大小
        legend.title = element_text(size = 20)) +
  xlim(c(0, 100)) +
  ylim(c(-0.15, 1)) +
  guides(color = guide_legend(override.aes = list(linetype = c("solid", "dashed"))))

# Adding the annotations
GI1 <- GI1 +
  annotate("text", x = 73.8, y = 0.955, 
           label = expression("US"), size = 6) +
  annotate("text", x = 73.8, y = 0.235, 
           label = expression("US"), size = 6)
# Print the plot
GI1

# Save the plot as a JPEG image
ggsave(filename = "GI.jpg", plot = GI1, device = "jpg", width = 12, height = 12)
```

##network
```{r}
networkdata <- read_csv("networkdata.csv")
networkdata
networkdata %>% 
  count(percentage_sample == 0) %>% 
  mutate(prop = n / sum(n))

latitude_longitude_network <- latitude_longitude %>%
  filter(country_map %in% networkdata$country_map)

networkdata <- merge(networkdata, latitude_longitude_network, by = "country_map", all = TRUE)
networkdata
```


```{r}
network_model_beta_zi_bts <- brm(
   bf(bts| trials(total_bts) ~ Network_2021+ gp(Latitude, Longitude),
   phi ~ Network_2021,
     zi ~ Network_2021),
  data = networkdata,
  family = zero_inflated_beta_binomial(),
  chains = 4, iter = 2000, warmup = 1000,
  cores = 2, seed = 1234,
  
  # regularising priors
  prior = c(prior(normal(0, 1), class = Intercept),
            prior(normal(0, 1), class = b),
            prior(exponential(2), class = sdgp)),
  
  # tune the mcmc sampler
  control = list(adapt_delta = 0.99),
  
  backend = "cmdstanr",
  file = "network_model_beta_zi_bts"
)
tidy(network_model_beta_zi_bts, effects = "fixed")

```

```{r}
ame_beta_zi_network_bts <- network_model_beta_zi_bts %>%
  avg_comparisons(variables = "Network_2021") %>% 
  posterior_draws()
ame_beta_zi_network_bts %>% median_hdi(draw)

ggplot(ame_beta_zi_network_bts, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of Internet penetration rate", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
result <- hypothesis(ame_beta_zi_network_bts, "draw>0")
result
result$hypothesis$Estimate
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
result$hypothesis$Est.Error
```

```{r}
network_model_beta_zi_ps2014 <- brm(
 bf(ps| trials(total_ps) ~ Network_2021+ gp(Latitude, Longitude),
   phi ~ Network_2021,
     zi ~ Network_2021),
  data = networkdata,
  family = zero_inflated_beta_binomial(),
  chains = 4, iter = 2000, warmup = 1000,
  cores = 2, seed = 1234,
  
  # regularising priors
  prior = c(prior(normal(0, 1), class = Intercept),
            prior(normal(0, 1), class = b),
            prior(exponential(2), class = sdgp)),
  
  # tune the mcmc sampler
  control = list(adapt_delta = 0.99),
  
  backend = "cmdstanr",
  file = "network_model_beta_zi_ps2014"
)

```

```{r}
tidy(network_model_beta_zi_ps2014, effects = "fixed")
```

```{r}
ame_beta_zi_network_ps2014 <- network_model_beta_zi_ps2014 %>%
  avg_comparisons(variables = "Network_2021") %>% 
  posterior_draws()
ame_beta_zi_network_ps2014 %>% median_hdi(draw)

ggplot(ame_beta_zi_network_ps2014, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of Internet penetration rate", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
result <- hypothesis(ame_beta_zi_network_ps2014, "draw>0")
result
result$hypothesis$Estimate
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
result$hypothesis$Est.Error
```

#互联网普及率画图
```{r}  
# 拟合线性回归模型并计算置信区间
combined_data5 <- rbind(
  transform(networkdata, source = "PS2014", value = ps2014),
  transform(networkdata, source = "PSA001", value = percentage_sample)
)
# Create the plot
Network1 <- ggplot(combined_data5, aes(x = Network_2021, y = value, color = source)) +
  
 geom_point(size = 6, alpha = 0.6) +
  geom_smooth(method ="lm",size = 2) +
  scale_color_brewer(palette = 'Set1') +
 scale_color_manual(name = "Data source", 
                    values = c("#377EB8","#E41A1C"), 
                    labels = c("Traditional studies", "BTS"))+
  
  ylab("Proportion of sample") +
  xlab("Proportion of population using the internet") +
  theme(axis.text = element_text(size = 20),
        axis.title = element_text(size = 24),
        panel.background = element_rect(fill = "white"),
        axis.line = element_line(color = "black"),
        aspect.ratio = 1,
        legend.position = "right",  # 设置图例位置为顶部
        legend.text = element_text(size = 18),  # 设置图例文本字体大小
        legend.title = element_text(size = 20)) +
  xlim(c(0, 1)) +
  ylim(c(-0.18, 1)) +
  guides(color = guide_legend(override.aes = list(linetype = c("solid", "dashed"))))

# Adding the annotations
Network1 <- Network1 +
  annotate("text", x = 0.843, y = 0.955, 
           label = expression("US"), size = 6) +
  annotate("text", x = 0.843, y = 0.235, 
           label = expression("US"), size = 6)

Network1

# Save the plot as a JPEG image
ggsave(filename = "Network.jpg", plot = Network1, device = "jpg", width = 12, height = 12)
```

##Linguistic distance from the United States
#lp1
```{r}
lddata <- read_csv("lddata.csv")
lddata
lddata %>% 
  count(percentage_sample == 0) %>% 
  mutate(prop = n / sum(n))

latitude_longitude_ld <- latitude_longitude %>%
  filter(country_map %in% lddata$country_map)

lddata <- merge(lddata, latitude_longitude_ld, by = "country_map", all = TRUE)
lddata
```


```{r}
ld1_model_beta_zi_bts <- brm(
  bf(bts| trials(total_bts) ~ lp1+ gp(Latitude, Longitude),
   phi ~ lp1,
     zi ~ lp1),
  data = lddata,
  family = zero_inflated_beta_binomial(),
  chains = 4, iter = 2000, warmup = 1000,
  cores = 2, seed = 1234,
  
  # regularising priors
  prior = c(prior(normal(0, 1), class = Intercept),
            prior(normal(0, 1), class = b),
            prior(exponential(2), class = sdgp)),
  
  # tune the mcmc sampler
  control = list(adapt_delta = 0.99),
  
  backend = "cmdstanr",
  file = "ld1_model_beta_zi_bts"
)
tidy(ld1_model_beta_zi_bts, effects = "fixed")

```

```{r}
ame_beta_zi_ld1_bts <- ld1_model_beta_zi_bts %>%
  avg_comparisons(variables = "lp1") %>% 
  posterior_draws()
ame_beta_zi_ld1_bts %>% median_hdi(draw)

ggplot(ame_beta_zi_ld1_bts, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of Linguistic distance", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
result <- hypothesis(ame_beta_zi_ld1_bts, "draw>0")
result
result$hypothesis$Estimate
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
result$hypothesis$Est.Error
```

```{r}
ld1_model_beta_zi_ps2014 <- brm(
  bf(ps| trials(total_ps) ~ lp1+ gp(Latitude, Longitude),
   phi ~ lp1,
     zi ~ lp1),
  data = lddata,
  family = zero_inflated_beta_binomial(),
  chains = 4, iter = 2000, warmup = 1000,
  cores = 2, seed = 1234,
  
  # regularising priors
  prior = c(prior(normal(0, 1), class = Intercept),
            prior(normal(0, 1), class = b),
            prior(exponential(2), class = sdgp)),
  
  # tune the mcmc sampler
  control = list(adapt_delta = 0.99),
  
  backend = "cmdstanr",
  file = "ld1_model_beta_zi_ps2014"
)

```

```{r}
tidy(ld1_model_beta_zi_ps2014, effects = "fixed")
```

```{r}
ame_beta_zi_ld1_ps2014 <- ld1_model_beta_zi_ps2014 %>%
  avg_comparisons(variables = "lp1") %>% 
  posterior_draws()
ame_beta_zi_ld1_ps2014 %>% median_hdi(draw)

ggplot(ame_beta_zi_ld1_ps2014, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of Linguistic distance", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
result <- hypothesis(ame_beta_zi_ld1_ps2014, "draw>0")
result
result$hypothesis$Estimate
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
result$hypothesis$Est.Error
```

#语言距离画图1
```{r}
# 拟合线性回归模型并计算置信区间
combined_data6 <- rbind(
  transform(lddata, source = "PS2014", value = ps2014),
  transform(lddata, source = "PSA001", value = percentage_sample)
)
# Create the plot
ld1 <- ggplot(combined_data6, aes(x = lp1, y = value, color = source)) +
  
 geom_point(size = 6, alpha = 0.6) +
  geom_smooth(method ="lm",size = 2) +
  scale_color_brewer(palette = 'Set1') +
scale_color_manual(name = "Data source", 
                    values = c("#377EB8","#E41A1C"), 
                    labels = c("Traditional studies", "BTS"))+
  ylab("Proportion of sample") +
  xlab("Linguistic distance from United States\n(from English)") +
  theme(axis.text = element_text(size = 20),
        axis.title = element_text(size = 24),
        panel.background = element_rect(fill = "white"),
        axis.line = element_line(color = "black"),
        aspect.ratio = 1,
        legend.position = "right",  # 设置图例位置为顶部
        legend.text = element_text(size = 18),  # 设置图例文本字体大小
        legend.title = element_text(size = 20)) +
  xlim(c(0, 3.5)) +
  ylim(c(-0.25, 1)) +
  guides(color = guide_legend(override.aes = list(linetype = c("solid", "dashed"))))

# Adding the label
ld1 <- ld1 +
  annotate("text", x = 0.30, y = 0.955, 
           label = expression("US"), size = 6) +
  annotate("text", x = 0.30, y = 0.235, 
           label = expression("US"), size = 6)

#翻转X轴
ld1 <- ld1 + scale_x_reverse()
# Print the plot
ld1

# Save the plot as a JPEG image
ggsave(filename = "LD.jpg", plot = ld1, device = "jpg", width = 12, height = 12)
```

##lp2
```{r}
ld2_model_beta_zi_bts <- brm(
  bf(bts| trials(total_bts) ~ lp2+ gp(Latitude, Longitude),
   phi ~ lp2,
     zi ~ lp2),
  data = lddata,
  family = zero_inflated_beta_binomial(),
  chains = 4, iter = 200, warmup = 100,
  cores = 2, seed = 1234,
  
  # regularising priors
  prior = c(prior(normal(0, 1), class = Intercept),
            prior(normal(0, 1), class = b),
            prior(exponential(2), class = sdgp)),
  
  # tune the mcmc sampler
  control = list(adapt_delta = 0.99),
  
  backend = "cmdstanr",
  file = "ld2_model_beta_zi_bts"
)
tidy(ld2_model_beta_zi_bts, effects = "fixed")

```

```{r}
ame_beta_zi_ld2_bts <- 
  emtrends(ld2_model_beta_zi_bts,~lp2,var = "lp2",)%>% 
  gather_emmeans_draws()

ame_beta_zi_ld2_bts
summary(ame_beta_zi_ld2_bts)
ame_beta_zi_ld2_bts %>% median_qi()
ame_beta_zi_ld2_bts %>% mean_qi()
ame_beta_zi_ld2_bts %>%mode_hdi()
```


  emmeans(~ condition) %>%
  gather_emmeans_draws() %>%

```{r}
ame_beta_zi_ld2_bts <- ld2_model_beta_zi_bts %>%
  avg_comparisons(variables = "lp2") %>% 
  posterior_draws()
ame_beta_zi_ld2_bts %>% median_hdi(draw)
ame_beta_zi_ld2_bts
ggplot(ame_beta_zi_ld2_bts, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of Linguistic distance", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
ame_beta_zi_ld2_bts <- na.omit(ame_beta_zi_ld2_bts)

result <- hypothesis(ame_beta_zi_ld2_bts, ".value< 0")

result
result$hypothesis$Estimate
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
result$hypothesis$Est.Error
```

```{r}
ld2_model_beta_zi_ps2014 <- brm(
  bf(ps| trials(total_ps) ~ lp2+ gp(Latitude, Longitude),
   phi ~ lp2,
     zi ~ lp2),
  data = lddata,
  family = zero_inflated_beta_binomial(),
  chains = 4, iter = 40, warmup = 20,
  cores = 4, seed = 1234,
  
  # regularising priors
  prior = c(prior(normal(0, 1), class = Intercept),
            prior(normal(0, 1), class = b),
            prior(exponential(2), class = sdgp)),
  
  # tune the mcmc sampler
 control = list(adapt_delta = 0.99),
  
  backend = "cmdstanr",
  file = "ld2_model_beta_zi_ps2014"
)
tidy(ld2_model_beta_zi_ps2014, effects = "fixed")
```

```{r}
ame_beta_zi_ld2_ps2014 <- 
  emmeans(ld2_model_beta_zi_ps2014,~ lp2,epred = TRUE,
          re_formula = NULL) %>% 
  gather_emmeans_draws()
ame_beta_zi_ld2_ps2014
ame_beta_zi_ld2_ps2014 %>% median_hdi()
```

```{r}
ame_beta_zi_ld2_ps2014 <- ld2_model_beta_zi_ps2014 %>%
  avg_comparisons(variables = "lp2") %>% 
  posterior_draws()
ame_beta_zi_ld2_ps2014 %>% median_hdi(draw)

ggplot(ame_beta_zi_ld2_ps2014, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of Linguistic distance", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
result <- hypothesis(ame_beta_zi_ld2_ps2014, "draw>0")
result
result$hypothesis$Estimate
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
result$hypothesis$Est.Error
```


##englishdata
```{r}
englishdata <- read_csv("englishdata.csv")
englishdata
englishdata %>% 
  count(percentage_sample == 0) %>% 
  mutate(prop = n / sum(n))

latitude_longitude_english <- latitude_longitude %>%
  filter(country_map %in% englishdata$country_map)

englishdata <- merge(englishdata, latitude_longitude_english, by = "country_map", all = TRUE)
englishdata
```


```{r}
english_model_beta_zi_bts <- brm(
  bf(bts| trials(total_bts) ~ EPI_rank+ gp(Latitude, Longitude),
   phi ~ EPI_rank,
     zi ~ EPI_rank),
  data = englishdata,
  family = zero_inflated_beta_binomial(),

  chains = 4, iter = 2000, warmup = 1000,
  cores = 2, seed = 1234,
  
  # regularising priors
  prior = c(prior(normal(0, 1), class = Intercept),
            prior(normal(0, 1), class = b),
            prior(exponential(2), class = sdgp)),
  
  # tune the mcmc sampler
  control = list(adapt_delta = 0.99),
  
  backend = "cmdstanr",
  file = "english_model_beta_zi_bts"
)
tidy(english_model_beta_zi_bts, effects = "fixed")

```

```{r}
ame_beta_zi_english_bts <- english_model_beta_zi_bts %>%
  avg_comparisons(variables = "EPI_rank") %>% 
  posterior_draws()
ame_beta_zi_english_bts %>% median_hdi(draw)

ggplot(ame_beta_zi_english_bts, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of English proficiency rank", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
result <- hypothesis(ame_beta_zi_english_bts, "draw>0")
result
result$hypothesis$Estimate
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
result$hypothesis$Est.Error
```

```{r}
english_model_beta_zi_ps2014 <- brm(
  bf(ps| trials(total_ps) ~ EPI_rank+ gp(Latitude, Longitude),
   phi ~ EPI_rank,
     zi ~ EPI_rank),
  data = englishdata,
  family = zero_inflated_beta_binomial(),
  chains = 4, iter = 2000, warmup = 1000,
  cores = 2, seed = 1234,
  
  # regularising priors
  prior = c(prior(normal(0, 1), class = Intercept),
            prior(normal(0, 1), class = b),
            prior(exponential(2), class = sdgp)),
  
  # tune the mcmc sampler
  control = list(adapt_delta = 0.99),
  
  backend = "cmdstanr",
  file = "english_model_beta_zi_ps2014"
)

```

```{r}
tidy(english_model_beta_zi_ps2014, effects = "fixed")
```

```{r}
ame_beta_zi_english_ps2014 <- english_model_beta_zi_ps2014 %>%
  avg_comparisons(variables = "EPI_rank") %>% 
  posterior_draws()
ame_beta_zi_english_ps2014 %>% median_hdi(draw)

ggplot(ame_beta_zi_english_ps2014, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of English proficiency rank", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
result <- hypothesis(ame_beta_zi_english_ps2014, "draw>0")
result
result$hypothesis$Estimate
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
result$hypothesis$Est.Error
```

#英语熟练度画图
```{r}  
# 拟合线性回归模型并计算置信区间
combined_data7 <- rbind(
  transform(englishdata, source = "PS2014", value = ps2014),
  transform(englishdata, source = "PSA001", value = percentage_sample)
)
# Create the plot
EPI1 <- ggplot(combined_data7, aes(x = EPI_rank, y = value, color = source)) +
  
 geom_point(size = 6, alpha = 0.6) +
  geom_smooth(method ="lm",size = 2) +
  scale_color_brewer(palette = 'Set1') +
 scale_color_manual(name = "Data source", 
                    values = c("#377EB8","#E41A1C"), 
                    labels = c("Traditional studies", "BTS"))+
    
  ylab("Proportion of sample") +
  xlab("English Proficiency Index") +
  theme(axis.text = element_text(size = 20),
        axis.title = element_text(size = 24),
        panel.background = element_rect(fill = "white"),
        axis.line = element_line(color = "black"),
        aspect.ratio = 1,
        legend.position = "right",  # 设置图例位置为顶部
        legend.text = element_text(size = 18),  # 设置图例文本字体大小
        legend.title = element_text(size = 20)) +
  xlim(c(0, 120)) +
  ylim(c(-0.25, 1)) +
  guides(color = guide_legend(override.aes = list(linetype = c("solid", "dashed"))))

# Adding the annotations
EPI1 <- EPI1 +
  annotate("text", x = 11.5, y = 0.955, 
           label = expression("US"), size = 6) +
  annotate("text", x = 11.5, y = 0.235, 
           label = expression("US"), size = 6)

#翻转X轴
EPI1 <- EPI1 + scale_x_reverse()
# Print the plot
EPI1

# Save the plot as a JPEG image
ggsave(filename = "EPI.jpg", plot = EPI1, device = "jpg", width = 12, height = 12)
```

```{r}  
# 将11个图形横向左右排列
combined_plot1 <-  gdp1+ RD1+university+  researcher+education1+UP1+GI1+ Network1 + pd1+ld1+EPI1 + 
  plot_layout(ncol = 2) + # 设置两列布局
plot_annotation(tag_levels ="A",
                  theme = theme(plot.title = element_text(size = 26)))

# Save the plot as a JPEG image
ggsave(filename = "Exploratory_analyses.pdf", plot = combined_plot1, device = "pdf", width = 18, height = 30)
```


##KE_urbanization
```{r}
KE_urbanization <- read_csv("KE_urbanization.csv")
KE_urbanization
```

```{r}
KE_urbanization %>% 
  count(Ruggeri_KE == 0) %>% 
  mutate(prop = n / sum(n))
```

```{r}
KE_urbanization_model_beta_zi <- brm(
  bf(Ruggeri_KE ~ KE_UP_2020,
     phi ~ KE_UP_2020,
     zi ~ KE_UP_2020),
  data = KE_urbanization,
  family = zero_inflated_beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores = 2, seed = 1234,
  backend = "cmdstanr",
  file = "KE_urbanization_model_beta_zi "
)
tidy(KE_urbanization_model_beta_zi, effects = "fixed")

```


```{r}
ame_beta_zi_KE_urbanization <- KE_urbanization_model_beta_zi %>%
  avg_comparisons(variables = "KE_UP_2020") %>% 
  posterior_draws()
ame_beta_zi_KE_urbanization %>% median_hdi(draw)

ggplot(ame_beta_zi_KE_urbanization, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of KE_urbanization", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
result <- hypothesis(ame_beta_zi_KE_urbanization, "draw>0")
result
result$hypothesis$Estimate
result$hypothesis$Est.Error
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
```

```{r}
model_ols1 <- lm(Ruggeri_KE ~ KE_UP_2020,
                 data = KE_urbanization)
summary(model_ols1)
```


##CN_urbanization
```{r}
CN_urbanization <- read_csv("CN_urbanization.csv")
CN_urbanization
```

```{r}
CN_urbanization %>% 
  count(Ruggeri_CN == 0) %>% 
  mutate(prop = n / sum(n))
```

```{r}
CN_urbanization_model_beta_zi <- brm(
  bf(Ruggeri_CN ~ CN_UP_2020,
     phi ~ CN_UP_2020,
     zi ~ CN_UP_2020),
  data = CN_urbanization,
  family = zero_inflated_beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores = 2, seed = 1234,
  backend = "cmdstanr",
  file = "CN_urbanization_model_beta_zi "
)
tidy(CN_urbanization_model_beta_zi, effects = "fixed")

```


```{r}
ame_beta_zi_CN_urbanization <- CN_urbanization_model_beta_zi %>%
  avg_comparisons(variables = "CN_UP_2020") %>% 
  posterior_draws()
ame_beta_zi_CN_urbanization %>% median_hdi(draw)

ggplot(ame_beta_zi_CN_urbanization, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of CN_urbanization", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
result <- hypothesis(ame_beta_zi_CN_urbanization, "draw>0")
result
result$hypothesis$Estimate
result$hypothesis$Est.Error
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
```

```{r}
model_ols1 <- lm(Ruggeri_CN ~ CN_UP_2020,
                 data = CN_urbanization)
summary(model_ols1)
```


##US_urbanization
```{r}
US_urbanization <- read_csv("US_urbanization.csv")
US_urbanization
```

```{r}
US_urbanization %>% 
  count(Ruggeri_US == 0) %>% 
  mutate(prop = n / sum(n))
```

```{r}
#过度离散的O检验
variance <- var(US_urbanization$Ruggeri_US_size)
mean <- mean(US_urbanization$Ruggeri_US_size)
sum <- sum(US_urbanization$Ruggeri_US_size)
variance
mean 
sum
O <- sqrt(sum-1)*2*(variance-mean)/mean
O
```


```{r}
US_urbanization_model_beta_zi <- brm(
  bf(Ruggeri_US_size| trials(size) ~ US_UP_2020,
   phi ~ US_UP_2020,
     zi ~ US_UP_2020),
  data = US_urbanization,
  family = zero_inflated_beta_binomial(),
  chains = 4, iter = 2000, warmup = 1000,
  cores = 4, seed = 1234,
  backend = "cmdstanr",
  file = "US_urbanization_model_beta_zi "
)
tidy(US_urbanization_model_beta_zi, effects = "fixed")

```


```{r}
ame_beta_zi_US_urbanization <- US_urbanization_model_beta_zi %>%
  avg_comparisons(variables = "US_UP_2020") %>% 
  posterior_draws()
ame_beta_zi_US_urbanization %>% median_hdi(draw)

ggplot(ame_beta_zi_US_urbanization, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of US_urbanization", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
result <- hypothesis(ame_beta_zi_US_urbanization, "draw>0")
result
result$hypothesis$Estimate
result$hypothesis$Est.Error
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
```

```{r}
model_ols1 <- lm(Ruggeri_US ~ US_UP_2020,
                 data = US_urbanization)
summary(model_ols1)
```


##CN_internet
```{r}
CN_internet <- read_csv("CN_internet.csv")
CN_internet
```

```{r}
CN_internet %>% 
  count(Ruggeri_CN == 0) %>% 
  mutate(prop = n / sum(n))

```

```{r}
CN_internet_model_beta_zi <- brm(
  bf(Ruggeri_CN ~ Internet_CN_2016,
     phi ~ Internet_CN_2016,
     zi ~ Internet_CN_2016),
  data = CN_internet,
  family = zero_inflated_beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores = 2, seed = 1234,
  
  backend = "cmdstanr",
  file = "CN_internet_model_beta_zi "
)
tidy(CN_internet_model_beta_zi, effects = "fixed")

```


```{r}
ame_beta_zi_CN_internet <- CN_internet_model_beta_zi %>%
  avg_comparisons(variables = "Internet_CN_2016") %>% 
  posterior_draws()
ame_beta_zi_CN_internet %>% median_hdi(draw)

ggplot(ame_beta_zi_CN_internet, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of CN_internet", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
result <- hypothesis(ame_beta_zi_CN_internet, "draw>0")
result
result$hypothesis$Estimate
result$hypothesis$Est.Error
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio

```

```{r}
model_ols1 <- lm(Ruggeri_CN ~ Internet_CN_2016,
                 data = CN_internet)
summary(model_ols1)
```

##NG_internet
```{r}
NG_internet <- read_csv("NG_internet.csv")
NG_internet
```

```{r}
NG_internet %>% 
  count(Ruggeri_NG == 0) %>% 
  mutate(prop = n / sum(n))
```
```{r}
NG_internet_model_beta_zi <- brm(
  bf(Ruggeri_NG ~ Internet_NG_2022,
     phi ~ Internet_NG_2022,
     zi ~ Internet_NG_2022),
  data = NG_internet,
  family = zero_inflated_beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores = 2, seed = 1234,
  backend = "cmdstanr",
  file = "NG_internet_model_beta_zi "
)
tidy(NG_internet_model_beta_zi, effects = "fixed")

```


```{r}
ame_beta_zi_NG_internet <- NG_internet_model_beta_zi %>%
  avg_comparisons(variables = "Internet_NG_2022") %>% 
  posterior_draws()
ame_beta_zi_NG_internet %>% median_hdi(draw)

ggplot(ame_beta_zi_NG_internet, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of NG_internet", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
result <- hypothesis(ame_beta_zi_NG_internet, "draw<0")
result
result$hypothesis$Estimate
result$hypothesis$Est.Error
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
```

```{r}
model_ols1 <- lm(Ruggeri_NG ~ Internet_NG_2022,
                 data = NG_internet)
summary(model_ols1)
```


##US_internet
```{r}
US_internet <- read_csv("US_internet.csv")
US_internet
```

```{r}
US_internet %>% 
  count(Ruggeri_US == 0) %>% 
  mutate(prop = n / sum(n))
```
```{r}
US_internet_model_beta_zi <- brm(
  bf(Ruggeri_US ~ Internet_US_2018,
     phi ~ Internet_US_2018,
     zi ~ Internet_US_2018),
  data = US_internet,
  family = zero_inflated_beta(),
  chains = 4, iter = 200000, warmup = 100000,
  cores = 2, seed = 1234,
  backend = "cmdstanr",
  file = "US_internet_model_beta_zi "
)
tidy(US_internet_model_beta_zi, effects = "fixed")

```


```{r}
ame_beta_zi_US_internet <- US_internet_model_beta_zi %>%
  avg_comparisons(variables = "Internet_US_2018") %>% 
  posterior_draws()
ame_beta_zi_US_internet
ame_beta_zi_US_internet %>% median_hdi(draw)

ggplot(ame_beta_zi_US_internet, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of US_internet", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
ame_beta_zi_US_internet %>% mean_hdi(draw)
result <- hypothesis(ame_beta_zi_US_internet, "draw>0")
result
result$hypothesis$Estimate
result$hypothesis$Est.Error
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
```

```{r}
model_ols1 <- lm(Ruggeri_US ~ Internet_US_2018,
                 data = US_internet)
summary(model_ols1)
```

##NG_EPI
```{r}
NG_EPI <- read_csv("NG_EPI.csv")
NG_EPI
```

```{r}
NG_EPI %>% 
  count(Ruggeri_NG == 0) %>% 
  mutate(prop = n / sum(n))
```
```{r}
NG_EPI_model_beta_zi <- brm(
  bf(Ruggeri_NG ~ EPI_NG_2022,
     phi ~ EPI_NG_2022,
     zi ~ EPI_NG_2022),
  data = NG_EPI,
  family = zero_inflated_beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores = 2, seed = 1234,
  backend = "cmdstanr",
  file = "NG_EPI_model_beta_zi "
)
tidy(NG_EPI_model_beta_zi, effects = "fixed")

```


```{r}
ame_beta_zi_NG_EPI <- NG_EPI_model_beta_zi %>%
  avg_comparisons(variables = "EPI_NG_2022") %>% 
  posterior_draws()
ame_beta_zi_NG_EPI %>% median_hdi(draw)

ggplot(ame_beta_zi_NG_EPI, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of NG_EPI", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
result <- hypothesis(ame_beta_zi_NG_EPI, "draw<0")
result
result$hypothesis$Estimate
result$hypothesis$Est.Error
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
```

```{r}
model_ols1 <- lm(Ruggeri_NG ~ EPI_NG_2022,
                 data = NG_EPI)
summary(model_ols1)
```



##CN_EPI
```{r}
CN_EPI <- read_csv("CN_EPI.csv")
CN_EPI
```

```{r}
CN_EPI %>% 
  count(Ruggeri_CN == 0) %>% 
  mutate(prop = n / sum(n))
```

```{r}
CN_EPI_model_beta_zi <- brm(
  bf(Ruggeri_CN ~ EPI_CN_2022,
     phi ~ EPI_CN_2022,
     zi ~ EPI_CN_2022),
  data = CN_EPI,
  family = zero_inflated_beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores = 2, seed = 1234,
  backend = "cmdstanr",
  file = "CN_EPI_model_beta_zi"
)
tidy(CN_EPI_model_beta_zi, effects = "fixed")

```


```{r}
ame_beta_zi_CN_EPI <- CN_EPI_model_beta_zi %>%
  avg_comparisons(variables = "EPI_CN_2022") %>% 
  posterior_draws()
ame_beta_zi_CN_EPI %>% median_hdi(draw)

ggplot(ame_beta_zi_CN_EPI, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of CN_EPI", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
result <- hypothesis(ame_beta_zi_CN_EPI, "draw<0")
result
result$hypothesis$Estimate
result$hypothesis$Est.Error
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
```

```{r}
model_ols1 <- lm(Ruggeri_CN ~ EPI_CN_2022,
                 data = CN_EPI)
summary(model_ols1)
```


##NL_EPI
```{r}
NL_EPI <- read_csv("NL_EPI.csv")
NL_EPI
```

```{r}
NL_EPI %>% 
  count(Ruggeri_NL == 0) %>% 
  mutate(prop = n / sum(n))
```

```{r}
NL_EPI_model_beta_zi <- brm(
  bf(Ruggeri_NL ~ EPI_NL_2022,
     phi ~ EPI_NL_2022,
     zi ~ EPI_NL_2022),
  data = NL_EPI,
  family = zero_inflated_beta(),
  chains = 4, iter = 2000, warmup = 1000,
  cores = 2, seed = 1234,
  backend = "cmdstanr",
  file = "NL_EPI_model_beta_zi "
)
tidy(NL_EPI_model_beta_zi, effects = "fixed")

```


```{r}
ame_beta_zi_NL_EPI <- NL_EPI_model_beta_zi %>%
  avg_comparisons(variables = "EPI_NL_2022") %>% 
  posterior_draws()
ame_beta_zi_NL_EPI %>% median_hdi(draw)

ggplot(ame_beta_zi_NL_EPI, aes(x = draw)) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               fill = "#bc3032") +
  scale_x_continuous(labels = label_pp) +
  labs(x = "Average marginal effect of NL_EPI", y = NULL,
       caption = "80% and 95% credible intervals shown in black") +
  theme_clean()
```

```{r}
result <- hypothesis(ame_beta_zi_NL_EPI, "draw>0")
result
result$hypothesis$Estimate
result$hypothesis$Est.Error
result$hypothesis$CI.Lower
result$hypothesis$CI.Upper
result$hypothesis$Evid.Ratio
```

```{r}
model_ols1 <- lm(Ruggeri_NL ~ EPI_NL_2022,
                 data = NL_EPI)
summary(model_ols1)
```


###尼日利亚、中国、美国的互联网普及率按省份画图
##尼日利亚按省份画图(互联网普及率)
```{r}  
# 拟合线性回归模型并计算置信区间
model <- lm(Ruggeri_NG ~ Internet_NG_2022, data = NG_internet)
predict_data_NG <- data.frame(Internet_NG_2022 = NG_internet$Internet_NG_2022, Ruggeri_NG = NG_internet$Ruggeri_NG )
predict_data_NG$predicted <- predict(model, newdata = predict_data_NG)
predict_data_NG$lower <- predict(model, newdata = NG_internet, interval = "confidence")[, "lwr"]
predict_data_NG$upper <- predict(model, newdata = NG_internet, interval = "confidence")[, "upr"]

# 绘制散点图和回归线
NG_IPR <- ggplot(data = NG_internet, aes(y = Ruggeri_NG, x = Internet_NG_2022, color = "#E41A1C")) +
  geom_point(stat = "identity", position = "identity", size = 6) +
  geom_line(data = predict_data_NG, aes(y = predicted), color = "#E41A1C", size = 2) +
  geom_ribbon(data = predict_data_NG, aes(ymin = lower, ymax = upper), fill = "black", alpha = 0.3, linetype = "blank") +
  ylab("Proportion of sample in BTS") +
  xlab("Proportion of active Internet\nby state in Nigeria") +
  theme(axis.text = element_text(size = 20),
        axis.title = element_text(size = 24),
        panel.background = element_rect(fill = "white"),
        axis.line = element_line(color = "black"),
        aspect.ratio = 1) +
  xlim(c(0, 3)) +
  ylim(c(-0.18, 0.7)) +
  guides(color = FALSE)

NG_IPR
# Save the plot as a JPEG image
ggsave(filename = "NG_IPR.jpg", plot = NG_IPR, device = "jpg", width = 12, height = 12)
```


##中国按省份画图(互联网普及率)
```{r}  
# 拟合线性回归模型并计算置信区间
model <- lm(Ruggeri_CN ~ Internet_CN_2016, data = CN_internet)
predict_data_CN <- data.frame(Internet_CN_2016= CN_internet$Internet_CN_2016, Ruggeri_CN = CN_internet$Ruggeri_CN )
predict_data_CN$predicted <- predict(model, newdata = predict_data_CN)
predict_data_CN$lower <- predict(model, newdata = CN_internet, interval = "confidence")[, "lwr"]
predict_data_CN$upper <- predict(model, newdata = CN_internet, interval = "confidence")[, "upr"]

# 绘制散点图和回归线
CN_IPR <- ggplot(data = CN_internet, aes(y = Ruggeri_CN, x = Internet_CN_2016, color = "#E41A1C")) +
  geom_point(stat = "identity", position = "identity", size = 6) +
  geom_line(data = predict_data_CN, aes(y = predicted), color = "#E41A1C", size = 2) +
  geom_ribbon(data = predict_data_CN, aes(ymin = lower, ymax = upper), fill = "black", alpha = 0.3, linetype = "blank") +
  ylab("Proportion of sample in BTS") +
  xlab("Proportion of population using the internet\nby province in china") +
  theme(axis.text = element_text(size = 20),
        axis.title = element_text(size = 24),
        panel.background = element_rect(fill = "white"),
        axis.line = element_line(color = "black"),
        aspect.ratio = 1) +
  xlim(c(0.38, 1)) +
  ylim(c(-0.03, 0.3)) +
  guides(color = FALSE)

CN_IPR
# Save the plot as a JPEG image
ggsave(filename = "CN_IPR.jpg", plot = CN_IPR, device = "jpg", width = 12, height = 12)
```

##美国按省份画图(互联网普及率)
```{r}  
# 拟合线性回归模型并计算置信区间
model <- lm(Ruggeri_US ~ Internet_US_2018, data = US_internet)
predict_data_US <- data.frame(Internet_US_2018= US_internet$Internet_US_2018, Ruggeri_US = US_internet$Ruggeri_US )
predict_data_US$predicted <- predict(model, newdata = predict_data_US)
predict_data_US$lower <- predict(model, newdata = US_internet, interval = "confidence")[, "lwr"]
predict_data_US$upper <- predict(model, newdata = US_internet, interval = "confidence")[, "upr"]

# 绘制散点图和回归线
US_IPR <- ggplot(data = US_internet, aes(y = Ruggeri_US, x = Internet_US_2018, color = "#E41A1C")) +
  geom_point(stat = "identity", position = "identity", size = 6) +
  geom_line(data = predict_data_US, aes(y = predicted), color = "#E41A1C", size = 2) +
  geom_ribbon(data = predict_data_US, aes(ymin = lower, ymax = upper), fill = "black", alpha = 0.3, linetype = "blank") +
  ylab("Proportion of sample in BTS") +
  xlab("Proportion of population using the internet\nby state in United States") +
  theme(axis.text = element_text(size = 20),
        axis.title = element_text(size = 24),
        panel.background = element_rect(fill = "white"),
        axis.line = element_line(color = "black"),
        aspect.ratio = 1) +
  xlim(c(0.38, 1)) +
  ylim(c(-0.03, 0.2)) +
  guides(color = FALSE)

US_IPR
# Save the plot as a JPEG image
ggsave(filename = "US_IPR.jpg", plot = US_IPR, device = "jpg", width = 12, height = 12)
```


###尼日利亚、中国、荷兰的英语熟练度按省份画图
##尼日利亚按省份画图(英语熟练度)
```{r}  
# 拟合线性回归模型并计算置信区间
model <- lm(Ruggeri_NG ~ EPI_NG_2022, data = NG_EPI)
predict_data_NG <- data.frame(EPI_NG_2022 = NG_EPI$EPI_NG_2022, Ruggeri_NG = NG_EPI$Ruggeri_NG )
predict_data_NG$predicted <- predict(model, newdata = predict_data_NG)
predict_data_NG$lower <- predict(model, newdata = NG_EPI, interval = "confidence")[, "lwr"]
predict_data_NG$upper <- predict(model, newdata = NG_EPI, interval = "confidence")[, "upr"]

# 绘制散点图和回归线
NG_EPI <- ggplot(data = NG_EPI, aes(y = Ruggeri_NG, x = EPI_NG_2022, color = "#E41A1C")) +
  geom_point(stat = "identity", position = "identity", size = 6) +
  geom_line(data = predict_data_NG, aes(y = predicted), color = "#E41A1C", size = 2) +
  geom_ribbon(data = predict_data_NG, aes(ymin = lower, ymax = upper), fill = "black", alpha = 0.3, linetype = "blank") +
  ylab("Proportion of sample in BTS") +
  xlab("English Proficiency of Nigeria by state") +
  theme(axis.text = element_text(size = 20),
        axis.title = element_text(size = 24),
        panel.background = element_rect(fill = "white"),
        axis.line = element_line(color = "black"),
        aspect.ratio = 1) +
  xlim(c(470, 670)) +
  ylim(c(-0.13, 0.67)) +
  guides(color = FALSE)
#翻转X轴
NG_EPI <- NG_EPI + scale_x_reverse()

NG_EPI 
# Save the plot as a JPEG image
ggsave(filename = " NG_EPI.jpg", plot = NG_EPI, device = "jpg", width = 12, height = 12)
```


##中国按省份画图（英语熟练度）
```{r}  
# 拟合线性回归模型并计算置信区间
model <- lm(Ruggeri_CN ~ EPI_CN_2022, data = CN_EPI)
predict_data_CN <- data.frame(EPI_CN_2022 = CN_EPI$EPI_CN_2022, Ruggeri_CN = CN_EPI$Ruggeri_CN )
predict_data_CN$predicted <- predict(model, newdata = predict_data_CN)
predict_data_CN$lower <- predict(model, newdata = CN_EPI, interval = "confidence")[, "lwr"]
predict_data_CN$upper <- predict(model, newdata = CN_EPI, interval = "confidence")[, "upr"]

# 绘制散点图和回归线
CN_EPI <- ggplot(data = CN_EPI, aes(y = Ruggeri_CN, x = EPI_CN_2022, color = "#E41A1C")) +
  geom_point(stat = "identity", position = "identity", size = 6) +
  geom_line(data = predict_data_CN, aes(y = predicted), color = "#E41A1C", size = 2) +
  geom_ribbon(data = predict_data_CN, aes(ymin = lower, ymax = upper), fill = "black", alpha = 0.3, linetype = "blank") +
  ylab("Proportion of sample in BTS") +
  xlab("English Proficiency of China by province") +
  theme(axis.text = element_text(size = 20),
        axis.title = element_text(size = 24),
        panel.background = element_rect(fill = "white"),
        axis.line = element_line(color = "black"),
        aspect.ratio = 1) +
  xlim(c(0, 32)) +
  ylim(c(-0.13, 0.67)) +
  guides(color = FALSE)

#翻转X轴
CN_EPI <- CN_EPI + scale_x_reverse()

CN_EPI 
# Save the plot as a JPEG image
ggsave(filename = " CN_EPI.jpg", plot = CN_EPI, device = "jpg", width = 12, height = 12)
```

##荷兰按省画图（英语熟练度）
```{r}  
# 拟合线性回归模型并计算置信区间
model <- lm(Ruggeri_NL ~ EPI_NL_2022, data = NL_EPI)
predict_data_NL <- data.frame(EPI_NL_2022 = NL_EPI$EPI_NL_2022, Ruggeri_NL = NL_EPI$Ruggeri_NL )
predict_data_NL$predicted <- predict(model, newdata = predict_data_NL)
predict_data_NL$lower <- predict(model, newdata = NL_EPI, interval = "confidence")[, "lwr"]
predict_data_NL$upper <- predict(model, newdata = NL_EPI, interval = "confidence")[, "upr"]

# 绘制散点图和回归线
NL_EPI <- ggplot(data = NL_EPI, aes(y = Ruggeri_NL, x = EPI_NL_2022, color = "#E41A1C")) +
  geom_point(stat = "identity", position = "identity", size = 6) +
  geom_line(data = predict_data_NL, aes(y = predicted), color = "#E41A1C", size = 2) +
  geom_ribbon(data = predict_data_NL, aes(ymin = lower, ymax = upper), fill = "black", alpha = 0.3, linetype = "blank") +
  ylab("Proportion of sample in BTS") +
  xlab("English Proficiency of Netherlands by state") +
  theme(axis.text = element_text(size = 20),
        axis.title = element_text(size = 24),
        panel.background = element_rect(fill = "white"),
        axis.line = element_line(color = "black"),
        aspect.ratio = 1) +
  xlim(c(0, 32)) +
  ylim(c(-0.18, 0.67)) +
  guides(color = FALSE)
#翻转X轴
NL_EPI <- NL_EPI + scale_x_reverse()

NL_EPI 
# Save the plot as a JPEG image
ggsave(filename = " NL_EPI.jpg", plot = NL_EPI, device = "jpg", width = 12, height = 12)
```

###尼日利亚、中国、美国的城市化按省份画图
##尼日利亚按省份画图(城市化)
```{r}  
# 拟合线性回归模型并计算置信区间
model <- lm(Ruggeri_KE ~ KE_UP_2020, data = KE_urbanization)
predict_data_KE <- data.frame(KE_UP_2020 = KE_urbanization$KE_UP_2020, Ruggeri_KE = KE_urbanization$Ruggeri_KE )
predict_data_KE$predicted <- predict(model, newdata = predict_data_KE)
predict_data_KE$lower <- predict(model, newdata = KE_urbanization, interval = "confidence")[, "lwr"]
predict_data_KE$upper <- predict(model, newdata = KE_urbanization, interval = "confidence")[, "upr"]

# 绘制散点图和回归线
KE_UP <- ggplot(data = KE_urbanization, aes(y = Ruggeri_KE, x = KE_UP_2020, color = "#E41A1C")) +
  geom_point(stat = "identity", position = "identity", size = 6) +
  geom_line(data = predict_data_KE, aes(y = predicted), color = "#E41A1C", size = 2) +
  geom_ribbon(data = predict_data_KE, aes(ymin = lower, ymax = upper), fill = "black", alpha = 0.3, linetype = "blank") +
  ylab("Proportion of sample in BTS") +
  xlab("Proportion of urban population\nby province in Kenya") +
  theme(axis.text = element_text(size = 20),
        axis.title = element_text(size = 24),
        panel.background = element_rect(fill = "white"),
        axis.line = element_line(color = "black"),
        aspect.ratio = 1) +
  xlim(c(0, 1)) +
  ylim(c(-0.23, 0.9)) +
  guides(color = FALSE)

KE_UP 
# Save the plot as a pdf image
ggsave(filename = " KE_UP.pdf", plot = KE_UP, device = "jpg", width = 12, height = 12)
```


##中国按省份画图(城市化)
```{r}  
# 拟合线性回归模型并计算置信区间
model <- lm(Ruggeri_CN ~ CN_UP_2020, data = CN_urbanization)
predict_data_CN <- data.frame(CN_UP_2020= CN_urbanization$CN_UP_2020, Ruggeri_CN = CN_urbanization$Ruggeri_CN )
predict_data_CN$predicted <- predict(model, newdata = predict_data_CN)
predict_data_CN$lower <- predict(model, newdata = CN_urbanization, interval = "confidence")[, "lwr"]
predict_data_CN$upper <- predict(model, newdata = CN_urbanization, interval = "confidence")[, "upr"]

# 绘制散点图和回归线
CN_UP <- ggplot(data = CN_urbanization, aes(y = Ruggeri_CN, x = CN_UP_2020, color = "#E41A1C")) +
  geom_point(stat = "identity", position = "identity", size = 6) +
  geom_line(data = predict_data_CN, aes(y = predicted), color = "#E41A1C", size = 2) +
  geom_ribbon(data = predict_data_CN, aes(ymin = lower, ymax = upper), fill = "black", alpha = 0.3, linetype = "blank") +
  ylab("Proportion of sample in BTS") +
  xlab("Proportion of urban population\nby province in China") +
  theme(axis.text = element_text(size = 20),
        axis.title = element_text(size = 24),
        panel.background = element_rect(fill = "white"),
        axis.line = element_line(color = "black"),
        aspect.ratio = 1) +
  xlim(c(0, 1)) +
  ylim(c(-0.03, 0.2)) +
  guides(color = FALSE)

CN_UP 
# Save the plot as a pdf image
ggsave(filename = "CN_UP.jpg", plot = CN_UP, device = "pdf", width = 12, height = 12)
```

##美国按省份画图(城市化)

```{r}  
# 拟合线性回归模型并计算置信区间
model <- lm(Ruggeri_US ~ US_UP_2020, data = US_urbanization)
predict_data_US <- data.frame(US_UP_2020= US_urbanization$US_UP_2020, Ruggeri_US = US_urbanization$Ruggeri_US )
predict_data_US$predicted <- predict(model, newdata = predict_data_US)
predict_data_US$lower <- predict(model, newdata = US_urbanization, interval = "confidence")[, "lwr"]
predict_data_US$upper <- predict(model, newdata = US_urbanization, interval = "confidence")[, "upr"]

# 绘制散点图和回归线
US_UP <- ggplot(data = US_urbanization, aes(y = Ruggeri_US, x = US_UP_2020, color = "#E41A1C")) +
  geom_point(stat = "identity", position = "identity", size = 6) +
  geom_line(data = predict_data_US, aes(y = predicted), color = "#E41A1C", size = 2) +
  geom_ribbon(data = predict_data_US, aes(ymin = lower, ymax = upper), fill = "black", alpha = 0.3, linetype = "blank") +
  ylab("Proportion of sample in BTS") +
  xlab("Proportion of urban population\nby state in United States") +
  theme(axis.text = element_text(size = 20),
        axis.title = element_text(size = 24),
        panel.background = element_rect(fill = "white"),
        axis.line = element_line(color = "black"),
        aspect.ratio = 1) +
  xlim(c(0, 1)) +
  ylim(c(-0.036, 0.2)) +
  guides(color = FALSE)

US_UP 
# Save the plot as a pdf image
ggsave(filename = " US_UP.jpg", plot = US_UP, device = "pdf", width = 12, height = 12)
```


```{r}  
# 将两个图形横向左右排列
combined_plot2 <- KE_UP + CN_UP + US_UP + NG_IPR + CN_IPR + US_IPR + NG_EPI + CN_EPI + NL_EPI+
  plot_layout(ncol = 3) + # 设置两列布局
plot_annotation(tag_levels ="A",
                  theme = theme(plot.title = element_text(size = 26)))

combined_plot2
# Save the plot as a pdf image
ggsave(filename = "Exploratory_analyses_by_state.pdf", plot = combined_plot2, device = "pdf", width = 24, height = 24)
```




## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
